KISSY.Editor.add("multi-upload/dialog/support",function(){function y(a){this.editor=a;this.progressBars={};l.Utils.lazyRun(this,"_prepareShow","_realShow")}function z(a,c){var b=a.parentNode,d=c.nextSibling;b.insertBefore(c,a.nextSibling);b.insertBefore(a,d)}var m=KISSY,l=m.Editor,w=m.UA;l.namespace("MultiUpload");var n=m.DOM,x=m.JSON,k=m.Node,F=l.Dialog,G=l.Utils.debugUrl("uploader/uploader.longzang.swf");n.addStyleSheet(".ke-upload-btn-wrap {position:relative;padding:15px 20px 15px 10px;zoom:1;}.ke-upload-list {width:100%;}.ke-upload-list th {border-top:1px solid #c1c8d1;background-color: #E7E9ED;background: -webkit-gradient(linear, left top, left bottom, from(#E7E9ED), to(#F1F4F7));background: -moz-linear-gradient(top, #E7E9ED, #F1F4F7);}.ke-upload-list td,.ke-upload-list th {padding:0em;height:26px;line-height:26px;text-align:center;border-bottom:1px solid #c1c8d1;}.ke-upload-complete .ke-upload-filename {text-decoration:underline;cursor:pointer;}",
"ke-MultiUpload");m.augment(y,{addRes:l.Utils.addRes,destroy:l.Utils.destroyRes,_prepareShow:function(){var a=this,c=a.editor,b=c.cfg.pluginConfig["multi-upload"];a.addRes(function(){var j=a.progressBars,h;for(h in j)j.hasOwnProperty(h)&&j[h].destroy()});a.dialog=new F({headerContent:"\u6279\u91cf\u4e0a\u4f20",mask:false,constrain:false,autoRender:true,focus4e:false,width:"600px"});var d=a.dialog;d.on("beforeVisibleChange",function(j){if(!j.newVal){d.set("xy",[-9999,-9999]);return false}});a.addRes(d);var e=d.get("body"),
f=(new k("<div class='ke-upload-btn-wrap'><span style='margin:0 15px 0 0px;color:#969696;display:inline-block;vertical-align:middle;width:450px;'></span></div>")).appendTo(e),i=(new k("<div style='display:none'>")).appendTo(e),o=(new k("<a class='ke-button'>\u6d4f&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\u89c8</a>")).appendTo(f),q=(new k("<div><table class='ke-upload-list'><thead><tr><th style='width:30px;'>\u5e8f\u53f7</th><th>\u56fe\u7247</th><th>\u5927\u5c0f</th><th style='width:30%'>\u4e0a\u4f20\u8fdb\u5ea6</th><th>\u56fe\u7247\u64cd\u4f5c</th></tr></thead><tbody></tbody></table></div>")).appendTo(i),
s=q.one("tbody"),p=(new k("<p style='margin:15px 15px 30px 6px;'><a class='ke-bangpaiupload-delall' style='margin-right:20px;cursor:pointer;margin-left:40px;'>\u6e05\u7a7a\u5217\u8868</a><a class='ke-button ke-bangpaiupload-ok'>\u786e\u5b9a\u4e0a\u4f20</a><a class='ke-button ke-bangpaiupload-insertall' style='margin-left:20px;'>\u5168\u90e8\u63d2\u5165</a></p>")).appendTo(i),u=p.one(".ke-bangpaiupload-ok");e=p.one(".ke-bangpaiupload-insertall");var A=p.one(".ke-bangpaiupload-delall");m.guid("ke-multi-upload");p=(new k("<span>")).prependTo(p);a._sizeLimit=
b.sizeLimit||1E3;a._numberLimit=b.numberLimit||15;var B="\u5141\u8bb8\u7528\u6237\u540c\u65f6\u4e0a\u4f20"+a._numberLimit+"\u5f20\u56fe\u7247\uff0c\u5355\u5f20\u56fe\u7247\u5bb9\u91cf\u4e0d\u8d85\u8fc7"+a._sizeLimit/1E3+"M";w.fpvGEQ("10.0.0")||(B="\u60a8\u7684flash\u63d2\u4ef6\u7248\u672c\u8fc7\u4f4e\uff0c\u8be5\u529f\u80fd\u4e0d\u53ef\u7528\uff0c\u8bf7<a href='http://get.adobe.com/cn/flashplayer/' target='_blank'>\u70b9\u6b64\u5347\u7ea7</a>");o.addClass("ke-triplebutton-disabled");a.tipSpan=f.one("span");a.tipSpan.html(B);if(w.fpvGEQ("10.0.0")){b.extraHtml&&q.append(b.extraHtml);a._list=s;a._listTable=s.parent("table");a._listWrap=i;a._ds=b.serverUrl;a._dsp=b.serverParams||{};a._fileInput=b.fileInput||
"Filedata";a.statusText=p;a.btn=o;a.up=u;q=o.offset();u=o.width()*2;p=o.height()*1.5;f=(new k("<div style='"+("position:absolute;width:"+u+"px;height:"+p+"px;z-index:"+l.baseZIndex(9999)+";")+"'>")).appendTo(f);f.offset(q);a.flashPos=f;f=new l.FlashBridge({movie:G,ajbridge:true,methods:["getReady","removeFile","lock","unlock","setAllowMultipleFiles","setFileFilters","uploadAll"],holder:f,attrs:{width:u,height:p},params:{wmode:"transparent"},flashVars:{allowedDomain:location.hostname,btn:true,hand:true}});
a.uploader=f;f.on("mouseOver",function(){o.addClass("ke-button-hover")});f.on("mouseOut",function(){o.removeClass("ke-button-hover")});a.addRes(f);e.on("click",function(j){for(var h=s.all("tr"),g=0;g<h.length;g++){var r=new k(h[g]),v=r.attr("url");if(v){(new Image).src=v;c.insertElement(new k("<p>&nbsp;<img src='"+v+"'/>&nbsp;</p>",null,c.document));a._removeTrFile(r)}}if(v){i.hide();d.hide()}j.halt()});a.addRes(e);A.on("click",function(j){for(var h=s.all("tr"),g=0;g<h.length;g++){var r=new k(h[g]);
a._removeTrFile(r)}i.hide();j.halt()});a.addRes(A);s.on("click",function(j){var h=new k(j.target),g;j.halt();if(h.hasClass("ke-upload-insert")){g=h.parent("tr");var r=g.attr("url");(new Image).src=r;c.insertElement(new k("<img src='"+r+"'/>",null,c.document))}if(h.hasClass("ke-upload-delete")||h.hasClass("ke-upload-insert")){g=h.parent("tr");a._removeTrFile(g)}if(h.hasClass("ke-upload-moveup")){g=h.parent("tr");g.css("backgroundColor","#eef4f9");g.animate({backgroundColor:"#FBFBFB"},1,null,function(){g.css("backgroundColor",
"")});if(h=g.prev()){z(g[0],h[0]);a._syncStatus()}}else if(h.hasClass("ke-upload-movedown")){g=h.parent("tr");g.css("backgroundColor","#eef4f9");g.animate({backgroundColor:"#FBFBFB"},1,null,function(){g.css("backgroundColor","")});if(h=g.next()){z(g[0],h[0]);a._syncStatus()}}j.halt()});a.addRes(s);f.on("fileSelect",a._onSelect,a);f.on("uploadStart",a._onUploadStart,a);f.on("uploadProgress",a._onProgress,a);f.on("uploadCompleteData",a._onUploadCompleteData,a);f.on("contentReady",a._ready,a);f.on("uploadError",
a._uploadError,a);l.storeReady(function(){a._restore()});e=b.previewWidth;var C=b.previewSuffix;if(e){var t=new (m.require("overlay"))({mask:false,autoRender:true,width:e,render:i});a.addRes(t);var D=t.get("contentEl");D.css("border","none");var E=0;i.on("mouseover",function(j){if(j=(new k(j.target)).parent(".ke-upload-filename")){var h=j._4e_ascendant("tr");if(h.hasClass("ke-upload-complete")){var g=h.attr("url");h=h.attr("fid");if(g){if(h!=E){E=h;if(C)g=g.replace(/(\.\w+$)/,C);D.html("<img style='display:block;' src='"+
g+"' />")}g=n.offset(j);g.left+=j[0].offsetWidth;t.set("xy",[g.left,g.top]);t.show()}}}else t.hide()});a.addRes(i)}!w.webkit&&l.Utils.ieEngine!=9&&d.set("handlers",[d.get("el")])}},_removeTrFile:function(a){var c=this.progressBars,b=a.attr("fid"),d=this.uploader;if(b)try{d.removeFile(b)}catch(e){}if(c[b]){c[b].destroy();delete c[b]}a._4e_remove();this.denable();this._syncStatus()},_realShow:function(){this.dialog.center();this.dialog.show()},show:function(){this._prepareShow()},_uploadError:function(a){var c=
this.progressBars,b=this.uploader,d=a.id||a.file&&a.file.id;if(d){var e=this._getFileTr(d),f=c[d],i=a.status;b.removeFile(d);if(!a._custom){m.log(i);i="\u670d\u52a1\u5668\u51fa\u9519\u6216\u683c\u5f0f\u4e0d\u6b63\u786e"}if(e){f&&f.destroy();delete c[d];e.one(".ke-upload-progress").html("<div style='color:red;'>"+i+"</div>")}}else m.log(a)},_getFileTr:function(a){for(var c=this._list.all("tr"),b=0;b<c.length;b++){var d=new k(c[b]);if(d.attr("fid")==a)return d}},_onUploadStart:function(a){this._getFileTr(a.id||a.file&&a.file.id)[0].className="ke-upload-uploading"},
_onComplete:function(){},_onUploadCompleteData:function(a){var c=this.uploader,b=m.trim(a.data).replace(/\r|\n/g,"");if(a=a.file.id)try{c.removeFile(a)}catch(d){}if(b){try{b=x.parse(b)}catch(e){m.log("multi-upload _onUploadCompleteData error :");m.log(e);throw e;}if(b.error)this._uploadError({id:a,_custom:1,status:b.error});else{if(c=this._getFileTr(a)){c.one(".ke-upload-insert").show();this._tagComplete(c,b.imgUrl)}this._syncStatus()}}},_onProgress:function(a){var c=Math.floor(a.bytesLoaded*100/
a.bytesTotal);(a=this.progressBars[a.file.id])&&a.set("progress",c)},ddisable:function(){this.uploader.lock();this.btn.addClass("ke-triplebutton-disabled");this.flashPos.offset({left:-9999,top:-9999})},denable:function(){this.uploader.unlock();this.btn.removeClass("ke-triplebutton-disabled");this.flashPos.offset(this.btn.offset())},_syncStatus:function(){var a=this._list,c=1,b=a.all("tr");if(b.length==0)this._listWrap.hide();else{a.all(".ke-upload-seq").each(function(e){e.html(c++)});for(var d=a=
0;d<b.length;d++)(new k(b[d])).attr("url")||a++;this.statusText.html("\u961f\u5217\u4e2d\u5269\u4f59"+a+"\u5f20\u56fe\u7247\uff0c\u70b9\u51fb\u786e\u5b9a\u4e0a\u4f20\uff0c\u5f00\u59cb\u4e0a\u4f20\u3002 ")}this._save()},_restore:function(){var a=l.localStorage.getItem("Multi-Upload-Save"),c=this._list[0];if(a){a=x.parse(decodeURIComponent(a));for(var b=0;b<a.length;b++){var d=a[b];d.complete=1;d.fid="restore_"+b;this._tagComplete(this._createFileTr(c,d),d.url)}if(d){this._listWrap.show();this._syncStatus()}}},_tagComplete:function(a,c){a.attr("url",c);a[0].className="ke-upload-complete"},_save:function(){for(var a=
l.localStorage,c=this._list.all("tr"),b=[],d=0;d<c.length;d++){var e=new k(c[d]),f=e.attr("url");if(f){var i=e.one(".ke-upload-filesize").html();e=e.one(".ke-upload-filename").text();b.push({name:e,size:i,url:f})}}a&&a.setItem("Multi-Upload-Save",encodeURIComponent(x.stringify(b)))},_getFilesSize:function(a){var c=0,b;for(b in a)a.hasOwnProperty(b)&&c++;return c},_createFileTr:function(a,c){var b=this.progressBars,d=c.fid,e=a.insertRow(-1);n.attr(e,"fid",d);var f=e.insertCell(-1);n.attr(f,"class",
"ke-upload-seq");f=e.insertCell(-1);if(c.name.length>18)c.name=c.name.substring(0,18)+"...";n.html(f,"<div style='width:160px;overflow:hidden;'><div style='width:9999px;text-align:left;'>"+c.name+"</div></div>");n.attr(f,"class","ke-upload-filename");f=e.insertCell(-1);n.html(f,c.size);n.attr(f,"class","ke-upload-filesize");f=e.insertCell(-1);n.attr(f,"class","ke-upload-progress");f=e.insertCell(-1);n.html(f,"<a class='ke-upload-moveup' href='#'>[\u4e0a\u79fb]</a> &nbsp; <a class='ke-upload-movedown' href='#'>[\u4e0b\u79fb]</a> &nbsp; <a href='#' class='ke-upload-insert' style='"+
(c.complete?"":"display:none;")+"' >[\u63d2\u5165]</a> &nbsp; <a href='#' class='ke-upload-delete'>[\u5220\u9664]</a> &nbsp;");e=new k(e);e.one(".ke-upload-progress");if(parseInt(c.size)>this._sizeLimit){this._uploadError({id:d,_custom:1,status:"\u56fe\u7247\u592a\u5927\uff0c\u8bf7\u538b\u7f29\u81f3 n M\u4ee5\u4e0b".replace(/n/,this._sizeLimit/1E3)});this.uploader.removeFile(d)}else{b[d]=new l.ProgressBar({container:e.one(".ke-upload-progress"),width:"100px",height:"15px"});c.complete&&b[d].set("progress",100)}return e},_onSelect:function(a){var c=this.uploader,b=this._list,
d=0;a=a.fileList;var e=this._numberLimit;if(a){e=b.children("tr");for(b=0;b<e.length;b++){var f=n.attr(e[b],"fid");f&&a[f]&&delete a[f]}e=this._numberLimit-e.length;f=this._getFilesSize(a);f>e&&alert("\u7cfb\u7edf\u5c06\u53ea\u4fdd\u7559 n \u5f20".replace(/n/,this._numberLimit));f>=e&&this.ddisable();this._listWrap.show();f=this._list[0];for(b in a)if(a.hasOwnProperty(b)){d++;var i=a[b],o=Math.floor(i.size/1E3),q=i.id;d>e?c.removeFile(q):this._createFileTr(f,{size:o+"k",fid:q,name:i.name})}this._syncStatus()}},_ready:function(){var a=
this,c=a.uploader,b=a.up,d=a.btn,e=a.flashPos,f=l.Utils.normParams;if("ready"!=c.getReady()){a.tipSpan.html("\u60a8\u7684\u6d4f\u89c8\u5668\u4e0d\u652f\u6301\u8be5\u529f\u80fd\uff0c\u8bf7\u5347\u7ea7\u5f53\u524d\u6d4f\u89c8\u5668\uff0c\u5e76\u540c\u65f6 <a href='http://get.adobe.com/cn/flashplayer/' target='_blank'>\u70b9\u6b64\u5347\u7ea7</a> flash \u63d2\u4ef6");e.offset({left:-9999,top:-9999})}else{d.removeClass("ke-triplebutton-disabled");e.offset(d.offset());c.setAllowMultipleFiles(true);c.setFileFilters([{ext:"*.jpeg;*.jpg;*.png;*.gif",desc:"\u56fe\u7247\u6587\u4ef6( png,jpg,jpeg,gif )"}]);b.detach();b.on("click",function(i){c.uploadAll(a._ds,"POST",f(a._dsp),
a._fileInput);i.halt()});a.addRes(b)}}});l.MultiUpload.Dialog=y},{attach:false});
