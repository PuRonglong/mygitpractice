/*
 Constructor for kissy editor,dependency moved to independent module
 thanks to CKSource's intelligent work on CKEditor
 @author yiminghe@gmail.com, lifesinger@gmail.com
 @version: 2
 @buildtime: 2012-10-29 15:53:12
*/
KISSY.add("editor/export",function(f){function s(j,n){var c=this;if(!(c instanceof s))return new s(j,n);f.isString(j)&&(j=f.one(j));j=k._4e_wrap(j);n=n||{};n.pluginConfig=n.pluginConfig||{};c.cfg=n;n.pluginConfig=n.pluginConfig;c.cfg=n;f.app(c,f.EventTarget);var e=["htmldataprocessor","enterkey","clipboard"],b=i;c.use=function(a,g){a=a.split(",");if(!b)for(var h=0;h<e.length;h++){var i=e[h];f.inArray(i,a)||a.unshift(i)}c.ready(function(){f.Editor.use("button,select",function(){f.use.call(c,a.join(","),
function(){for(var d=0;d<a.length;d++)c.usePlugin(a[d]);g&&g.call(c);b||(c.setData(j.val()),n.focus?c.focus():(d=c.getSelection())&&d.removeAllRanges(),b=o)},{global:s})})});return c};c.use=c.use;c.Config.base=s.Config.base;c.Config.debug=s.Config.debug;c.Config.componentJsName=h;c.init(j)}var k=f.DOM,o=!0,i=!1,h;h=1.2>parseFloat(f.version)?function(){return"plugin-min.js?t="+encodeURIComponent("2012-10-29 15:53:12")}:function(h,i){return h+"/plugin-min.js"+(i?i:"?t="+encodeURIComponent("2012-10-29 15:53:12"))};
f.app(s,f.EventTarget);s.Config.base=f.Config.base+"editor/plugins/";s.Config.debug=f.Config.debug;s.Config.componentJsName=h;f.Editor=s;f.Editor=s});KISSY.add("editor",function(f){return f.Editor},{requires:["dd","overlay"]});
KISSY.Editor.add("utils",function(f){var s=null,k=KISSY,o=k.Node,i=k.DOM,h=k.UA,j=k.Event,n={debugUrl:function(c){c=c.replace(/-min\.(js|css)/i,".$1");f.Config.debug||(c=c.replace(/\.(js|css)/i,"-min.$1"));-1==c.indexOf("?t")&&(c=-1!=c.indexOf("?")?c+"&":c+"?",c+="t="+encodeURIComponent("2012-01-11 13:45:11"));return f.Config.base+c},lazyRun:function(c,e,b){var a=c[e],g=c[b];c[e]=function(){a.apply(this,arguments);c[e]=c[b];return g.apply(this,arguments)}},getXY:function(c,e,b,a){b=b.defaultView||
b.parentWindow;c-=i.scrollLeft(b);e-=i.scrollTop(b);if(a&&b!=(a.defaultView||a.parentWindow)&&b.frameElement)a=i._4e_getOffset(b.frameElement,a),c+=a.left,e+=a.top;return{left:c,top:e}},tryThese:function(c){for(var e,b=0,a=arguments.length;b<a;b++){var g=arguments[b];try{e=g();break}catch(h){}}return e},arrayCompare:function(c,e){if(!c&&!e)return!0;if(!c||!e||c.length!=e.length)return!1;for(var b=0;b<c.length;b++)if(c[b]!==e[b])return!1;return!0},getByAddress:function(c,e,b){for(var c=c.documentElement,
a=0;c&&a<e.length;a++){var g=e[a];if(b)for(var h=-1,i=0;i<c.childNodes.length;i++){var d=c.childNodes[i];if(!(!0===b&&3==d.nodeType&&d.previousSibling&&3==d.previousSibling.nodeType)&&(h++,h==g)){c=d;break}}else c=c.childNodes[g]}return c?new o(c):s},clearAllMarkers:function(c){for(var e in c)c[e]._4e_clearMarkers(c,!0)},htmlEncodeAttr:function(c){return c.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/,"&gt;")},ltrim:function(c){return c.replace(/^\s+/,"")},rtrim:function(c){return c.replace(/\s+$/,
"")},trim:function(c){return this.ltrim(this.rtrim(c))},mix:function(c){for(var e={},b=0;b<arguments.length;b++)e=k.mix(e,arguments[b]);return e},isCustomDomain:function(){if(!h.ie)return!1;var c=document.domain,e=window.location.hostname;return c!=e&&c!="["+e+"]"},buffer:function(c,e,b){var b=b||0,a=s;return function(){a&&clearTimeout(a);var g=arguments;a=setTimeout(function(){return c.apply(e,g)},b)}},isNumber:function(c){return/^\d+(.\d+)?$/.test(k.trim(c))},verifyInputs:function(c){for(var e=
0;e<c.length;e++){var b=i._4e_wrap(c[e]),a=k.trim(n.valInput(b)),g=b.attr("data-verify"),b=b.attr("data-warning");if(g&&!RegExp(g).test(a))return alert(b),!1}return!0},sourceDisable:function(c,e){c.on("sourcemode",e.disable,e);c.on("wysiwygmode",e.enable,e)},resetInput:function(c){var e=c.attr("placeholder");e&&h.ie?(c.addClass("ke-input-tip"),c.val(e)):h.ie||c.val("")},valInput:function(c,e){if(void 0===e)return c.hasClass("ke-input-tip")?"":c.val();c.removeClass("ke-input-tip");c.val(e)},placeholder:function(c,
e){c.attr("placeholder",e);h.ie&&(c.on("blur",function(){k.trim(c.val())||(c.addClass("ke-input-tip"),c.val(e))}),c.on("focus",function(){c.removeClass("ke-input-tip");k.trim(c.val())==e&&c.val("")}))},htmlEncode:function(c){return!c?c:(""+c).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},normParams:function(c){var c=k.clone(c),e;for(e in c)if(c.hasOwnProperty(e)){var b=c[e];k.isFunction(b)&&(c[e]=b())}return c},doFormUpload:function(c,e,b){function a(){var d=
{responseText:"",responseXML:s};d.argument=c?c.argument:s;try{var l;if((l=h.ie?m.contentWindow.document:m.contentDocument||window.frames[g].document)&&l.body)d.responseText=k.trim(i.text(l.body));d.responseXML=l&&l.XMLDocument?l.XMLDocument:l}catch(b){k.log("after data returns error ,maybe domain problem:"),k.log(b,"error")}j.remove(m,"load",a);c.callback&&c.callback(d);setTimeout(function(){i._4e_remove(m)},100)}var g=k.guid("form-upload-"),m=document.createElement("iframe");m.id=g;m.name=g;m.className=
"ke-hidden";var u="document.open();"+(n.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();";h.ie&&(m.src=h.ie?"javascript:void(function(){"+encodeURIComponent(u)+"}())":"");k.log("doFormUpload : "+m.src);document.body.appendChild(m);h.ie&&(document.frames[g].name=g);var u=i._4e_unwrap(c.form),d={target:i.attr(u,"target"),method:i.attr(u,"method"),encoding:i.attr(u,"encoding"),enctype:i.attr(u,"enctype"),action:i.attr(u,"action")};i.attr(u,{target:g,method:"post",enctype:"multipart/form-data",
encoding:"multipart/form-data"});b&&i.attr(u,"action",b);var l;if(e){l=[];var e=f.Utils.normParams(e),x;for(x in e)e.hasOwnProperty(x)&&(b=document.createElement("input"),b.type="hidden",b.name=x,b.value=e[x],u.appendChild(b),l.push(b))}j.on(m,"load",a);u.submit();i.attr(u,d);if(l){e=0;for(x=l.length;e<x;e++)i._4e_remove(l[e])}return m},map:function(c,e){for(var b=0;b<c.length;b++)c[b]=e(c[b]);return c},ieEngine:!h.ie?void 0:document.documentMode||h.ie,preventFocus:function(c){h.ie?c._4e_unselectable():
c.attr("onmousedown","return false;")},isFlashEmbed:function(c){c=c.attributes;return"application/x-shockwave-flash"==c.type||/\.swf(?:$|\?)/i.test(c.src||"")},addRes:function(){var c=this.__res=this.__res||[];c.push.apply(c,k.makeArray(arguments))},destroyRes:function(){for(var c=this.__res||[],e=0;e<c.length;e++){var b=c[e];k.isFunction(b)?b():(b.detach&&b.detach(),b.destroy&&b.destroy(),b.nodeType&&b.remove&&b.remove())}this.__res=[]}};return f.Utils=n});
KISSY.Editor.add("dom",function(f){function s(d){return d.replace(/-(\w)/g,function(d,a){return a.toUpperCase()})}var k=KISSY,o=k.DOM,i=k.UA,h=k.Node,j=f.Utils,n={abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};f.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11};f.NODE=f.NODE;f.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,
POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};f.POSITION=f.POSITION;var c=f.NODE,e=f.POSITION,b={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},a={hr:1},g=function(d){return d[0]||d},m=function(d){return d&&!d[0]?new h(d):d},u={_4e_wrap:m,_4e_unwrap:g,_4e_equals:function(d,a){if(!d&&!a)return!0;if(!d||!a)return!1;d=g(d);a=g(a);return d===a},
_4e_isBlockBoundary:function(d,l){var d=m(d),c=k.mix(k.mix({},a),l||{});return b[d.css("display")]||c[d._4e_name()]},_4e_getWin:function(d){return d&&"scrollTo"in d&&d.document?d:d&&9===d.nodeType?d.defaultView||d.parentWindow:!1},_4e_index:function(d){for(var d=g(d),a=d.parentNode.childNodes,c=0;c<a.length;c++)if(a[c]===d)return c;return-1},_4e_first:function(d,a){var d=g(d),c=d.firstChild;(c=c&&new h(c))&&a&&!a(c)&&(c=c._4e_next(a));return c},_4e_move:function(d,a,c){d=g(d);o._4e_remove(d);a=g(a);
c?a.insertBefore(d,a.firstChild):a.appendChild(d)},_4e_name:function(d){var d=g(d),a=d.nodeName.toLowerCase();i.ie&&(d=d.scopeName)&&"HTML"!=d&&(a=d.toLowerCase()+":"+a);return a},_4e_isIdentical:function(d,a){if(d._4e_name()!=a._4e_name())return!1;var c=d[0].attributes,b=a[0].attributes,g=c.length,e=b.length;if(g!=e)return!1;for(var h=0;h<g;h++){var p=c[h],i=p.name;if(p.specified&&d.attr(i)!=a.attr(i))return!1}if(8>j.ieEngine)for(h=0;h<e;h++)if(p=b[h],i=p.name,p.specified&&d.attr(i)!=a.attr(i))return!1;
return!0},_4e_isEmptyInlineRemoveable:function(d){for(var d=g(d).childNodes,a=0,b=d.length;a<b;a++){var r=d[a],v=r.nodeType;if(!(v==c.NODE_ELEMENT&&r.getAttribute("_ke_bookmark"))&&(v==c.NODE_ELEMENT&&!u._4e_isEmptyInlineRemoveable(r)||v==c.NODE_TEXT&&k.trim(r.nodeValue)))return!1}return!0},_4e_moveChildren:function(d,a,c){d=g(d);a=a[0]||a;if(d!=a)if(c)for(;c=d.lastChild;)a.insertBefore(d.removeChild(c),a.firstChild);else for(;c=d.firstChild;)a.appendChild(d.removeChild(c))},_4e_mergeSiblings:function(){function d(d,
a,b){if(a[0]&&a[0].nodeType==c.NODE_ELEMENT){for(var g=[];a.attr("_ke_bookmark")||a._4e_isEmptyInlineRemoveable();)if(g.push(a),a=b?new h(a[0].nextSibling):new h(a[0].previousSibling),!a[0]||a[0].nodeType!=c.NODE_ELEMENT)return;if(d._4e_isIdentical(a)){for(var e=b?d[0].lastChild:d[0].firstChild;g.length;)g.shift()._4e_move(d,!b);a._4e_moveChildren(d,!b);a._4e_remove();e[0]&&e[0].nodeType==c.NODE_ELEMENT&&e._4e_mergeSiblings()}}}return function(a){if(a[0]&&(n[a._4e_name()]||"a"==a._4e_name()))d(a,
new h(a[0].nextSibling),!0),d(a,new h(a[0].previousSibling))}}(),_4e_unselectable:i.gecko?function(d){d=g(d);d.style.MozUserSelect="none"}:i.webkit?function(d){d=g(d);d.style.KhtmlUserSelect="none"}:function(d){d=g(d);if(i.ie||i.opera){var a=0;d.setAttribute("unselectable","on");for(var c=d.getElementsByTagName("*");d=c[a++];)switch(d.tagName.toLowerCase()){case "iframe":case "textarea":case "input":case "select":break;default:d.setAttribute("unselectable","on")}}},_4e_getOffset:function(d,a){var d=
g(d),c,b=0;c=0;var e=d.ownerDocument.defaultView||d.ownerDocument.parentWindow,q=d.ownerDocument,h=q.documentElement,a=a||q;if(d.getBoundingClientRect&&(d!==q.body&&h!==d&&(c=d.getBoundingClientRect(),b=c.left+(a===q?o.scrollLeft(e):0),c=c.top+(a===q?o.scrollTop(e):0)),a&&e!=(a.defaultView||a.parentWindow)&&e.frameElement))e=u._4e_getOffset(e.frameElement,a),b+=e.left,c+=e.top;return{left:b,top:c}},_4e_splitText:function(d,a){var d=g(d),b=d.ownerDocument;if(d&&d.nodeType==c.NODE_TEXT){if(i.ie&&a==
d.nodeValue.length){var r=b.createTextNode("");o.insertAfter(r,d);return new h(r)}r=new h(d.splitText(a));b.documentMode&&(b=b.createTextNode(""),o.insertAfter(b,r[0]),o._4e_remove(b));return r}},_4e_parents:function(d,a){var d=m(d),c=[];do c[a?"push":"unshift"](d);while(d=d.parent());return c},_4e_clone:function(d,a,b){d=g(d);d=d.cloneNode(a);if(!b){var r=function(d){if(d.nodeType==c.NODE_ELEMENT){d.removeAttribute("id");for(var d=d.childNodes,a=0;a<d.length;a++)r(d[a])}};r(d)}return new h(d)},_4e_nextSourceNode:function(d,
a,b,r){d=g(d);if(r&&!r.call)var e=r[0]||r,r=function(d){d=d[0]||d;return d!==e};var a=!a&&d.firstChild,q=new h(d);if(!a){if(d.nodeType==c.NODE_ELEMENT&&r&&!1===r(d,!0))return null;a=d.nextSibling}for(;!a&&(q=q.parent());){if(r&&!1===r(q,!0))return null;a=q[0].nextSibling}if(!a)return null;a=o._4e_wrap(a);return r&&!1===r(a)?null:b&&b!=a[0].nodeType?a._4e_nextSourceNode(!1,b,r):a},_4e_previousSourceNode:function(d,a,b,r){d=g(d);if(r&&!r.call)var e=r[0]||r,r=function(d){d=d[0]||d;return d!==e};var a=
!a&&d.lastChild,q=new h(d);if(!a){if(d.nodeType==c.NODE_ELEMENT&&r&&!1===r(d,!0))return null;a=d.previousSibling}for(;!a&&(q=q.parent());){if(r&&!1===r(q,!0))return null;a=q[0].previousSibling}if(!a)return null;a=o._4e_wrap(a);return r&&!1===r(a)?null:b&&a[0].nodeType!=b?a._4e_previousSourceNode(!1,b,r):a},_4e_commonAncestor:function(d,a){if(d._4e_equals(a))return d;if(a[0].nodeType!=c.NODE_TEXT&&a.contains(d))return a;var b=d[0].nodeType==c.NODE_TEXT?d.parent():d;do if(b[0].nodeType!=c.NODE_TEXT&&
b.contains(a))return b;while(b=b.parent());return null},_4e_ascendant:function(d,a,c){d=g(d);c||(d=d.parentNode);if(a&&!k.isFunction(a))var b=a,a=function(d){return d._4e_name()==b};for(;d&&9!=d.nodeType;){if(!a||!0===a(new h(d)))return new h(d);d=d.parentNode}return null},_4e_hasAttribute:9>j.ieEngine?function(d,a){var d=g(d),c=d.getAttributeNode(a);return!(!c||!c.specified)}:function(d,a){d=g(d);return d.hasAttribute(a)},_4e_hasAttributes:9>j.ieEngine?function(d){for(var d=g(d),a=d.attributes,c=
0;c<a.length;c++){var b=a[c];switch(b.name){case "class":if(d.getAttribute("class"))return!0;break;default:if(b.specified)return!0}}return!1}:function(d){d=g(d);i.gecko&&d.removeAttribute("_moz_dirty");return d.hasAttributes()},_4e_position:function(d,a){var b=g(d),r=g(a);if(b.compareDocumentPosition)return b.compareDocumentPosition(r);if(b==r)return e.POSITION_IDENTICAL;if(b.nodeType==c.NODE_ELEMENT&&r.nodeType==c.NODE_ELEMENT){if(b.contains){if(b.contains(r))return e.POSITION_CONTAINS+e.POSITION_PRECEDING;
if(r.contains(b))return e.POSITION_IS_CONTAINED+e.POSITION_FOLLOWING}if("sourceIndex"in b)return 0>b.sourceIndex||0>r.sourceIndex?e.POSITION_DISCONNECTED:b.sourceIndex<r.sourceIndex?e.POSITION_PRECEDING:e.POSITION_FOLLOWING}for(var b=d._4e_address(),r=a._4e_address(),v=Math.min(b.length,r.length),q=0;q<=v-1;q++)if(b[q]!=r[q]){if(q<v)return b[q]<r[q]?e.POSITION_PRECEDING:e.POSITION_FOLLOWING;break}return b.length<r.length?e.POSITION_CONTAINS+e.POSITION_PRECEDING:e.POSITION_IS_CONTAINED+e.POSITION_FOLLOWING},
_4e_address:function(a,b){for(var a=g(a),c=[],r=a.ownerDocument.documentElement,e=a;e&&e!=r;){var q=e.parentNode,h=-1;if(q){for(var p=0;p<q.childNodes.length;p++){var i=q.childNodes[p];if(!b||!(3==i.nodeType&&i.previousSibling&&3==i.previousSibling.nodeType))if(h++,i==e)break}c.unshift(h)}e=q}return c},_4e_breakParent:function(a,b){var c=new f.Range(a[0].ownerDocument);c.setStartAfter(a);c.setEndAfter(b);var g=c.extractContents();c.insertNode(a._4e_remove());a[0].parentNode.insertBefore(g,a[0].nextSibling)},
_4e_style:function(a,b,c){if(void 0!==c){a=m(a);a.css(b,c);var e=a[0].style;""==c&&e.removeAttribute&&e.removeAttribute(b);e.cssText||a[0].removeAttribute("style")}else return a=g(a),a.style[s(b)]},_4e_remove:function(a,b){var c=g(a),e=c.parentNode;if(e){if(b)for(var v;v=c.firstChild;)e.insertBefore(c.removeChild(v),c);e.removeChild(c)}return a},_4e_trim:function(a){o._4e_ltrim(a);o._4e_rtrim(a)},_4e_ltrim:function(a){for(var a=g(a),b;b=a.firstChild;){if(b.nodeType==c.NODE_TEXT){var e=j.ltrim(b.nodeValue),
r=b.nodeValue.length;if(e)e.length<r&&((new h(b))._4e_splitText(r-e.length),a.removeChild(a.firstChild));else{a.removeChild(b);continue}}break}},_4e_rtrim:function(a){for(var a=g(a),b;b=a.lastChild;){if(b.type==c.NODE_TEXT){var e=j.rtrim(b.nodeValue),r=b.nodeValue.length;if(e)e.length<r&&((new h(b))._4e_splitText(e.length),a.removeChild(a.lastChild));else{a.removeChild(b);continue}}break}!i.ie&&!i.opera&&(b=a.lastChild)&&1==b.nodeType&&"br"==b.nodeName.toLowerCase()&&b.parentNode.removeChild(b)},
_4e_appendBogus:function(a){for(var a=g(a),b=a.lastChild;b&&b.nodeType==c.NODE_TEXT&&!k.trim(b.nodeValue);)b=b.previousSibling;if(!b||b.nodeType==c.NODE_TEXT||"br"!==o._4e_name(b))b=i.opera?a.ownerDocument.createTextNode(""):a.ownerDocument.createElement("br"),i.gecko&&b.setAttribute("type","_moz"),a.appendChild(b)},_4e_getBogus:function(a){return f.Walker.getBogus(m(a))},_4e_previous:function(a,b){var c=g(a),e;do e=(c=c.previousSibling)&&new h(c);while(e&&b&&!b(e));return e},_4e_last:function(a,
b){var a=o._4e_wrap(a),c=a[0].lastChild;(c=c&&new h(c))&&b&&!b(c)&&(c=c._4e_previous(b));return c},_4e_next:function(a,b){var c=g(a),e;do e=(c=c.nextSibling)&&new h(c);while(e&&b&&!b(e));return e},_4e_outerHtml:function(a){a=g(a);if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,"");var b=a.ownerDocument.createElement("div");b.appendChild(a.cloneNode(!0));return b.innerHTML},_4e_setMarker:function(a,b,c,e){var a=o._4e_wrap(a),g=a.data("list_marker_id")||a.data("list_marker_id",k.guid()).data("list_marker_id"),
q=a.data("list_marker_names")||a.data("list_marker_names",{}).data("list_marker_names");b[g]=a;q[c]=1;return a.data(c,e)},_4e_clearMarkers:function(a,b,c){var a=m(a),e=a.data("list_marker_names"),g=a.data("list_marker_id"),q;for(q in e)a.removeData(q);a.removeData("list_marker_names");c&&(a.removeData("list_marker_id"),delete b[g])},_4e_copyAttributes:function(a,b,c){for(var a=g(a),b=m(b),e=a.attributes,c=c||{},v=0;v<e.length;v++){var q=e[v],h=q.name.toLowerCase(),p;if(!(h in c))if("checked"==h&&
(p=o.attr(a,h)))b.attr(h,p);else if(q.specified||i.ie&&q.value&&"value"==h)p=o.attr(a,h),null===p&&(p=q.nodeValue),b.attr(h,p)}""!==a.style.cssText&&(b[0].style.cssText=a.style.cssText)},_4e_isEditable:function(a){var a=o._4e_name(a),b=f.XHTML_DTD;return(a=!b.$nonEditable[a]&&(b[a]||b.span))&&a["#"]},_4e_scrollIntoView:function(a){a=m(a);a.scrollIntoView(a[0].ownerDocument,!1)},_4e_getElementsByTagName:function(a,b,c){a=g(a);!i.ie&&c&&(b=c+":"+b);c=[];a=a.getElementsByTagName(b);for(b=0;b<a.length;b++)c.push(new h(a[b]));
return c}};(function(a){k.mix(o,a);for(var b in a)a.hasOwnProperty(b)&&function(b){h.prototype[b]=function(){var c=[].slice.call(arguments,0);c.unshift(this);return a[b].apply(null,c)}}(b)})(u)});
KISSY.Editor.add("focusmanager",function(f){function s(){var a=this;a.iframeFocus=e;c=a;n&&clearTimeout(n);n=setTimeout(function(){a.fire("focus")},100)}function k(){var e=this;e.iframeFocus=b;c=a;n&&clearTimeout(n);n=setTimeout(function(){e.fire("blur")},100)}var o=KISSY,i=o.DOM,h=o.Event,j={},n,c,o={refreshAll:function(){for(var a in j){var b=j[a];b.document.designMode="off";b.document.designMode="on"}},currentInstance:function(){return c},getInstance:function(a){return j[a]},add:function(a){var b=
i._4e_getWin(a.document);h.on(b,"focus",s,a);h.on(b,"blur",k,a)},register:function(a){j[a._UUID]=a},remove:function(a){delete j[a._UUID];var b=i._4e_getWin(a.document);h.remove(b,"focus",s,a);h.remove(b,"blur",k,a)}},e=!0,b=!1,a=null;o.refreshAll=o.refreshAll;f.focusManager=o;f.focusManager=o;f.getInstances=function(){return j};f.getInstances=f.getInstances});
KISSY.Editor.add("definition",function(f){var s=!0,k=!1,o=f.Utils,i=document,h=KISSY,j=h.UA,n=j.ie,c=h.DOM,e=h.Node,b=h.Event,a=f.focusManager,g=o.tryThese,m=1,u="document.open();"+(o.isCustomDomain()?'document.domain="'+i.domain+'";':"")+"document.close();",d='<div  class=\'ke-editor-wrap\'  > <div class=\'ke-editor-tools\' ></div><div class=\'ke-textarea-wrap\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor" '+(n?' src="javascript:void(function(){'+
encodeURIComponent(u)+'}())"':"")+" allowTransparency=\"true\" ></iframe></div><div class='ke-editor-status'></div></div>",l,x;l=f.SOURCE_MODE=0;x=f.WYSIWYG_MODE=1;f.SOURCE_MODE=l;f.WYSIWYG_MODE=x;h.augment(f,{init:function(b){var g=this,q;g.__commands={};g.__dialogs={};g.__plugins={};n&&c.addClass(i.body,"ke-ie"+n);j.trident?c.addClass(i.body,"ke-trident"+j.trident):j.gecko?c.addClass(i.body,"ke-gecko"):j.webkit&&c.addClass(i.body,"ke-webkit");q=new e(d);g.editorWrap=q;g._UUID=m++;a.register(g);
g.wrap=q.one(".ke-textarea-wrap");g.iframe=g.wrap.one("iframe");g.toolBarDiv=q.one(".ke-editor-tools");g.textarea=b;g.statusDiv=q.one(".ke-editor-status");o.preventFocus(g.toolBarDiv);var h=b._4e_style("width"),p=b._4e_style("height");h&&(q.css("width",h),b.css("width","100%"));g.textarea.css("display","none");q.insertAfter(b);g.wrap[0].appendChild(b[0]);p&&(g.wrap.css("height",p),b.css("height","100%"));q=g.iframe;b._4e_hasAttribute("tabindex")&&(q[0].tabIndex=j.webkit?-1:b[0].tabIndex);g.on("dataReady",
function(){g._ready=s;f.fire("instanceCreated",{editor:g})});if(j.gecko)q.on("load",g._setUpIFrame,g);else g._setUpIFrame();g.cfg.attachForm&&b[0].form&&g._attachForm()},destroy:function(){if(!this.__destroyed){var a=this.editorWrap,c=this.textarea,d=this.document,e=this.iframe[0].contentWindow;this.sync();f.focusManager.remove(this);b.remove(d);b.remove(d.documentElement);b.remove(d.body);b.remove(e);this.iframe.detach();var d=this.__plugins,g;for(g in d)d.hasOwnProperty(g)&&(e=d[g],e.destroy&&e.destroy());
this.fire("destroy");c.insertBefore(a);a.remove();c.css({width:a[0].style.width,height:this.wrap.css("height")});c.show();this.__commands=this.__dialogs=this.__plugins=null;this.detach();this.__destroyed=!0}},_attachForm:function(){var a=this,b=new e(a.textarea[0].form);b.on("submit",a.sync,a);a.on("destroy",function(){b.detach("submit",a.sync,a)})},useDialog:function(a,b){var c=this,d=f.Overlay;d&&d.loading();c.use(a,function(){var e=c.getDialog(a);e?(b(e),d&&d.unloading()):h.later(arguments.callee,
50,!1,c)})},showDialog:function(a,b,c){var d=this,b=b||[];d.useDialog(a,function(e){e.show.apply(e,b);c&&c(e);d.fire("dialogShow",{dialog:e.dialog,pluginDialog:e,dialogName:a})})},addDialog:function(a,b){this.__dialogs[a]=b},getDialog:function(a){return this.__dialogs[a]},destroyDialog:function(a){var b=this.__dialogs[a];b&&b.destroy();this.__dialogs[a]=null},addCommand:function(a,b){this.__commands[a]=b},hasCommand:function(a){return this.__commands[a]},execCommand:function(a){var b=this.__commands[a],
c=h.makeArray(arguments);c.shift();c.unshift(this);return b.exec.apply(b,c)},getMode:function(){return"none"==this.textarea.css("display")?x:l},getData:function(a){var b;b=this.getMode()==x?this.document&&this.document.body?this.document.body.innerHTML:"":this.textarea.val();this.htmlDataProcessor&&(b=a?this.htmlDataProcessor.toHtml(b,"p"):this.htmlDataProcessor.toServer(b,"p"));b=h.trim(b);/^<p>((&nbsp;)|\s)*<\/p>$/.test(b)&&(b="");return b},setData:function(a){var b=a;this.htmlDataProcessor&&(b=
this.htmlDataProcessor.toDataFormat(a,"p"));this.document.body.innerHTML=b;b||(this.document.body.innerHTML=b);this.getMode()!=x&&this.textarea.val(a)},sync:function(){this.textarea.val(this.getData())},_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(a){this.document.body.innerHTML=a},_prepareIFrameHtml:function(a){var b=this.cfg,c=b.customStyle,b=b.customLink,d="",e=f.Utils.debugUrl("../theme/editor-iframe.css");if(b)for(var g=0;g<b.length;g++)d+='<link href="'+b[g]+
'" rel="stylesheet"/>';return"<!doctype html><html><head>"+(8===i.documentMode?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"")+"<title>${title}</title><link href='"+e+"' rel='stylesheet'/><style>"+(c||"")+"</style>"+d+"</head><body class='ke-editor'>&nbsp;"+(a?'<script id="ke_actscript" type="text/javascript">'+(o.isCustomDomain()?'document.domain="'+i.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+a+'");<\/script>':"")+"</body></html>"},getSelection:function(){return f.Selection.getSelection(this.document)},
focus:function(){var a=this.document,b=c._4e_getWin(a);j.ie||b&&b.parent&&b.parent.focus();b&&b.focus();a&&a.body.focus();this.notifySelectionChange()},blur:function(){c._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},addCustomStyle:function(a){var b=this.cfg,c=this.document;b.customStyle=b.customStyle||"";b.customStyle+="\n"+a;b=c.createElement("style");c.getElementsByTagName("head")[0].appendChild(b);b.styleSheet?b.styleSheet.cssText=a:b.appendChild(c.createTextNode(a))},
addCustomLink:function(a){var b=this.cfg,c=this.document;b.customLink=b.customLink||[];b.customLink.push(a);b=c.createElement("link");b.rel="stylesheet";c.getElementsByTagName("head")[0].appendChild(b);b.href=a},removeCustomLink:function(a){for(var b=this.cfg,d=h.makeArray(this.document.getElementsByTagName("link")),e=0;e<d.length;e++)d[e].href==a&&c._4e_remove(d[e]);b.customLink=b.customLink||[];b=b.customLink;a=h.indexOf(a,b);-1!=a&&b.splice(a,1)},_setUpIFrame:function(){function a(){g=e.document;
b.document=g;c.detach();g.open("text/html","replace");g.write(d);g.close()}var b=this,c=b.iframe,d=b._prepareIFrameHtml(b._UUID),e=c[0].contentWindow,g;try{g=e.document}catch(h){if(c[0].src=c[0].src,7>n){setTimeout(a,10);return}}a()},ready:function(a){if(this._ready)a();else this.on("dataReady",a)},addPlugin:function(a,b,c){this.__plugins=this.__plugins;c=c||{};c.func=b;this.__plugins[a]=c},usePlugin:function(a){var b=this.__plugins[a];if(b&&(!b.status||b.duplicate)){for(var a=this.Env.mods[a].requires||
[],c=0;c<a.length;c++)this.usePlugin(a[c]);b.func.call(b);b.status=1}},_monitor:function(){var a=this;a._monitorId&&clearTimeout(a._monitorId);a._monitorId=setTimeout(function(){var b=a.getSelection();if(b&&!b.isInvalid){var c=b.getStartElement(),d=new f.ElementPath(c);if(!a.previousPath||!a.previousPath.compare(d))a.previousPath=d,a.fire("selectionChange",{selection:b,path:d,element:c})}},100)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(a,b,c){var d=
this;if(d.getMode()===x){d.focus();var g,h=a._4e_name(),i=f.XHTML_DTD,y=f.RANGE,z=f.NODE,C=i.$block[h],n=d.getSelection(),D=n&&n.getRanges(),A,j,m,l;if(!D||0==D.length){var u=arguments,o=u.callee;setTimeout(function(){o.apply(d,u)},30)}else{d.fire("save");for(var E=D.length-1;0<=E;E--){A=D[E];A.deleteContents();g=!E&&a||a._4e_clone(s);b&&b(g);if(C)for(;(m=A.getCommonAncestor(k,s))&&(l=i[m._4e_name()])&&(!l||!l[h]);)m._4e_name()in i.span?A.splitElement(m):A.checkStartOfBlock()&&A.checkEndOfBlock()?
(A.setStartBefore(m),A.collapse(s),m._4e_remove()):A.splitBlock();A.insertNode(g);j||(j=g)}j&&(h=j._4e_nextSourceNode(s),i=d.document,l=f.XHTML_DTD,l.$inline[g._4e_name()]?(h=new e(i.createTextNode(" ")),h.insertAfter(j)):h?"br"==h._4e_name()&&l[h.parent()._4e_name()].p&&(l=new e("<p>&nbsp;</p>",null,i),h[0].parentNode.replaceChild(l[0],h[0]),h=l):(l=new e("<p>&nbsp;</p>",null,i),l.insertAfter(j),h=l),A.moveToPosition(j,y.POSITION_AFTER_END),h&&h[0].nodeType==z.NODE_ELEMENT&&A.moveToElementEditablePosition(h),
n.selectRanges([A]),d.focus(),g&&g._4e_scrollIntoView(),d._saveLater(),c&&c(g))}}},insertHtml:function(a,b){var d=this;if(d.getMode()===x){d.htmlDataProcessor&&(a=d.htmlDataProcessor.toDataFormat(a,null,b));d.focus();d.fire("save");var g=d.document,i=0;if(n){var j=g.selection;"Control"==j.type&&j.clear();try{j.createRange().pasteHTML(a)}catch(m){h.log("insertHtml error in ie")}}else try{g.execCommand("inserthtml",k,a)}catch(y){setTimeout(function(){if(0==d.getSelection().getRanges().length){var b=
new f.Range(g),y=c._4e_first(g.body,function(a){return 1==a[0].nodeType&&"br"!=a._4e_name()});y||(y=new e(g.createElement("p")),g.body.appendChild(y[0]));b.setStartAt(y,f.RANGE.POSITION_AFTER_START);b.select()}g.execCommand("inserthtml",k,a)},i=100)}setTimeout(function(){d.getSelection().scrollIntoView()},i);d._saveLater(i)}},_saveLater:function(a){var b=this;b.__saveTimer&&(clearTimeout(b.__saveTimer),b.__saveTimer=null);b.__saveTimer=setTimeout(function(){b.fire("save")},a||0)}});f._initIFrame=
function(d){function i(a){g(function(){p.designMode="on";setTimeout(function(){p.designMode="off";y.focus();arguments.callee.retry||(arguments.callee.retry=s)},50)},function(){p.designMode="off";c.attr(y,"contentEditable",k);c.attr(y,"contentEditable",s);!a&&i(1)})}var f=a.getInstance(d),d=f.textarea[0],m=f.iframe[0].contentWindow,p=f.document,l=f.cfg,u=p.getElementById("ke_actscript");c._4e_remove(u);var y=p.body;n?(y.hideFocus=s,y.disabled=s,y.contentEditable=s,y.removeAttribute("disabled")):setTimeout(function(){j.gecko||
j.opera?y.contentEditable=s:j.webkit?y.parentNode.contentEditable=s:p.designMode="on"},0);j.webkit&&(b.on(p,"click",function(a){var b=new e(a.target);h.inArray(b._4e_name(),["input","select"])&&a.preventDefault()}),b.on(p,"mouseup",function(a){var b=new e(a.target);h.inArray(b._4e_name(),["input","textarea"])&&a.preventDefault()}));if(j.gecko||n||j.opera){var z;z=(new e('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(d);z.on("focus",function(){f.focus()});
f.activateGecko=function(){j.gecko&&f.iframeFocus&&z[0].focus()};f.on("destroy",function(){z.detach();z.remove()})}if(j.gecko||j.opera){var C=p.documentElement;b.on(C,"mousedown",function(a){if(a.target==C){j.gecko&&i(k);z[0].focus()}})}b.on(m,"focus",function(){j.gecko?i(k):j.opera&&y.focus();f.notifySelectionChange()});if(j.gecko)b.on(f.document,"mousedown",function(){f.iframeFocus||i(k)});if(n&&(b.on(p,"keydown",function(a){if(a.keyCode in{8:1,46:1}){var b=f.getSelection(),c=b.getSelectedElement();
if(c){f.fire("save");var d=b.getRanges()[0].createBookmark();c._4e_remove();b.selectBookmarks([d]);f.fire("save");a.preventDefault()}}}),"CSS1Compat"==p.compatMode)){var H={33:1,34:1};b.on(p,"keydown",function(a){a.keyCode in H&&setTimeout(function(){f.getSelection().scrollIntoView()},0)})}setTimeout(function(){n&&setTimeout(function(){if(p){y.runtimeStyle.marginBottom="0px";y.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){f.fire("dataReady");var a=l.disableObjectResizing,c=l.disableInlineTableEditing;
if(a||c)try{p.execCommand("enableObjectResizing",k,!a);p.execCommand("enableInlineTableEditing",k,!c)}catch(d){b.on(y,n?"resizestart":"resize",function(b){var d=new e(b.target);(a||d._4e_name()==="table"&&c)&&b.preventDefault()})}},10);if(j.webkit)b.on(p,"mousedown",function(a){a=new e(a.target);h.inArray(a._4e_name(),["img","hr","input","textarea","select"])&&f.getSelection().selectElement(a)});if(j.gecko)b.on(p,"dragstart",function(a){var b=new e(a.target);b._4e_name()==="img"&&/ke_/.test(b[0].className)&&
a.preventDefault()});a.add(f)};7<i.documentMode&&function(){for(var a=h.all("link"),b=0;b<a.length;b++){var c=new e(a[b]),d=c.attr("href");-1!=d.indexOf("editor-pkg-min-mhtml.css")&&c.attr("href",d.replace(/editor-pkg-min-mhtml\.css/g,"editor-pkg-min-datauri.css"))}}()});
KISSY.Editor.add("zindex",function(){var f=KISSY.Editor;f.zIndexManager||(f.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,DD_PG:99999,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200},f.baseZIndex=function(s){return(f.Config.baseZIndex||1E4)+s},f.baseZIndex=f.baseZIndex,f.zIndexManager=f.zIndexManager)});
KISSY.Editor.add("dtd",function(f){f.XHTML_DTD=function(){function f(){for(var a=arguments[0],b=arguments.length-1;0<b;)KISSY.mix(a,arguments[b--]);return a}var k={isindex:1,fieldset:1},o={input:1,button:1,select:1,textarea:1,label:1},i=f({a:1},o),h=f({iframe:1},i),j={hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1},n={ins:1,del:1,script:1,style:1},c=f({b:1,acronym:1,bdo:1,"var":1,"#":1,abbr:1,code:1,br:1,i:1,
cite:1,kbd:1,u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1},n),e=f({sub:1,img:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1},c),b=f({p:1},e),o=f({iframe:1},e,o),e={img:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,"#":1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,"var":1,div:1,object:1,sup:1,strike:1,
dir:1,map:1,dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1},a=f({a:1},o),g={tr:1},m={"#":1},u=f({param:1},e),d=f({form:1},k,h,j,b),l={li:1},x={base:1,link:1,meta:1,title:1},r=f(x,{style:1,script:1}),v={head:1,body:1},q={address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1};return{$nonBodyContent:f({html:1},v,x),$block:q,
$blockLimit:{body:1,div:1,td:1,th:1,caption:1,form:1},$inline:a,$body:f({script:1,style:1},q),$cdata:{script:1,style:1},$empty:{area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1,bgsound:1},$listItem:{dd:1,dt:1,li:1},$list:{ul:1,ol:1,dl:1},$nonEditable:{applet:1,button:1,embed:1,iframe:1,map:1,object:1,option:1,script:1,textarea:1,param:1},$removeEmpty:{abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,
strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1},$tabIndex:{a:1,area:1,button:1,input:1,object:1,select:1,textarea:1},$tableContent:{caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1},html:v,head:r,style:m,body:d,base:{},link:{},meta:{},title:m,col:{},tr:{td:1,th:1},img:{},colgroup:{col:1},noscript:d,td:d,br:{},th:d,center:d,kbd:a,button:f(b,j),basefont:{},h5:a,h4:a,samp:a,h6:a,ol:l,h1:a,h3:a,option:m,h2:a,form:f(k,h,j,b),select:{optgroup:1,option:1},font:a,ins:a,menu:l,abbr:a,label:a,
table:{thead:1,col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1},code:a,script:m,tfoot:g,cite:a,li:d,input:{},iframe:d,strong:a,textarea:m,noframes:d,big:a,small:a,span:a,hr:{},dt:a,sub:a,optgroup:{option:1},param:{},bdo:a,"var":a,div:d,object:u,sup:a,dd:d,strike:a,area:{},dir:l,map:f({area:1,form:1,p:1},k,n,j),applet:u,dl:{dt:1,dd:1},del:a,isindex:{},fieldset:f({legend:1},e),thead:g,ul:l,acronym:a,b:a,a:o,blockquote:d,caption:a,i:a,u:a,tbody:g,s:a,address:f(h,b),tt:a,legend:a,q:a,pre:f(c,i),p:a,em:a,
dfn:a}}();f.XHTML_DTD=f.XHTML_DTD});
KISSY.Editor.add("elementpath",function(f){function s(c){for(var e=h,b=h,a=[];c;){if(c[0].nodeType==i.NODE_ELEMENT){this.lastElement||(this.lastElement=c);var g=c._4e_name();if(!b&&(!e&&j[g]&&(e=c),n[g])){var f;if(f=!e)if(f="div"==g){a:{f=c;f=k._4e_unwrap(f);f=f.childNodes;for(var u=0,d=f.length;u<d;u++){var l=f[u];if(l.nodeType==i.NODE_ELEMENT&&o.$block[l.nodeName.toLowerCase()]){f=!0;break a}}f=!1}f=!f}f?e=c:b=c}a.push(c);if("body"==g)break}c=c.parent()}this.block=e;this.blockLimit=b;this.elements=
a}var k=KISSY.DOM,o=f.XHTML_DTD,i=f.NODE,h=null,j={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},n={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};s.prototype={compare:function(c){var e=this.elements,c=c&&c.elements;if(!c||e.length!=c.length)return!1;for(var b=0;b<e.length;b++)if(!k._4e_equals(e[b],c[b]))return!1;return!0},contains:function(c){for(var e=this.elements,b=0;b<e.length;b++)if(e[b]._4e_name()in c)return e[b];return h},toString:function(){var c=
this.elements,e,b=[];for(e=0;e<c.length;e++)b.push(c[e]._4e_name());return b.toString()}};f.ElementPath=s});
KISSY.Editor.add("walker",function(f){function s(a,c){if(this._.end)return j;var d,f=this.range,n,m=this.guard,p=this.type,u=a?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start&&(this._.start=1,f.trim(),f.collapsed))return this.end(),j;if(!a&&!this._.guardLTR){var k=f.endContainer,y=new g(k[0].childNodes[f.endOffset]);this._.guardLTR=function(a,c){return(a=b._4e_wrap(a))&&a[0]&&(!c||!b._4e_equals(k,a))&&(!y[0]||!a._4e_equals(y))&&(a[0].nodeType!=e.NODE_ELEMENT||!c||"body"!=a._4e_name())}}if(a&&
!this._.guardRTL){var z=f.startContainer,C=0<f.startOffset&&new g(z[0].childNodes[f.startOffset-1]);this._.guardRTL=function(a,c){return(a=b._4e_wrap(a))&&a[0]&&(!c||!a._4e_equals(z))&&(!C[0]||!a._4e_equals(C))&&(a[0].nodeType!=e.NODE_ELEMENT||!c||"body"!=a._4e_name())}}var H=a?this._.guardRTL:this._.guardLTR;n=m?function(a,b){return H(a,b)===h?h:m(a,b)}:H;this.current?d=this.current[u](h,p,n):a?(d=f.endContainer,0<f.endOffset?(d=new g(d[0].childNodes[f.endOffset-1]),n(d)===h&&(d=j)):d=n(d,i)===h?
j:d._4e_previousSourceNode(i,p,n)):(d=f.startContainer,(d=new g(d[0].childNodes[f.startOffset]))&&d[0]?n(d)===h&&(d=j):d=n(f.startContainer,i)===h?j:f.startContainer._4e_nextSourceNode(i,p,n));for(;d&&d[0]&&!this._.end;){this.current=d;if(!this.evaluator||this.evaluator(d)!==h){if(!c)return d}else if(c&&this.evaluator)return h;d=d[u](h,p,n)}this.end();return this.current=j}function k(a){for(var b,c=j;b=s.call(this,a);)c=b;return c}function o(a){this.range=a;this._={}}var i=!0,h=!1,j=null,n=KISSY,
c=n.UA,e=f.NODE,b=n.DOM,a=f.XHTML_DTD,g=n.Node;n.augment(o,{end:function(){this._.end=1},next:function(){return s.call(this)},previous:function(){return s.call(this,i)},checkForward:function(){return s.call(this,h,i)!==h},checkBackward:function(){return s.call(this,i,i)!==h},lastForward:function(){return k.call(this)},lastBackward:function(){return k.call(this,i)},reset:function(){delete this.current;this._={}}});o.blockBoundary=function(a){return function(c){c=b._4e_wrap(c);return!(c&&c[0].nodeType==
e.NODE_ELEMENT&&c._4e_isBlockBoundary(a))}};o.bookmark=function(a,b){function c(a){return a&&a[0]&&"span"==a._4e_name()&&a.attr("_ke_bookmark")}return function(d){var g,f;g=d&&d[0]&&d[0].nodeType==e.NODE_TEXT&&(f=d.parent())&&c(f);g=a?g:g||c(d);return b^g}};o.whitespaces=function(a){return function(b){b=(b=b[0]||b)&&b.nodeType==e.NODE_TEXT&&!n.trim(b.nodeValue);return a^b}};o.invisible=function(a){var b=o.whitespaces();return function(c){c=b(c)||c[0].nodeType==e.NODE_ELEMENT&&!c[0].offsetHeight;return a^
c}};var m=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,u=o.whitespaces(),d=o.bookmark();o.getBogus=function(b){do b=b._4e_previousSourceNode();while(d(b)||u(b)||1==b[0].nodeType&&b._4e_name()in a.$inline&&!(b._4e_name()in a.$empty));return b&&(!c.ie?"br"==b._4e_name():3==b[0].nodeType&&m.test(b.text()))?b:!1};f.Walker=o});
KISSY.Editor.add("range",function(f){function s(a){this.endOffset=this.endContainer=this.startOffset=this.startContainer=e;this.collapsed=n;this.document=a}function k(c){var d=c[0].nodeType!=a.NODE_TEXT&&c._4e_name()in r.$removeEmpty,e=!b.trim(c[0].nodeValue),c=!!c.parent().attr("_ke_bookmark");return d||e||c}function o(a){return!w(a)&&!B(a)}function i(d){var e=c,g=u.bookmark(n);return function(f){if(g(f))return n;if(f[0].nodeType==a.NODE_TEXT){if(b.trim(f[0].nodeValue).length)return c}else if(f[0].nodeType==
a.NODE_ELEMENT&&!p[f._4e_name()])if(!d&&!x.ie&&"br"==f._4e_name()&&!e)e=n;else return c;return n}}function h(a,b){function c(a){return a&&"span"==a.nodeName&&a.getAttribute("_ke_bookmark")}return function(d){var e,g;e=d&&!d.nodeName&&(g=d.parentNode)&&c(g);e=a?e:e||c(d);return b^e}}function j(c){return function(d){d=(d=d[0]||d)&&d.nodeType==a.NODE_TEXT&&!b.trim(d.nodeValue);return c^d}}f.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};f.RANGE=f.RANGE;var n=!0,c=!1,e=null,b=KISSY,a=f.NODE,g=f.RANGE,m=f.POSITION,u=f.Walker,d=b.DOM,l=f.Utils.getByAddress,x=b.UA,r=f.XHTML_DTD,v=f.ElementPath,q=b.Node,t={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};s.prototype.toString=function(){var a=[];a.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);a.push((this.endContainer[0].id||this.endContainer[0].nodeName)+
":"+this.endOffset);return a.join("<br/>")};b.augment(s,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&d._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var b=this.startContainer,c=this.startOffset;b[0].nodeType!=a.NODE_ELEMENT&&(c?c>=b[0].nodeValue.length&&this.setStartAfter(b):this.setStartBefore(b));b=this.endContainer;c=this.endOffset;b[0].nodeType!=a.NODE_ELEMENT&&(c?c>=b[0].nodeValue.length&&this.setEndAfter(b):
this.setEndBefore(b))},setStartAfter:function(a){this.setStart(a.parent(),a._4e_index()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4e_index())},setEndAfter:function(a){this.setEnd(a.parent(),a._4e_index()+1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4e_index())},optimizeBookmark:function(){var a=this.startContainer,b=this.endContainer;a&&"span"==a._4e_name()&&a.attr("_ke_bookmark")&&this.setStartAt(a,g.POSITION_BEFORE_START);b&&"span"==b._4e_name()&&b.attr("_ke_bookmark")&&
this.setEndAt(b,g.POSITION_AFTER_END)},setStart:function(b,c){b[0].nodeType==a.NODE_ELEMENT&&t[b._4e_name()]&&(b=b.parent(),c=b._4e_index());this.startContainer=b;this.startOffset=c;this.endContainer||(this.endContainer=b,this.endOffset=c);this.updateCollapsed()},setEnd:function(b,c){b[0].nodeType==a.NODE_ELEMENT&&t[b._4e_name()]&&(b=b.parent(),c=b._4e_index()+1);this.endContainer=b;this.endOffset=c;this.startContainer||(this.startContainer=b,this.startOffset=c);this.updateCollapsed()},setStartAt:function(b,
c){switch(c){case g.POSITION_AFTER_START:this.setStart(b,0);break;case g.POSITION_BEFORE_END:b[0].nodeType==a.NODE_TEXT?this.setStart(b,b[0].nodeValue.length):this.setStart(b,b[0].childNodes.length);break;case g.POSITION_BEFORE_START:this.setStartBefore(b);break;case g.POSITION_AFTER_END:this.setStartAfter(b)}this.updateCollapsed()},setEndAt:function(b,c){switch(c){case g.POSITION_AFTER_START:this.setEnd(b,0);break;case g.POSITION_BEFORE_END:b[0].nodeType==a.NODE_TEXT?this.setEnd(b,b[0].nodeValue.length):
this.setEnd(b,b[0].childNodes.length);break;case g.POSITION_BEFORE_START:this.setEndBefore(b);break;case g.POSITION_AFTER_END:this.setEndAfter(b)}this.updateCollapsed()},execContentsAction:function(b,c){var e=this.startContainer,g=this.endContainer,f=this.startOffset,h=this.endOffset,i,j=this.document,p;this.optimizeBookmark();g[0].nodeType==a.NODE_TEXT?g=g._4e_splitText(h):0<g[0].childNodes.length&&(h>=g[0].childNodes.length?(g=new q(g[0].appendChild(j.createTextNode(""))),p=n):g=new q(g[0].childNodes[h]));
e[0].nodeType==a.NODE_TEXT?(e._4e_splitText(f),e._4e_equals(g)&&(g=new q(e[0].nextSibling))):f?f>=e[0].childNodes.length?(i=new q(j.createTextNode("")),e.append(i),e=i,i=n):e=new q(e[0].childNodes[f].previousSibling):(i=new q(j.createTextNode("")),e.prepend(i),e=i,i=n);var f=e._4e_parents(),h=g._4e_parents(),m,u,k;for(m=0;m<f.length&&!(u=f[m],k=h[m],!u._4e_equals(k));m++);for(var j=c,w,l,G,o=m;o<f.length;o++){w=f[o];l=j&&!w._4e_equals(e)?j.appendChild(w._4e_clone()[0]):null;for(w=w[0].nextSibling;w&&
!d._4e_equals(h[o],w)&&!d._4e_equals(g,w);)G=w.nextSibling,2==b?j.appendChild(w.cloneNode(n)):(d._4e_remove(w),1==b&&j.appendChild(w)),w=G;l&&(j=l)}for(j=c;m<h.length;m++){w=h[m];l=j&&0<b&&!w._4e_equals(g)?j.appendChild(w._4e_clone()[0]):null;if(!f[m]||!w.parent()._4e_equals(f[m].parent()))for(w=w[0].previousSibling;w&&!d._4e_equals(f[m],w)&&!d._4e_equals(e,w);)G=w.previousSibling,2==b?j.insertBefore(w.cloneNode(n),j.firstChild):(d._4e_remove(w),1==b&&j.insertBefore(w,j.firstChild)),w=G;l&&(j=l)}if(2==
b){if(k=this.startContainer[0],k.nodeType==a.NODE_TEXT&&k.nextSibling&&k.nextSibling.nodeType==a.NODE_TEXT&&(k.data+=k.nextSibling.data,k.parentNode.removeChild(k.nextSibling)),k=this.endContainer[0],k.nodeType==a.NODE_TEXT&&k.nextSibling&&k.nextSibling.nodeType==a.NODE_TEXT)k.data+=k.nextSibling.data,k.parentNode.removeChild(k.nextSibling)}else{if(u&&k&&(!e.parent()._4e_equals(u.parent())||!g.parent()._4e_equals(k.parent())))u=k._4e_index(),i&&k.parent()._4e_equals(e.parent())&&u--,this.setStart(k.parent(),
u);this.collapse(n)}i&&e._4e_remove();p&&g[0].parentNode&&g._4e_remove()},collapse:function(a){a?(this.endContainer=this.startContainer,this.endOffset=this.startOffset):(this.startContainer=this.endContainer,this.startOffset=this.endOffset);this.collapsed=n},clone:function(){var a=new s(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var b=
this.clone();b.optimize();if(b.startContainer[0].nodeType!=a.NODE_ELEMENT||b.endContainer[0].nodeType!=a.NODE_ELEMENT)return e;var c=new f.Walker(b),d=h(n,void 0),g=j(n);b.evaluator=function(a){return g(a)&&d(a)};b=c.next();c.reset();c=c.previous();return b&&b._4e_equals(c)?b:e},shrink:function(b,d){if(!this.collapsed){var b=b||g.SHRINK_TEXT,e=this.clone(),f=this.startContainer,h=this.endContainer,i=this.startOffset,j=this.endOffset,p=1,m=1;f&&f[0].nodeType==a.NODE_TEXT&&(i?i>=f[0].nodeValue.length?
e.setStartAfter(f):(e.setStartBefore(f),p=0):e.setStartBefore(f));h&&h[0].nodeType==a.NODE_TEXT&&(j?j>=h[0].nodeValue.length?e.setEndAfter(h):(e.setEndAfter(h),m=0):e.setEndBefore(h));e=new u(e);e.evaluator=function(c){c=c[0]||c;return c.nodeType==(b==g.SHRINK_ELEMENT?a.NODE_ELEMENT:a.NODE_TEXT)};var k;e.guard=function(d,e){d=d[0]||d;if(b==g.SHRINK_ELEMENT&&d.nodeType==a.NODE_TEXT||e&&d==k)return c;!e&&d.nodeType==a.NODE_ELEMENT&&(k=d);return n};p&&(f=e[b==g.SHRINK_ELEMENT?"lastForward":"next"]())&&
this.setStartAt(f,d?g.POSITION_AFTER_START:g.POSITION_BEFORE_START);m&&(e.reset(),(e=e[b==g.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(e,d?g.POSITION_BEFORE_END:g.POSITION_AFTER_END));return!(!p&&!m)}},createBookmark2:function(b){var c=this.startContainer,d=this.endContainer,g=this.startOffset,f=this.endOffset,h,i;if(!c||!d)return{start:0,end:0};if(b){if(c[0].nodeType==a.NODE_ELEMENT&&(h=new q(c[0].childNodes[g]))&&h[0]&&h[0].nodeType==a.NODE_TEXT&&0<g&&h[0].previousSibling.nodeType==
a.NODE_TEXT)c=h,g=0;for(;c[0].nodeType==a.NODE_TEXT&&(i=c._4e_previous())&&i[0].nodeType==a.NODE_TEXT;)c=i,g+=i[0].nodeValue.length;if(!this.collapsed){if(d[0].nodeType==a.NODE_ELEMENT&&(h=new q(d[0].childNodes[f]))&&h[0]&&h[0].nodeType==a.NODE_TEXT&&0<f&&h[0].previousSibling.nodeType==a.NODE_TEXT)d=h,f=0;for(;d[0].nodeType==a.NODE_TEXT&&(i=d._4e_previous())&&i[0].nodeType==a.NODE_TEXT;)d=i,f+=i[0].nodeValue.length}}return{start:c._4e_address(b),end:this.collapsed?e:d._4e_address(b),startOffset:g,
endOffset:f,normalized:b,is2:n}},createBookmark:function(a){var c,d,f,h,i=this.collapsed;c=new q("<span>",e,this.document);c.attr("_ke_bookmark",1);c.css("display","none");c.html("&nbsp;");a&&(f=b.guid("ke_bm_"),c.attr("id",f+"S"));i||(d=c._4e_clone(),d.html("&nbsp;"),a&&d.attr("id",f+"E"),h=this.clone(),h.collapse(),h.insertNode(d));h=this.clone();h.collapse(n);h.insertNode(c);d?(this.setStartAfter(c),this.setEndBefore(d)):this.moveToPosition(c,g.POSITION_AFTER_END);return{startNode:a?f+"S":c,endNode:a?
f+"E":d,serializable:a,collapsed:i}},moveToPosition:function(a,b){this.setStartAt(a,b);this.collapse(n)},trim:function(b,c){var e=this.startContainer,g=this.startOffset,f=this.collapsed;if((!b||f)&&e[0]&&e[0].nodeType==a.NODE_TEXT){if(g)if(g>=e[0].nodeValue.length)g=e._4e_index()+1,e=e.parent();else{var h=e._4e_splitText(g),g=e._4e_index()+1,e=e.parent();d._4e_equals(this.startContainer,this.endContainer)?this.setEnd(h,this.endOffset-this.startOffset):d._4e_equals(e,this.endContainer)&&(this.endOffset+=
1)}else g=e._4e_index(),e=e.parent();this.setStart(e,g);if(f){this.collapse(n);return}}e=this.endContainer;g=this.endOffset;!c&&!f&&e[0]&&e[0].nodeType==a.NODE_TEXT&&(g?(g>=e.nodeValue.length||e._4e_splitText(g),g=e._4e_index()+1):g=e._4e_index(),e=e.parent(),this.setEnd(e,g))},insertNode:function(a){this.optimizeBookmark();this.trim(c,n);var b=this.startContainer;b[0].insertBefore(a[0]||a,b[0].childNodes[this.startOffset]||null);d._4e_equals(a.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(a)},
moveToBookmark:function(a){if(a.is2){var c=l(this.document,a.start,a.normalized),d=a.startOffset,e=a.end&&l(this.document,a.end,a.normalized),a=a.endOffset;this.setStart(c,d);e?this.setEnd(e,a):this.collapse(n)}else c=(d=a.serializable)?b.one("#"+a.startNode,this.document):a.startNode,a=d?b.one("#"+a.endNode,this.document):a.endNode,this.setStartBefore(c),c._4e_remove(),a&&a[0]?(this.setEndBefore(a),a._4e_remove()):this.collapse(n)},getCommonAncestor:function(b,c){var e=this.startContainer,g=this.endContainer,
e=d._4e_equals(e,g)?b&&e[0].nodeType==a.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new q(e[0].childNodes[this.startOffset]):e:e._4e_commonAncestor(g);return c&&e[0].nodeType==a.NODE_TEXT?e.parent():e},enlarge:function(f){switch(f){case g.ENLARGE_ELEMENT:if(this.collapsed)break;var f=this.getCommonAncestor(),h=new q(this.document.body),i,j,p,m,k,w=c,l,o;l=this.startContainer;o=this.startOffset;if(l[0].nodeType==a.NODE_TEXT){if(o&&(l=!b.trim(l[0].nodeValue.substring(0,o)).length&&l,w=!!l),l&&
!(m=l[0].previousSibling))p=l.parent()}else o&&(m=l[0].childNodes[o-1]||l[0].lastChild),m||(p=l);for(;p||m;){if(p&&!m){!k&&d._4e_equals(p,f)&&(k=n);if(!h.contains(p))break;if(!w||"inline"!=p.css("display"))w=c,k?i=p:this.setStartBefore(p);m=p[0].previousSibling}for(;m;){l=c;if(m.nodeType==a.NODE_TEXT)o=m.nodeValue,/[^\s\ufeff]/.test(o)&&(m=e),l=/[\s\ufeff]$/.test(o);else if((0<m.offsetWidth||"br"==d._4e_name(m))&&!m.getAttribute("_ke_bookmark"))if(w&&r.$removeEmpty[m.nodeName.toLowerCase()]){o=d.text(m);
if(/[^\s\ufeff]/.test(o))m=e;else for(var t=m.all||m.getElementsByTagName("*"),B=0,x;x=t[B++];)if(!r.$removeEmpty[x.nodeName.toLowerCase()]){m=e;break}m&&(l=!!o.length)}else m=e;l&&(w?k?i=p:p&&this.setStartBefore(p):w=n);if(m){l=m.previousSibling;if(!p&&!l){p=new q(m);m=e;break}m=l}else p=e}p&&(p=p.parent())}l=this.endContainer;o=this.endOffset;p=m=e;k=w=c;if(l[0].nodeType==a.NODE_TEXT){if(l=!b.trim(l[0].nodeValue.substring(o)).length&&l,w=!(l&&l[0].nodeValue.length),l&&!(m=l[0].nextSibling))p=l.parent()}else(m=
l[0].childNodes[o])||(p=l);for(;p||m;){if(p&&!m){!k&&d._4e_equals(p,f)&&(k=n);if(!h.contains(p))break;if(!w||"inline"!=p.css("display"))w=c,k?j=p:p&&this.setEndAfter(p);m=p[0].nextSibling}for(;m;){l=c;if(m.nodeType==a.NODE_TEXT)o=m.nodeValue,/[^\s\ufeff]/.test(o)&&(m=e),l=/^[\s\ufeff]/.test(o);else if((0<m.offsetWidth||"br"==d._4e_name(m))&&!m.getAttribute("_ke_bookmark"))if(w&&r.$removeEmpty[m.nodeName.toLowerCase()]){o=d.text(m);if(/[^\s\ufeff]/.test(o))m=e;else{t=m.all||m.getElementsByTagName("*");
for(B=0;x=t[B++];)if(!r.$removeEmpty[x.nodeName.toLowerCase()]){m=e;break}}m&&(l=!!o.length)}else m=e;l&&w&&(k?j=p:this.setEndAfter(p));if(m){l=m.nextSibling;if(!p&&!l){p=new q(m);m=e;break}m=l}else p=e}p&&(p=p.parent())}i&&j&&(f=i.contains(j)?j:i,this.setStartBefore(f),this.setEndAfter(f));break;case g.ENLARGE_BLOCK_CONTENTS:case g.ENLARGE_LIST_ITEM_CONTENTS:p=new s(this.document);h=new q(this.document.body);p.setStartAt(h,g.POSITION_AFTER_START);p.setEnd(this.startContainer,this.startOffset);p=
new u(p);var v,G,P=u.blockBoundary(f==g.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:e),L=function(a){var b=P(a);b||(v=a);return b};i=function(a){var b=L(a);!b&&a[0]&&"br"==a._4e_name()&&(G=a);return b};p.guard=L;p=p.lastBackward();v=v||h;this.setStartAt(v,"br"!=v._4e_name()&&(!p&&this.checkStartOfBlock()||p&&v.contains(p))?g.POSITION_AFTER_START:g.POSITION_AFTER_END);p=this.clone();p.collapse();p.setEndAt(h,g.POSITION_BEFORE_END);p=new u(p);p.guard=f==g.ENLARGE_LIST_ITEM_CONTENTS?i:L;v=e;p=p.lastForward();
v=v||h;this.setEndAt(v,!p&&this.checkEndOfBlock()||p&&v.contains(p)?g.POSITION_BEFORE_END:g.POSITION_BEFORE_START);G&&this.setEndAfter(G)}},checkStartOfBlock:function(){var d=this.startContainer,e=this.startOffset;if(e&&d[0].nodeType==a.NODE_TEXT&&b.trim(d[0].nodeValue.substring(0,e)).length)return c;this.trim();d=new v(this.startContainer);e=this.clone();e.collapse(n);e.setStartAt(d.block||d.blockLimit,g.POSITION_AFTER_START);d=new u(e);d.evaluator=i(n);return d.checkBackward()},checkEndOfBlock:function(){var d=
this.endContainer,e=this.endOffset;if(d[0].nodeType==a.NODE_TEXT&&b.trim(d[0].nodeValue.substring(e)).length)return c;this.trim();d=new v(this.endContainer);e=this.clone();e.collapse(c);e.setEndAt(d.block||d.blockLimit,g.POSITION_BEFORE_END);d=new u(e);d.evaluator=i(c);return d.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var a=this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,a);return a},checkBoundaryOfElement:function(a,
b){var c=this.clone();c[b==g.START?"setStartAt":"setEndAt"](a,b==g.START?g.POSITION_AFTER_START:g.POSITION_BEFORE_END);c=new u(c);c.evaluator=k;return c[b==g.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var b=this.startContainer,c=this.endContainer,d=this.startOffset,e=this.endOffset,g;if(b[0].nodeType==a.NODE_ELEMENT)if(g=b[0].childNodes.length,g>d)b=new q(b[0].childNodes[d]);else if(1>g)b=b._4e_previousSourceNode();else{for(b=b[0];b.lastChild;)b=b.lastChild;b=new q(b);b=
b._4e_nextSourceNode()||b}if(c[0].nodeType==a.NODE_ELEMENT)if(g=c[0].childNodes.length,g>e)c=(new q(c[0].childNodes[e]))._4e_previousSourceNode(n);else if(1>g)c=c._4e_previousSourceNode();else{for(c=c[0];c.lastChild;)c=c.lastChild;c=new q(c)}b._4e_position(c)&m.POSITION_FOLLOWING&&(b=c);return{startNode:b,endNode:c}},fixBlock:function(a,b){var c=this.createBookmark(),d=new q(this.document.createElement(b));this.collapse(a);this.enlarge(g.ENLARGE_BLOCK_CONTENTS);d[0].appendChild(this.extractContents());
d._4e_trim();x.ie||d._4e_appendBogus();this.insertNode(d);this.moveToBookmark(c);return d},splitBlock:function(a){var f=new v(this.startContainer),h=new v(this.endContainer),i=f.block,p=h.block,m=e;if(!f.blockLimit._4e_equals(h.blockLimit))return e;"br"!=a&&(i||(i=this.fixBlock(n,a),p=(new v(this.endContainer)).block),p||(p=this.fixBlock(c,a)));a=i&&this.checkStartOfBlock();f=p&&this.checkEndOfBlock();this.deleteContents();i&&d._4e_equals(i,p)&&(f?(m=new v(this.startContainer),this.moveToPosition(p,
g.POSITION_AFTER_END),p=e):a?(m=new v(this.startContainer),this.moveToPosition(i,g.POSITION_BEFORE_START),i=e):(p=this.splitElement(i),!x.ie&&!b.inArray(i._4e_name(),["ul","ol"])&&i._4e_appendBogus()));return{previousBlock:i,nextBlock:p,wasStartOfBlock:a,wasEndOfBlock:f,elementPath:m}},splitElement:function(a){if(!this.collapsed)return e;this.setEndAt(a,g.POSITION_BEFORE_END);var b=this.extractContents(),d=a._4e_clone(c);d[0].appendChild(b);d.insertAfter(a);this.moveToPosition(a,g.POSITION_AFTER_END);
return d},moveToElementEditablePosition:function(b,d){var e,h=f.XHTML_DTD;if(h.$empty[b._4e_name()])return c;for(;b&&b[0].nodeType==a.NODE_ELEMENT;){if(e=b._4e_isEditable())this.moveToPosition(b,d?g.POSITION_BEFORE_END:g.POSITION_AFTER_START);else if(h.$inline[b._4e_name()])return this.moveToPosition(b,d?g.POSITION_AFTER_END:g.POSITION_BEFORE_START),n;if((b=h.$empty[b._4e_name()]?b[d?"_4e_previous":"_4e_next"](o):d?b._4e_last(o):b._4e_first(o))&&b[0].nodeType==a.NODE_TEXT)return this.moveToPosition(b,
d?g.POSITION_AFTER_END:g.POSITION_BEFORE_START),n}return e},selectNodeContents:function(b){this.setStart(b,0);this.setEnd(b,b[0].nodeType==a.NODE_TEXT?b[0].nodeValue.length:b[0].childNodes.length)}});var p={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1},w=new u.whitespaces,B=new u.bookmark;f.Range=s});
KISSY.Editor.add("domiterator",function(f){function s(a){1>arguments.length||(this.range=a,this.forceBrBreak=o,this.enlargeBr=k,this.enforceRealBlocks=o,this._||(this._={}))}var k=!0,o=!1,i=KISSY,h=i.UA,j=f.Walker,n=f.Range,c=f.RANGE,e=f.NODE,b=f.ElementPath,a=i.Node,g=i.DOM,m=/^[\r\n\t ]*$/;i.augment(s,{getNextParagraph:function(f){var d,l,s,r,v;if(!this._.lastNode){l=this.range.clone();l.shrink(c.SHRINK_ELEMENT,k);l.enlarge(this.forceBrBreak||!this.enlargeBr?c.ENLARGE_LIST_ITEM_CONTENTS:c.ENLARGE_BLOCK_CONTENTS);
var q=new j(l),t=j.bookmark(k,k);q.evaluator=t;this._.nextNode=q.next();q=new j(l);q.evaluator=t;q=q.previous();this._.lastNode=q._4e_nextSourceNode(k);this._.lastNode&&this._.lastNode[0].nodeType==e.NODE_TEXT&&!i.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()&&(t=new n(l.document),t.moveToPosition(this._.lastNode,c.POSITION_AFTER_END),t.checkEndOfBlock()&&(t=new b(t.endContainer),this._.lastNode=(t.block||t.blockLimit)._4e_nextSourceNode(k)));this._.lastNode||
(this._.lastNode=this._.docEndMarker=new a(l.document.createTextNode("")),g.insertAfter(this._.lastNode[0],q[0]));l=null}t=this._.nextNode;q=this._.lastNode;for(this._.nextNode=null;t;){var p=o,w=t[0].nodeType!=e.NODE_ELEMENT,B=o;if(w)t[0].nodeType==e.NODE_TEXT&&m.test(t[0].nodeValue)&&(w=o);else{var y=t._4e_name();if(t._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if("br"==y)w=k;else if(!l&&!t[0].childNodes.length&&"hr"!=y){d=t;s=t._4e_equals(q);break}l&&(l.setEndAt(t,c.POSITION_BEFORE_START),
"br"!=y&&(this._.nextNode=t));p=k}else{if(t[0].firstChild){l||(l=new n(this.range.document),l.setStartAt(t,c.POSITION_BEFORE_START));t=new a(t[0].firstChild);continue}w=k}}w&&!l&&(l=new n(this.range.document),l.setStartAt(t,c.POSITION_BEFORE_START));s=(!p||w)&&t._4e_equals(q);if(l&&!p)for(;!t[0].nextSibling&&!s;){y=t.parent();if(y._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){p=k;s||y._4e_equals(q);break}t=y;w=k;s=t._4e_equals(q);B=k}w&&l.setEndAt(t,c.POSITION_AFTER_END);t=t._4e_nextSourceNode(B,
null,q);if((s=!t)||p&&l)break}if(!d){if(!l)return this._.docEndMarker&&this._.docEndMarker._4e_remove(),this._.nextNode=null;d=new b(l.startContainer);t=d.blockLimit;p={div:1,th:1,td:1};d=d.block;if((!d||!d[0])&&!this.enforceRealBlocks&&p[t._4e_name()]&&l.checkStartOfBlock()&&l.checkEndOfBlock())d=t;else if(!d||this.enforceRealBlocks&&"li"==d._4e_name())d=new a(this.range.document.createElement(f||"p")),d[0].appendChild(l.extractContents()),d._4e_trim(),l.insertNode(d),r=v=k;else if("li"!=d._4e_name()){if(!l.checkStartOfBlock()||
!l.checkEndOfBlock())d=d._4e_clone(o),d[0].appendChild(l.extractContents()),d._4e_trim(),v=l.splitBlock(),r=!v.wasStartOfBlock,v=!v.wasEndOfBlock,l.insertNode(d)}else s||(this._.nextNode=d._4e_equals(q)?null:l.getBoundaryNodes().endNode._4e_nextSourceNode(k,null,q))}r&&(l=new a(d[0].previousSibling),l[0]&&l[0].nodeType==e.NODE_ELEMENT&&("br"==l._4e_name()?l._4e_remove():l[0].lastChild&&"br"==g._4e_name(l[0].lastChild)&&g._4e_remove(l[0].lastChild)));v&&(l=j.bookmark(o,k),r=new a(d[0].lastChild),r[0]&&
r[0].nodeType==e.NODE_ELEMENT&&"br"==r._4e_name()&&(h.ie||r._4e_previous(l)||r._4e_next(l))&&r._4e_remove());this._.nextNode||(this._.nextNode=s||d._4e_equals(q)?null:d._4e_nextSourceNode(k,null,q));return d}});n.prototype.createIterator=function(){return new s(this)}});
KISSY.Editor.add("selection",function(f){function s(a){this.document=this.document=a;this._={cache:{}};if(d)try{var b=this.getNative().createRange();if(!b||b.item&&b.item(0).ownerDocument!=a||b.parentElement&&b.parentElement().ownerDocument!=a)this.isInvalid=i}catch(c){this.isInvalid=i}}function k(a){a=new s(a);return!a||a.isInvalid?j:a}function o(d){function m(a){var b=f.XHTML_DTD;return a._4e_isBlockBoundary()&&b.$empty[a._4e_name()]}function k(a){return J(a)&&K(a)}var l=d.document,o=e._4e_getWin(l),
q=new a(l.body),s=new a(l.documentElement);if(c.ie){if(8>f.Utils.ieEngine)s.on("click",function(b){"html"===(new a(b.target))._4e_name()&&d.getSelection().getNative().createRange().select()});(function(){function a(b,c){var d=g.createTextRange();try{d.moveToPoint(b,c)}catch(e){d=null}return d}function c(){var a=l.selection.createRange();f&&!a.item&&0===a.compareEndPoints("StartToEnd",a)&&f.select();b.remove(l,"mouseup",c);b.remove(l,"mousemove",d);f=e=0;x(i)}function d(b){if(b.button){if(b=a(b.pageX,
b.pageY))0<b.compareEndPoints("StartToStart",f)?b.setEndPoint("StartToStart",f):b.setEndPoint("EndToEnd",f),b.select()}else c()}var e,g=q[0],f;l.documentElement.unselectable=!0;b.on(l,"mousedown contextmenu",function(g){if(g.target===s[0]&&(e&&c(),!(s[0].scrollHeight>s[0].clientHeight)&&(n.log("fix ie cursor"),e=1,f=a(g.pageX,g.pageY))))b.on(l,"mouseup",c),b.on(l,"mousemove",d),o.focus(),f.select()})})();var t,r,v=i;s.on("mousedown",function(){v=h});s.on("mouseup",function(){v=i});q.on("focusin",
function(b){if("body"==(new a(b.target))._4e_name()&&t){try{v&&t.select()}catch(c){}t=j}});q.on("focus",function(){r=i;x()});q.on("beforedeactivate",function(a){a.relatedTarget||(r=h,v=i)});d.on("blur",function(){try{var a=document.documentElement||document.body,b=a.scrollTop,c=a.scrollLeft;l&&l.selection.empty();a.scrollTop=b;a.scrollLeft=c}catch(d){}});q.on("mousedown",function(){r=h});q.on("mouseup",function(){r=i;setTimeout(function(){x(i)},0)});var x=function(a){if(r){var b=d.document,c=d.getSelection(),
e=c&&c.getType(),f=c&&b.selection;if(a&&f&&e==g.SELECTION_NONE&&!b.queryCommandEnabled("InsertImage"))setTimeout(function(){x(i)},50);else{var h;if(!f||!f.type||!("Control"!=f.type&&(h=f.createRange())&&(h=h.parentElement())&&(h=h.nodeName)&&h.toLowerCase()in{input:1,textarea:1}))t=f&&c.getRanges()[0],d._monitor()}}};q.on("keydown",function(){r=h});q.on("keyup",function(){r=i;setTimeout(function(){x()},0)})}else b.on(l,"mouseup",d._monitor,d),b.on(l,"keyup",d._monitor,d);var I=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,
J=f.Walker.whitespaces(i),K=f.Walker.bookmark(h,i),E=function(a){return J(a)&&a&&8!=a[0].nodeType};d.on("selectionChange",function(b){var e=b.path,b=(b=b.selection)&&b.getRanges()[0],g=e.blockLimit;if(c.gecko){var j=e.block||e.blockLimit,n=j&&j._4e_last(k);j&&j._4e_isBlockBoundary()&&(!n||!(1==n[0].nodeType&&n._4e_isBlockBoundary()))&&"pre"!=j._4e_name()&&!j._4e_getBogus()&&j._4e_appendBogus()}if(b&&b.collapsed&&!e.block){if("body"==g._4e_name()){if((e=b.fixBlock(i,"p"))&&e[0]!=q[0].lastChild&&e._4e_outerHtml().match(I))if((g=
e._4e_next(E))&&g[0].nodeType==u.NODE_ELEMENT&&!m[g])b.moveToElementEditablePosition(g),e._4e_remove();else if((g=e._4e_previous(E))&&g[0].nodeType==u.NODE_ELEMENT&&!m[g])b.moveToElementEditablePosition(g,g._4e_outerHtml().match(I)?h:i),e._4e_remove();b.select();d.notifySelectionChange()}e=new f.Range(l);e.moveToElementEditablePosition(q,i);"body"!==(new f.ElementPath(e.startContainer)).blockLimit._4e_name()&&(e=(new a(l.createElement("p"))).appendTo(q),c.ie||e._4e_appendBogus())}})}f.SELECTION={SELECTION_NONE:1,
SELECTION_TEXT:2,SELECTION_ELEMENT:3};var i=!0,h=!1,j=null,n=KISSY,c=n.UA,e=n.DOM,b=n.Event,a=n.Node,g=f.SELECTION,m=f.RANGE,u=f.NODE,d=c.ie,l=f.Walker,x=f.Range,r={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};n.augment(s,{getNative:!d?function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=e._4e_getWin(this.document).getSelection())}:function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=
this.document.selection)},getType:!d?function(){var a=this._.cache;if(a.type)return a.type;var b=g.SELECTION_TEXT,c=this.getNative();if(c){if(1==c.rangeCount){var c=c.getRangeAt(0),d=c.startContainer;d==c.endContainer&&d.nodeType==u.NODE_ELEMENT&&1==Number(c.endOffset-c.startOffset)&&r[d.childNodes[c.startOffset].nodeName.toLowerCase()]&&(b=g.SELECTION_ELEMENT)}}else b=g.SELECTION_NONE;return a.type=b}:function(){var a=this._.cache;if(a.type)return a.type;var b=g.SELECTION_NONE;try{var c=this.getNative(),
d=c.type;"Text"==d&&(b=g.SELECTION_TEXT);"Control"==d&&(b=g.SELECTION_ELEMENT);c.createRange().parentElement&&(b=g.SELECTION_TEXT)}catch(e){}return a.type=b},getRanges:d?function(){var b=function(a,b){a=a.duplicate();a.collapse(b);for(var c=a.parentElement(),d=c.childNodes,e,g=0;g<d.length;g++){var f=d[g];if(f.nodeType==u.NODE_ELEMENT){e=a.duplicate();e.moveToElementText(f);var f=e.compareEndPoints("StartToStart",a),i=e.compareEndPoints("EndToStart",a);e.collapse();if(0<f)break;else{if(!f||1==i&&
-1==f)return{container:c,offset:g};if(!i)return{container:c,offset:g+1}}e=j}}e||(e=a.duplicate(),e.moveToElementText(c),e.collapse(h));e.setEndPoint("StartToStart",a);e=(""+e.text).replace(/\r\n|\r/g,"\n").length;try{for(;0<e;)e-=d[--g].nodeValue.length}catch(m){e=0}return 0===e?{container:c,offset:g}:{container:d[g],offset:-e}};return function(c){var d=this._.cache;if(d.ranges&&!c)return d.ranges;var e=this.getNative(),c=e&&e.createRange(),f=this.getType();if(!e)return[];if(f==g.SELECTION_TEXT)return e=
new x(this.document),f=b(c,i),e.setStart(new a(f.container),f.offset),f=b(c),e.setEnd(new a(f.container),f.offset),d.ranges=[e];if(f==g.SELECTION_ELEMENT){d=d.ranges=[];for(f=0;f<c.length;f++){for(var h=c.item(f),m=h.parentNode,j=0,e=new x(this.document);j<m.childNodes.length&&m.childNodes[j]!=h;j++);e.setStart(new a(m),j);e.setEnd(new a(m),j+1);d.push(e)}return d}return d.ranges=[]}}():function(b){var c=this._.cache;if(c.ranges&&!b)return c.ranges;var b=[],d=this.getNative();if(!d)return[];for(var e=
0;e<d.rangeCount;e++){var g=d.getRangeAt(e),f=new x(this.document);f.setStart(new a(g.startContainer),g.startOffset);f.setEnd(new a(g.endContainer),g.endOffset);b.push(f)}return c.ranges=b},getStartElement:function(){var b=this._.cache;if(void 0!==b.startElement)return b.startElement;var c,f=this.getNative();switch(this.getType()){case g.SELECTION_ELEMENT:return this.getSelectedElement();case g.SELECTION_TEXT:var h=this.getRanges()[0];if(h&&!h.collapsed){for(h.optimize();i;)if(c=h.startContainer,
h.startOffset==(c[0].nodeType===u.NODE_ELEMENT?c[0].childNodes.length:c[0].nodeValue.length)&&!c._4e_isBlockBoundary())h.setStartAfter(c);else break;c=h.startContainer;if(c[0].nodeType!=u.NODE_ELEMENT)return c.parent();c=new a(c[0].childNodes[h.startOffset]);if(!c[0]||c[0].nodeType!=u.NODE_ELEMENT)return h.startContainer;for(h=c[0].firstChild;h&&h.nodeType==u.NODE_ELEMENT;)c=new a(h),h=h.firstChild;return c}if(d)h=f.createRange(),h.collapse(i),c=h.parentElement();else if((c=f.anchorNode)&&c.nodeType!=
u.NODE_ELEMENT)c=c.parentNode}return b.startElement=c?e._4e_wrap(c):j},getSelectedElement:function(){var a,b=this._.cache;if(void 0!==b.selectedElement)return b.selectedElement;d&&(a=this.getNative().createRange(),a=a.item&&a.item(0));if(!a){a=this.getRanges()[0];for(var c,g,f=2;f&&(!(c=a.getEnclosedNode())||!(c[0].nodeType==u.NODE_ELEMENT&&r[c._4e_name()]&&(g=c)));f--)a.shrink(m.SHRINK_ELEMENT);a=g&&g[0]}return b.selectedElement=e._4e_wrap(a)},reset:function(){this._.cache={}},selectElement:function(a){var b,
c=this.document;if(d)try{b=c.body.createControlRange(),b.addElement(a[0]),b.select()}catch(e){b=c.body.createTextRange(),b.moveToElementText(a[0]),b.select()}finally{}else b=c.createRange(),b.selectNode(a[0]),a=this.getNative(),a.removeAllRanges(),a.addRange(b);this.reset()},selectRanges:function(a){if(d){if(1<a.length){var b=a[a.length-1];a[0].setEnd(b.endContainer,b.endOffset);a.length=1}a[0]&&a[0].select()}else{b=this.getNative();if(!b)return;b.removeAllRanges();for(var e=0;e<a.length;e++){var g=
a[e],f=this.document.createRange(),h=g.startContainer;if(g.collapsed&&(c.gecko&&1.09>c.gecko||c.opera||c.webkit)&&h[0].nodeType==u.NODE_ELEMENT&&!h[0].childNodes.length)h[0].appendChild(this.document.createTextNode(c.webkit?"\u200b":"")),g.startOffset++,g.endOffset++;f.setStart(h[0],g.startOffset);f.setEnd(g.endContainer[0],g.endOffset);b.addRange(f)}}this.reset()},createBookmarks2:function(a){for(var b=[],c=this.getRanges(),d=0;d<c.length;d++)b.push(c[d].createBookmark2(a));return b},createBookmarks:function(a,
b){for(var c=[],d=this.document,g,b=b||this.getRanges(),f=b.length,h=0;h<f;h++){c.push(g=b[h].createBookmark(a,i));var m=(a=g.serializable)?n.one("#"+g.startNode,d):g.startNode;g=a?n.one("#"+g.endNode,d):g.endNode;for(var j=h+1;j<f;j++){var l=b[j],k=l.startContainer,o=l.endContainer;e._4e_equals(k,m.parent())&&l.startOffset++;e._4e_equals(k,g.parent())&&l.startOffset++;e._4e_equals(o,m.parent())&&l.endOffset++;e._4e_equals(o,g.parent())&&l.endOffset++}}return c},selectBookmarks:function(a){for(var b=
[],c=0;c<a.length;c++){var d=new x(this.document);d.moveToBookmark(a[c]);b.push(d)}this.selectRanges(b);return this},getCommonAncestor:function(){var a=this.getRanges();return a[0].startContainer._4e_commonAncestor(a[a.length-1].endContainer)},scrollIntoView:function(){var a=this.getStartElement();a&&a._4e_scrollIntoView()},removeAllRanges:function(){var a=this.getNative();d?a&&a.clear():a&&a.removeAllRanges()}});var v={table:1,tbody:1,tr:1},q=l.whitespaces(i),t=/\ufeff|\u00a0/;x.prototype.select=
x.prototype.select=!d?function(){var a=this.startContainer;this.collapsed&&a[0].nodeType==u.NODE_ELEMENT&&!a[0].childNodes.length&&a[0].appendChild(this.document.createTextNode(""));var b=this.document.createRange();b.setStart(a[0],this.startOffset);try{b.setEnd(this.endContainer[0],this.endOffset)}catch(c){if(0<=c.toString().indexOf("NS_ERROR_ILLEGAL_VALUE"))this.collapse(i),b.setEnd(this.endContainer[0],this.endOffset);else throw c;}a=k(this.document).getNative();a.removeAllRanges();a.addRange(b)}:
function(b){var c=this.collapsed,d,g;if(this.startContainer[0]===this.endContainer[0]&&1==this.endOffset-this.startOffset){var f=this.startContainer[0].childNodes[this.startOffset];if(f.nodeType==u.NODE_ELEMENT){(new s(this.document)).selectElement(new a(f));return}}(this.startContainer[0].nodeType==u.NODE_ELEMENT&&this.startContainer._4e_name()in v||this.endContainer[0].nodeType==u.NODE_ELEMENT&&this.endContainer._4e_name()in v)&&this.shrink(m.SHRINK_ELEMENT,i);var h=this.createBookmark(),f=h.startNode,
j;c||(j=h.endNode);h=this.document.body.createTextRange();h.moveToElementText(f[0]);h.moveStart("character",1);if(j)b=this.document.body.createTextRange(),b.moveToElementText(j[0]),h.setEndPoint("EndToEnd",b),h.moveEnd("character",-1);else{for(d=f[0].nextSibling;d&&!q(d);)d=d.nextSibling;d=!(d&&d.nodeValue&&d.nodeValue.match(t))&&(b||!f[0].previousSibling||f[0].previousSibling&&"br"==e._4e_name(f[0].previousSibling));g=new a(this.document.createElement("span"));g.html("&#65279;");g.insertBefore(f);
d&&e.insertBefore(this.document.createTextNode("\ufeff"),f[0]||f)}this.setStartBefore(f);f._4e_remove();if(c){if(d?(h.moveStart("character",-1),h.select(),this.document.selection.clear()):h.select(),g)this.moveToPosition(g,m.POSITION_BEFORE_START),g._4e_remove()}else this.setEndBefore(j),j._4e_remove(),h.select()};s.getSelection=k;f.Selection=s;f.on("instanceCreated",function(a){o(a.editor)})});
KISSY.Editor.add("styles",function(f){function s(a){return!a.attr("_ke_bookmark")}function k(a,b){for(var c in a)a.hasOwnProperty(c)&&(w.isString(a[c])?a[c]=a[c].replace(O,function(a,c){return b[c]}):k(a[c],b))}function o(a,b){b&&(a=w.clone(a),k(a,b));var c=this.element=this.element=(a.element||"*").toLowerCase();this.type=this.type="#"==c||K[c]?z.STYLE_BLOCK:E[c]?z.STYLE_OBJECT:z.STYLE_INLINE;this._={definition:a}}function i(a,b){var c=b?this.removeFromRange:this.applyToRange;a.body.focus();for(var d=
new H(a),e=d.getRanges(),g=0;g<e.length;g++)c.call(this,e[g]);d.selectRanges(e)}function h(a,b,c){var d=a.element;"*"==d&&(d="span");b=new F(b.createElement(d));c&&c._4e_copyAttributes(b);c=a._.definition;a=c.attributes;c=o.getStyleText(c);if(a)for(var e in a)a.hasOwnProperty(e)&&b.attr(e,a[e]);c&&(b[0].style.cssText=c);return b}function j(a){var b=a.createBookmark(q),d=a.createIterator();d.enforceRealBlocks=q;d.enlargeBr=q;for(var g,f=a.document;g=d.getNextParagraph();){var i=h(this,f,g),m=i,i="pre"==
m._4e_name,j="pre"==g._4e_name,l=!i&&j;i&&!j?(j=g,l=j.html(),l=n(l,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,""),l=l.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1"),l=l.replace(/([ \t\n\r]+|&nbsp;)/g," "),l=l.replace(/<br\b[^>]*>/gi,"\n"),I.ie?(j=j[0].ownerDocument.createElement("div"),j.appendChild(m[0]),m[0].outerHTML="<pre>"+l+"</pre>",m=new F(j.firstChild),m._4e_remove()):m.html(l)):l?m=e(c(g),m):g._4e_moveChildren(m);g[0].parentNode.replaceChild(m[0],g[0]);if(i&&(g=m,i=void 0,(i=g._4e_previousSourceNode(q,
D.NODE_ELEMENT))&&"pre"==i._4e_name()))m=n(i.html(),/\n$/,"")+"\n\n"+n(g.html(),/^\n/,""),I.ie?g[0].outerHTML="<pre>"+m+"</pre>":g.html(m),i._4e_remove()}a.moveToBookmark(b)}function n(a,b,c){var d="",e="",a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(a,b,c){b&&(d=b);c&&(e=c);return""});return d+a.replace(b,c)+e}function c(a){var b=[];n(a._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(a,b,c){return b+"</pre>"+
c+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(a,c){b.push(c)});return b}function e(a,b){for(var c=b[0].ownerDocument.createDocumentFragment(),d=0;d<a.length;d++){var e=a[d],e=e.replace(/(\r\n|\r)/g,"\n"),e=n(e,/^[ \t]*\n/,""),e=n(e,/\n$/,""),e=n(e,/^[ \t]+|[ \t]+$/g,function(a,b){return 1==a.length?"&nbsp;":b?" "+Array(a.length).join("&nbsp;"):Array(a.length).join("&nbsp;")+" "}),e=e.replace(/\n/g,"<br>"),e=e.replace(/[ \t]{2,}/g,function(a){return Array(a.length).join("&nbsp;")+" "}),
g=b._4e_clone();g.html(e);c.appendChild(g[0])}return c}function b(a){var b=a.document;if(a.collapsed)b=h(this,b,void 0),a.insertNode(b),a.moveToPosition(b,C.POSITION_BEFORE_END);else{var c=this.element,d=this._.definition,e,g=f.XHTML_DTD[c];g||(e=q,g=f.XHTML_DTD.span);var i=a.createBookmark();a.enlarge(C.ENLARGE_ELEMENT);a.trim();for(var m=a.createBookmark(),j=m.startNode,m=m.endNode,l=j,n;l&&l[0];){var k=t;if(y._4e_equals(l,m))l=p,k=q;else{var o=l[0].nodeType,u=o==D.NODE_ELEMENT?l._4e_name():p;if(u&&
l.attr("_ke_bookmark")){l=l._4e_nextSourceNode(q);continue}if(!u||g[u]&&(l._4e_position(m)|A.POSITION_PRECEDING|A.POSITION_IDENTICAL|A.POSITION_IS_CONTAINED)==A.POSITION_PRECEDING+A.POSITION_IDENTICAL+A.POSITION_IS_CONTAINED&&(!d.childRule||d.childRule(l))){var r=l.parent();if(r&&"a"==c&&r._4e_name()==c)o=h(this,b,void 0),r._4e_moveChildren(o),r[0].parentNode.replaceChild(o[0],r[0]),o._4e_mergeSiblings();else if(r&&r[0]&&((f.XHTML_DTD[r._4e_name()]||f.XHTML_DTD.span)[c]||e)&&(!d.parentRule||d.parentRule(r))){if(!n&&
(!u||!f.XHTML_DTD.$removeEmpty[u]||(l._4e_position(m)|A.POSITION_PRECEDING|A.POSITION_IDENTICAL|A.POSITION_IS_CONTAINED)==A.POSITION_PRECEDING+A.POSITION_IDENTICAL+A.POSITION_IS_CONTAINED))n=new N(b),n.setStartBefore(l);if(o==D.NODE_TEXT||o==D.NODE_ELEMENT&&!l[0].childNodes.length){r=l;for(o=null;(k=!r._4e_next(s))&&(o=r.parent())&&g[o._4e_name()]&&(o._4e_position(j)|A.POSITION_FOLLOWING|A.POSITION_IDENTICAL|A.POSITION_IS_CONTAINED)==A.POSITION_FOLLOWING+A.POSITION_IDENTICAL+A.POSITION_IS_CONTAINED&&
(!d.childRule||d.childRule(o));)r=o;n.setEndAfter(r)}}else k=q}else k=q;l=l._4e_nextSourceNode()}if(k&&n&&!n.collapsed){for(var k=h(this,b,void 0),r=n.getCommonAncestor(),o={},u={},v,z=null,w;k&&r&&k[0]&&r[0];){if(r._4e_name()==c){for(v in d.attributes)if(d.attributes.hasOwnProperty(v)&&!u[v]&&(w=r.attr(z)))k.attr(v)==w?k.removeAttr(v):u[v]=1;for(z in d.styles)if(d.styles.hasOwnProperty(z)&&!o[z]&&(w=r._4e_style(z)))k._4e_style(z)==w?k._4e_style(z,""):o[z]=1;if(!k._4e_hasAttributes()){k=p;break}}r=
r.parent()}k?(k[0].appendChild(n.extractContents()),x(this,k),n.insertNode(k),k._4e_mergeSiblings(),I.ie||k[0].normalize()):(k=new F(b.createElement("span")),k[0].appendChild(n.extractContents()),n.insertNode(k),x(this,k),k._4e_remove(!0));n=p}}j._4e_remove();m._4e_remove();a.moveToBookmark(i);a.shrink(C.SHRINK_TEXT)}}function a(a){a.enlarge(C.ENLARGE_ELEMENT);var b=a.createBookmark(),c=b.startNode;if(a.collapsed){for(var e=new J(c.parent()),g,f=0,h;f<e.elements.length&&(h=e.elements[f])&&!(h==e.block||
h==e.blockLimit);f++)if(this.checkElementRemovable(h)){var i=a.checkBoundaryOfElement(h,C.END),m=!i&&a.checkBoundaryOfElement(h,C.START);m||i?(g=h,g.match=m?"start":"end"):(h._4e_mergeSiblings(),h._4e_name()!=this.element?(i=u(this),r(h,i[h._4e_name()]||i["*"])):d(this,h))}if(g&&g[0]){h=c;for(f=0;;f++){i=e.elements[f];if(y._4e_equals(i,g))break;else if(i.match)continue;else i=i._4e_clone();i[0].appendChild(h[0]);h=i}y["start"==g.match?"insertBefore":"insertAfter"](y._4e_unwrap(h),y._4e_unwrap(g))}}else{var j=
b.endNode,l=this,e=function(){for(var a=new J(c.parent()),b=new J(j.parent()),d=p,e=p,g=0;g<a.elements.length;g++){var f=a.elements[g];if(f==a.block||f==a.blockLimit)break;l.checkElementRemovable(f)&&(d=f)}for(g=0;g<b.elements.length;g++){f=b.elements[g];if(f==b.block||f==b.blockLimit)break;l.checkElementRemovable(f)&&(e=f)}e&&j._4e_breakParent(e);d&&c._4e_breakParent(d)};e();for(g=new F(c[0].nextSibling);g[0]!==j[0];){f=g._4e_nextSourceNode();if(g[0]&&g[0].nodeType==D.NODE_ELEMENT&&this.checkElementRemovable(g)&&
(g._4e_name()==this.element?d(this,g):(h=u(this),r(g,h[g._4e_name()]||h["*"])),f[0].nodeType==D.NODE_ELEMENT&&f.contains(c)))e(),f=new F(c[0].nextSibling);g=f}}a.moveToBookmark(b)}function g(a){var b={};(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,c,d){b[c]=d});return b}function m(a,b){var c="";b!==t?(c=document.createElement("span"),c.style.cssText=a,c=c.style.cssText||""):c=a;return c.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,
",").toLowerCase()}function u(a){if(a._.overrides)return a._.overrides;var b=a._.overrides={},c=a._.definition.overrides;if(c){w.isArray(c)||(c=[c]);for(var d=0;d<c.length;d++){var e=c[d],g,f,h;"string"==typeof e?g=e.toLowerCase():(g=e.element?e.element.toLowerCase():a.element,f=e.attributes,h=e.styles);e=b[g]||(b[g]={});if(f){g=e.attributes=e.attributes||[];for(var i in f)f.hasOwnProperty(i)&&g.push([i.toLowerCase(),f[i]])}if(h){var e=e.styles=e.styles||[],m;for(m in h)h.hasOwnProperty(m)&&e.push([m.toLowerCase(),
h[m]])}}}return b}function d(a,b){var c=a._.definition,d=u(a),e=B.mix(c.attributes,(d[b._4e_name()]||d["*"]||{}).attributes),c=B.mix(c.styles,(d[b._4e_name()]||d["*"]||{}).styles),d=w.isEmptyObject(e)&&w.isEmptyObject(c),g;for(g in e)if(e.hasOwnProperty(g)&&!(("class"==g||a._.definition.fullMatch)&&b.attr(g)!=l(g,e[g])))d=d||!!b._4e_hasAttribute(g),b.removeAttr(g);for(var f in c)c.hasOwnProperty(f)&&!(a._.definition.fullMatch&&b._4e_style(f)!=l(f,c[f],q))&&(d=d||!!b._4e_style(f),b._4e_style(f,""));
v(b)}function l(a,b,c){var d=new F("<span>");d[c?"_4e_style":"attr"](a,b);return d[c?"_4e_style":"attr"](a)}function x(a,b){for(var c=u(a),e=b.all(a.element),g=e.length;0<=--g;)d(a,new F(e[g]));for(var f in c)if(c.hasOwnProperty(f)&&f!=a.element){e=b.all(f);for(g=e.length-1;0<=g;g--){var h=new F(e[g]);r(h,c[f])}}}function r(a,b){var c,d=b&&b.attributes;if(d)for(c=0;c<d.length;c++){var e=d[c][0],g;if(g=a.attr(e)){var f=d[c][1];(f===p||f.test&&f.test(g)||"string"==typeof f&&g==f)&&a[0].removeAttribute(e)}}if(d=
b&&b.styles)for(c=0;c<d.length;c++)if(e=d[c][0],f=a.css(e)){var h=d[c][1];(h===p||h.test&&h.test(g)||"string"==typeof h&&f==h)&&a.css(e,"")}v(a)}function v(a){if(!a._4e_hasAttributes()){var b=a[0].firstChild,c=a[0].lastChild;a._4e_remove(q);b&&(b.nodeType==D.NODE_ELEMENT&&y._4e_mergeSiblings(b),c&&b!=c&&c.nodeType==D.NODE_ELEMENT&&y._4e_mergeSiblings(c))}}var q=!0,t=!1,p=null,w=KISSY,B=f.Utils,y=w.DOM,z={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},C=f.RANGE,H=f.Selection,D=f.NODE,A=f.POSITION,N=
f.Range,F=w.Node,I=w.UA,J=f.ElementPath,K={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},E={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},M=/\s*(?:;\s*|$)/g,O=/#\((.+?)\)/g;f.STYLE=z;o.prototype={apply:function(a){i.call(this,a,t)},remove:function(a){i.call(this,a,q)},applyToRange:function(a){return(this.applyToRange=this.type==z.STYLE_INLINE?b:this.type==z.STYLE_BLOCK?j:p).call(this,a)},removeFromRange:function(b){return(this.removeFromRange=
this.type==z.STYLE_INLINE?a:p).call(this,b)},checkElementRemovable:function(a,b){if(!a)return t;var c=this._.definition,d;if(a._4e_name()==this.element){if(!b&&!a._4e_hasAttributes())return q;var e=c._AC;if(e)c=e;else{var e={},f=0,h=c.attributes;if(h)for(var i in h)h.hasOwnProperty(i)&&(f++,e[i]=h[i]);if(h=o.getStyleText(c))e.style||f++,e.style=h;e._length=f;c=c._AC=e}if(c._length){for(var j in c)if("_length"!=j&&c.hasOwnProperty(j)){f=a.attr(j)||"";if("style"==j)a:{e=c[j];f=m(f,t);"string"==typeof e&&
(e=g(e));"string"==typeof f&&(f=g(f));h=void 0;for(h in e)if(e.hasOwnProperty(h)&&!(h in f&&(f[h]==e[h]||"inherit"==e[h]||"inherit"==f[h]))){e=t;break a}e=q}else e=c[j]==f;if(e){if(!b)return q}else if(b)return t}if(b)return q}else return q}j=u(this);if(j=j[a._4e_name()]||j["*"]){if(!(c=j.attributes)&&!(d=j.styles))return q;if(c)for(e=0;e<c.length;e++)if(j=c[e][0],j=a.attr(j))if(f=c[e][1],f===p||"string"==typeof f&&j==f||f.test&&f.test(j))return q;if(d)for(e=0;e<d.length;e++)if(j=a.css(d[e][0]))if(c=
d[e][1],c===p||"string"==typeof c&&j==c||c.test&&c.test(j))return q}return t},checkActive:function(a){switch(this.type){case z.STYLE_BLOCK:return this.checkElementRemovable(a.block||a.blockLimit,q);case z.STYLE_OBJECT:case z.STYLE_INLINE:for(var b=a.elements,c=0,d;c<b.length;c++)if(d=b[c],!(this.type==z.STYLE_INLINE&&(y._4e_equals(d,a.block)||y._4e_equals(d,a.blockLimit))))if((this.type!=z.STYLE_OBJECT||d._4e_name()in E)&&this.checkElementRemovable(d,q))return q}return t}};o.getStyleText=function(a){var b=
a._ST;if(b)return b;var b=a.styles,c=a.attributes&&a.attributes.style||"",d="";c.length&&(c=c.replace(M,";"));for(var e in b)if(b.hasOwnProperty(e)){var g=b[e],f=(e+":"+g).replace(M,";");"inherit"==g?d+=f:c+=f}c.length&&(c=m(c));return a._ST=c+d};f.Style=o});
KISSY.Editor.add("htmlparser",function(){function f(){this._={htmlPartsRegex:RegExp("<(?:(?:\\/([^>]+)>)|(?:!--([\\S|\\s]*?)--\>)|(?:([^\\s>]+)\\s*((?:(?:[^\"'>]+)|(?:\"[^\"]*\")|(?:'[^']*'))*)\\/?>))","g")}}var s=KISSY,k=function(){},o=s.Editor,i=/([\w\-:.]+)(?:(?:\s*=\s*(?:(?:"([^"]*)")|(?:'([^']*)')|([^\s>]+)))|(?=\s|$))/g,h={checked:1,compact:1,declare:1,defer:1,disabled:1,ismap:1,multiple:1,nohref:1,noresize:1,noshade:1,nowrap:1,readonly:1,selected:1},j=o.XHTML_DTD;s.augment(f,{onTagOpen:k,onTagClose:k,
onText:k,onCDATA:k,onComment:k,parse:function(f){for(var c,e,b=0,a;c=this._.htmlPartsRegex.exec(f);){e=c.index;if(e>b)if(b=f.substring(b,e),a)a.push(b);else this.onText(b);b=this._.htmlPartsRegex.lastIndex;if(e=c[1])if(e=e.toLowerCase(),a&&j.$cdata[e]&&(this.onCDATA(a.join("")),a=null),!a){this.onTagClose(e);continue}if(a)a.push(c[0]);else if(e=c[3]){if(e=e.toLowerCase(),!/="/.test(e)){var g={},m;c=c[4];var k=!!(c&&"/"==c.charAt(c.length-1));if(c)for(;m=i.exec(c);){var d=m[1].toLowerCase();m=m[2]||
m[3]||m[4]||"";g[d]=!m&&h[d]?d:m}this.onTagOpen(e,g,k);!a&&j.$cdata[e]&&(a=[])}}else if(e=c[2])this.onComment(e)}if(f.length>b)this.onText(f.substring(b,f.length))}});o.HtmlParser=f;o.HtmlParser=f});
KISSY.Editor.add("htmlparser-basicwriter",function(){function f(){this._={output:[]}}var s=KISSY,k=s.Editor,o=k.Utils;s.augment(f,{openTag:function(f){this._.output.push("<",f)},openTagClose:function(f,h){h?this._.output.push(" />"):this._.output.push(">")},attribute:function(f,h){"string"==typeof h&&(h=o.htmlEncodeAttr(h));this._.output.push(" ",f,'="',h,'"')},closeTag:function(f){this._.output.push("</",f,">")},text:function(f){this._.output.push(f)},comment:function(f){this._.output.push("<\!--",
f,"--\>")},write:function(f){this._.output.push(f)},reset:function(){this._.output=[];this._.indent=!1},getHtml:function(f){var h=this._.output.join("");f&&this.reset();return h}});k.HtmlParser.BasicWriter=f});
KISSY.Editor.add("htmlparser-htmlwriter",function(){function f(){f.superclass.constructor.call(this);this.indentationChars="\t";this.selfClosingEnd=" />";this.lineBreakChars="\n";this.forceSimpleAmpersand=h;this.sortAttributes=i;this._.indent=h;this._.indentation="";this._.rules={};var j=k.XHTML_DTD,n;for(n in o.mix({},j.$nonBodyContent,j.$block,j.$listItem,j.$tableContent))this.setRules(n,{indent:i,breakBeforeOpen:i,breakAfterOpen:i,breakBeforeClose:!j[n]["#"],breakAfterClose:i});this.setRules("br",
{breakAfterOpen:i});this.setRules("title",{indent:h,breakAfterOpen:h});this.setRules("style",{indent:h,breakBeforeClose:i});this.setRules("pre",{indent:h})}var s=KISSY,k=s.Editor,o=k.Utils,i=!0,h=!1;s.extend(f,k.HtmlParser.BasicWriter,{openTag:function(f){var h=this._.rules[f];this._.indent?this.indentation():h&&h.breakBeforeOpen&&(this.lineBreak(),this.indentation());this._.output.push("<",f)},openTagClose:function(f,h){var c=this._.rules[f];h?this._.output.push(this.selfClosingEnd):(this._.output.push(">"),
c&&c.indent&&(this._.indentation+=this.indentationChars));c&&c.breakAfterOpen&&this.lineBreak()},attribute:function(f,h){"string"==typeof h&&(this.forceSimpleAmpersand&&(h=h.replace(/&amp;/g,"&")),h=o.htmlEncodeAttr(h));this._.output.push(" ",f,'="',h,'"')},closeTag:function(f){var h=this._.rules[f];h&&h.indent&&(this._.indentation=this._.indentation.substr(this.indentationChars.length));this._.indent?this.indentation():h&&h.breakBeforeClose&&(this.lineBreak(),this.indentation());this._.output.push("</",
f,">");h&&h.breakAfterClose&&this.lineBreak()},text:function(f){this._.indent&&(this.indentation(),f=o.ltrim(f));this._.output.push(f)},comment:function(f){this._.indent&&this.indentation();this._.output.push("<\!--",f,"--\>")},lineBreak:function(){0<this._.output.length&&this._.output.push(this.lineBreakChars);this._.indent=i},indentation:function(){this._.output.push(this._.indentation);this._.indent=h},setRules:function(f,h){var c=this._.rules[f];c?o.mix(c,h):this._.rules[f]=h}});k.HtmlParser.HtmlWriter=
f});
KISSY.Editor.add("htmlparser-fragment",function(){function f(){this.children=[];this.parent=o;this._={isBlockLike:s,hasInlineStarted:k}}var s=!0,k=!1,o=null,i=KISSY.Editor,h={colgroup:1,dd:1,dt:1,li:1,option:1,p:1,td:1,tfoot:1,th:1,thead:1,tr:1},j=KISSY,n=i.Utils,c=i.NODE,e=i.XHTML_DTD;n.mix({table:1,ul:1,ol:1,dl:1},e.table,e.ul,e.ol,e.dl);var b=e.$list,a=e.$listItem;f.FromHtml=function(g,m){function o(a){var b;if(0<v.length)for(var c=0;c<v.length;c++){var g=v[c],f=g.name,h=e[f],i=t.name&&e[t.name];if((!i||
i[f])&&(!a||!h||h[a]||!e[a]))b||(d(),b=1),g=g.clone(),g.parent=t,t=g,v.splice(c,1),c--}}function d(){for(;q.length;)t.add(q.shift())}function l(a,b,d){b=b||t||r;if(m&&!b.type){var g,f;if((g=a.attributes&&(f=a.attributes._ke_real_element_type)?f:a.name)&&!(g in e.$body)&&!(g in e.$nonBodyContent))f=t,t=b,x.onTagOpen({li:"ul",dt:"dl",dd:"dl"}[g]||m,{}),b=t,d&&(t=f)}if(a._.isBlockLike&&"pre"!=a.name){d=a.children.length;g=a.children[d-1];var h;g&&g.type==c.NODE_TEXT&&((h=n.rtrim(g.value))?g.value=h:
a.children.length=d-1)}b.add(a);a.returnPoint&&(t=a.returnPoint,delete a.returnPoint)}var x=new i.HtmlParser,r=new f,v=[],q=[],t=r,p=k,w;x.onTagOpen=function(c,g,f){var m=new i.HtmlParser.Element(c,g);m.isUnknown&&f&&(m.isEmpty=s);if(e.$removeEmpty[c]&&j.isEmptyObject(g))v.push(m);else{if("pre"===""+c)p=s;else if("br"===""+c&&p){t.add(new i.HtmlParser.Text("\n"));return}if("br"===""+c)q.push(m);else{var n=t.name,r=n&&(e[n]||(t._.isBlockLike?e.div:e.span));if(r&&!m.isUnknown&&!t.isUnknown&&!r[c]){var r=
k,y;c in b&&n in b?(n=t.children,(n=n[n.length-1])&&n.name in a||l(n=new i.HtmlParser.Element("li"),t),w=t,y=n):c==n?l(t,t.parent):(l(t,t.parent,s),!h[n]&&n in e.$inline&&v.unshift(t),r=s);t=y?y:t.returnPoint||t.parent;if(r){x.onTagOpen.apply(this,arguments);return}}o(c);d();m.parent=t;m.returnPoint=w;w=0;m.isEmpty?l(m):t=m}}};x.onTagClose=function(a){for(var b=v.length-1;0<=b;b--)if(a==v[b].name){v.splice(b,1);return}for(var c=[],e=[],g=t;g.type&&g.name!=a;)g._.isBlockLike||e.unshift(g),c.push(g),
g=g.parent;if(g.type){for(b=0;b<c.length;b++){var f=c[b];l(f,f.parent)}t=g;"pre"==t.name&&(p=k);g._.isBlockLike&&d();l(g,g.parent);g==t&&(t=t.parent);v=v.concat(e)}"body"==a&&(m=k)};x.onText=function(a){if(!t._.hasInlineStarted&&!p&&(a=n.ltrim(a),0===a.length))return;d();o();if(m&&(!t.type||"body"==t.name)&&n.trim(a))this.onTagOpen(m,{});p||(a=a.replace(/[\t\r\n ]{2,}|[\t\r\n]/g," "));t.add(new i.HtmlParser.Text(a))};x.onCDATA=function(a){t.add(new i.HtmlParser.cdata(a))};x.onComment=function(a){t.add(new i.HtmlParser.Comment(a))};
x.parse(g);for(d();t.type;){var B=t.parent,y=t;if(m&&(!B.type||"body"==B.name)&&!e.$body[y.name])t=B,x.onTagOpen(m,{}),B=t;B.add(y);t=B}return r};j.augment(f,{add:function(a){var b=this.children.length;if(b=0<b&&this.children[b-1]||o){if(a._.isBlockLike&&b.type==c.NODE_TEXT&&(b.value=n.rtrim(b.value),0===b.value.length)){this.children.pop();this.add(a);return}b.next=a}a.previous=b;a.parent=this;this.children.push(a);this._.hasInlineStarted=a.type==c.NODE_TEXT||a.type==c.NODE_ELEMENT&&!a._.isBlockLike},
writeHtml:function(a,b){var c;this.filterChildren=this.filterChildren=function(){var a=new i.HtmlParser.BasicWriter;this.writeChildrenHtml.call(this,a,b,s);a=a.getHtml();this.children=(new f.FromHtml(a)).children;c=1};!this.name&&b&&b.onFragment(this);this.writeChildrenHtml(a,c?o:b)},writeChildrenHtml:function(a,b){for(var c=0;c<this.children.length;c++)this.children[c].writeHtml(a,b)}});i.HtmlParser.Fragment=f});
KISSY.Editor.add("htmlparser-element",function(){function f(f,h){this.name=f;this.attributes=h||(h={});this.children=[];var j=h._ke_real_element_type||f,k=s.XHTML_DTD,j=!(!k.$nonBodyContent[j]&&!k.$block[j]&&!k.$listItem[j]&&!k.$tableContent[j]&&!(k.$nonEditable[j]||"br"==j)),c=!!k.$empty[f];this.isEmpty=c;this.isUnknown=!k[f];this._={isBlockLike:j,hasInlineStarted:c||!j}}var s=KISSY.Editor,k=s.NODE,o=function(f,h){f=f[0];h=h[0];return f<h?-1:f>h?1:0};KISSY.augment(f,{type:k.NODE_ELEMENT,add:s.HtmlParser.Fragment.prototype.add,
clone:function(){return new f(this.name,this.attributes)},writeHtml:function(f,h){var j=this.attributes,n=this,c=n.name,e,b,a,g;n.filterChildren=function(){if(!g){var a=new s.HtmlParser.BasicWriter;s.HtmlParser.Fragment.prototype.writeChildrenHtml.call(n,a,h);n.children=(new s.HtmlParser.Fragment.FromHtml(a.getHtml())).children;g=1}};n.filterChildren=n.filterChildren;if(h){for(;;){if(!(c=h.onElementName(c)))return;n.name=c;if(!(n=h.onElement(n)))return;n.parent=this.parent;if(n.name==c)break;if(n.type!=
k.NODE_ELEMENT){n.writeHtml(f,h);return}c=n.name;if(!c){this.writeChildrenHtml.call(n,f,g?null:h);return}}j=n.attributes}f.openTag(c,j);for(var m=[],u=0;2>u;u++)for(e in j)if(b=e,a=j[e],1==u)m.push([e,a]);else if(h){for(;;)if(b=h.onAttributeName(e))if(b!=e)delete j[e],e=b;else break;else{delete j[e];break}b&&(!1===(a=h.onAttribute(n,b,a))?delete j[b]:j[b]=a)}f.sortAttributes&&m.sort(o);j=m.length;for(u=0;u<j;u++)e=m[u],f.attribute(e[0],e[1]);f.openTagClose(c,n.isEmpty);n.isEmpty||(this.writeChildrenHtml.call(n,
f,g?null:h),f.closeTag(c))},writeChildrenHtml:function(f,h){s.HtmlParser.Fragment.prototype.writeChildrenHtml.apply(this,arguments)}});s.HtmlParser.Element=f});
KISSY.Editor.add("htmlparser-filter",function(){function f(b){this._={elementNames:[],attributeNames:[],elements:{$length:0},attributes:{$length:0}};b&&this.addRules(b,10)}function s(b,a){for(var c=0;b&&c<a.length;c++)var e=a[c],b=b.replace(e[0],e[1]);return b}function k(b,a,c){"function"==typeof a&&(a=[a]);var e,f;f=b.length;var d=a&&a.length;if(d){for(e=0;e<f&&b[e].pri<c;e++);for(f=d-1;0<=f;f--)if(d=a[f])d.pri=c,b.splice(e,0,d)}}function o(b,a,c){if(a)for(var e in a){var f=b[e];b[e]=i(f,a[e],c);
f||b.$length++}}function i(b,a,c){if(a)return a.pri=c,b?(b.splice?k(b,a,c):(b=b.pri>c?[a,b]:[b,a],b.filter=h),b):a.filter=a}function h(b){for(var a=b.type||b instanceof n.HtmlParser.Fragment,c=0;c<this.length;c++){if(a)var f=b.type,h=b.name;var d=this[c].apply(window,arguments);if(d===e)return d;if(a){if(d&&(d.name!=h||d.type!=f))return d}else if("string"!=typeof d)return d;void 0!=d&&(b=d)}return b}var j=KISSY,n=j.Editor,c=n.NODE,e=!1;j.augment(f,{addRules:function(b,a){"number"!=typeof a&&(a=10);
k(this._.elementNames,b.elementNames,a);k(this._.attributeNames,b.attributeNames,a);o(this._.elements,b.elements,a);o(this._.attributes,b.attributes,a);this._.text=i(this._.text,b.text,a)||this._.text;this._.comment=i(this._.comment,b.comment,a)||this._.comment;this._.root=i(this._.root,b.root,a)||this._.root},onElementName:function(b){return s(b,this._.elementNames)},onAttributeName:function(b){return s(b,this._.attributeNames)},onText:function(b){var a=this._.text;return a?a.filter(b):b},onComment:function(b,
a){var c=this._.comment;return c?c.filter(b,a):b},onFragment:function(b){var a=this._.root;return a?a.filter(b):b},onElement:function(b){for(var a=[this._.elements["^"],this._.elements[b.name],this._.elements.$],c,f=0;3>f;f++)if(c=a[f]){c=c.filter(b,this);if(c===e)return null;if(c&&c!=b)return this.onNode(c);if(b.parent&&!b.name)break}return b},onNode:function(b){var a=b.type;return a==c.NODE_ELEMENT?this.onElement(b):a==c.NODE_TEXT?new n.HtmlParser.Text(this.onText(b.value)):null},onAttribute:function(b,
a,c){if(a=this._.attributes[a]){b=a.filter(c,b,this);if(b===e)return e;if("undefined"!=typeof b)return b}return c}});n.HtmlParser.Filter=f});KISSY.Editor.add("htmlparser-text",function(){function f(f){this.value=f;this._={isBlockLike:o}}var s=KISSY,k=s.Editor,o=!1;s.augment(f,{type:k.NODE.NODE_TEXT,writeHtml:function(f,h){var j=this.value;(!h||(j=h.onText(j,this)))&&f.text(j)}});k.HtmlParser.Text=f;k.HtmlParser.Text=f});
KISSY.Editor.add("htmlparser-cdata",function(f){f.HtmlParser.cdata=function(f){this.value=f};f.HtmlParser.cdata.prototype={type:f.NODE.NODE_TEXT,writeHtml:function(f){f.write(this.value)}}});
KISSY.Editor.add("htmlparser-comment",function(){function f(f){this.value=f;this._={isBlockLike:!1}}var s=KISSY.Editor,k=s.NODE;s.HtmlParser.Comment=f;s.HtmlParser.Comment=f;f.prototype={constructor:f,type:k.NODE_COMMENT,writeHtml:function(f,i){var h=this.value;if(i){if(!(h=i.onComment(h,this)))return;if("string"!=typeof h){h.parent=this.parent;h.writeHtml(f,i);return}}f.comment(h)}}});
KISSY.Editor.add("button",function(){function f(f){return f&&-1==f.indexOf("<")?f:0}var s=KISSY,k=s.Editor,o=s.require("uibase");if(k.TripleButton)s.log("TripleButton attach twice","warn");else{var i=o.create([o.Box.Render||o.Box],{_updateHref:function(){this.get("el").attr("href","javascript:void('"+(f(this.get("text"))||f(this.get("title")))+"')")},bindUI:function(){var f=this,i=f.get("el");i.on("click",f._action,f);i.on("mousedown",function(){"off"==f.get("state")&&i.addClass("ke-triplebutton-active")});
i.on("mouseup mouseleave",function(){"off"==f.get("state")&&i.hasClass("ke-triplebutton-active")&&setTimeout(function(){i.removeClass("ke-triplebutton-active")},300)})},_uiSetTitle:function(){this.get("el").attr("title",this.get("title"));this._updateHref()},_uiSetContentCls:function(f){var i=this.get("el");void 0!==f&&(i.html("<span class='ke-toolbar-item "+f+"' />"),i._4e_unselectable())},_uiSetText:function(f){this.get("el").html(f);this._updateHref()},_uiSetState:function(f){this["_"+f]()},disable:function(){this._savedState=
this.get("state");this.set("state","disabled")},enable:function(){"disabled"==this.get("state")&&this.set("state",this._savedState)},_action:function(f){this.fire(this.get("state")+"Click",{TripleEvent:f});this.fire("click",{TripleClickType:this.get("state")+"Click"});f&&f.preventDefault()},bon:function(){this.set("state","on")},boff:function(){this.set("state","off")},_on:function(){var f=this.get("el");f.removeClass("ke-triplebutton-off ke-triplebutton-disabled");f.addClass("ke-triplebutton-on")},
_off:function(){var f=this.get("el");f.removeClass("ke-triplebutton-on ke-triplebutton-disabled");f.addClass("ke-triplebutton-off")},_disabled:function(){var f=this.get("el");f.removeClass("ke-triplebutton-off ke-triplebutton-on");f.addClass("ke-triplebutton-disabled")}},{ATTRS:{state:{value:"off"},elCls:{value:"ke-triplebutton ke-triplebutton-off"},elTagName:{value:"a"},title:{},contentCls:{},text:{}}});i.ON="on";i.OFF="off";i.DISABLED="disabled";i.ON_CLASS="ke-triplebutton-on";i.OFF_CLASS="ke-triplebutton-off";
i.DISABLED_CLASS="ke-triplebutton-disabled";k.TripleButton=i;k.prototype.addButton=function(f,j){var n=this,c=new i({render:n.toolBarDiv,autoRender:!0,title:j.title,text:j.text,contentCls:j.contentCls}),e={name:f,btn:c,editor:n,cfg:j,call:function(){var b=s.makeArray(arguments),a=b.shift();return j[a].apply(e,b)},reload:function(b){s.mix(j,b);c.enable();n.on("selectionChange",function(){n.getMode()!=k.SOURCE_MODE&&j.selectionChange&&j.selectionChange.apply(e,arguments)});c.on("click",function(a){var b=
a.TripleClickType;j[b]&&j[b].apply(e,arguments);a&&a.halt()});j.mode==k.WYSIWYG_MODE&&(n.on("wysiwygmode",c.enable,c),n.on("sourcemode",c.disable,c));j.init&&j.init.call(e)},destroy:function(){j.destroy&&j.destroy.call(e);c.destroy()}};j.loading?c.disable():e.reload(void 0);return e}}},{attach:!1});
KISSY.Editor.add("select",function(){function f(b){f.superclass.constructor.call(this,b);this._init()}function s(b){return b&&-1==b.indexOf("<")?b:0}var k=KISSY,o=k.Node,i=k.Event,h=k.DOM,j=k.Editor;if(j.Select)k.log("ke select attach more");else{f.DISABLED=0;f.ENABLED=1;var n=j.XHTML_DTD;f.ATTRS={showValue:{},el:{},cls:{},container:{},doc:{},value:{},width:{},title:{},items:{},emptyText:{},align:{value:["l","b"]},menuContainer:{valueFn:function(){for(var b=this.el.parent();b;){var a=b._4e_name();
if(n[a]&&n[a].div)return b;b=b.parent()}return new o(document.body)}},state:{value:1}};f.decorate=function(b){for(var a=b.width(),c=[],e=b.all("option"),i=0;i<e.length;i++){var d=e[i];c.push({name:h.html(d),value:h.attr(d,"value")})}return new f({width:a+"px",title:b.attr("title"),el:b,items:c,cls:"ke-combox",value:b.val()})};var c=j.Utils.addRes,e=j.Utils.destroyRes;k.extend(f,k.Base,{_init:function(){var b=this.get("container"),a=this.get("el"),c=new o("<span class='ke-select-wrap'><a class='ke-select'><span class='ke-select-text'><span class='ke-select-text-inner'></span></span><span class='ke-select-drop-wrap'><span class='ke-select-drop'></span></span></a></span>"),
e=c.one("a"),f=this.get("title")||"",d=this.get("cls"),h=c.one(".ke-select-text"),i=c.one(".ke-select-text-inner");c.one(".ke-select-drop");void 0!==this.get("value")?i.html(this._findNameByV(this.get("value"))):i.html(f);h.css("width",this.get("width"));c._4e_unselectable();f&&c.attr("title",f);e.attr("href","javascript:void('"+s(f)+"')");d&&c.addClass(d);a?a[0].parentNode.replaceChild(c[0],a[0]):b&&c.appendTo(b);c.on("click",this._click,this);this.el=c;this.title=i;this._focusA=c.one("a.ke-select");
j.Utils.lazyRun(this,"_prepare","_real");this.on("afterValueChange",this._valueChange,this);this.on("afterStateChange",this._stateChange,this)},_findNameByV:function(b){var a=this.get("title")||"",c=this.get("items");if(this.get("showValue"))return b||a;for(var e=0;e<c.length;e++){var f=c[e];if(f.value==b){a=f.name;break}}return a},_valueChange:function(b){this.title.html(this._findNameByV(b.newVal))},_itemsChange:function(b){var a,b=b.newVal,c=this._selectList;c.html("");if(b&&b.length)for(a=0;a<
b.length;a++){var e=b[a];(new o("<a class='ke-select-menu-item' href='javascript:void(\""+s(e.name)+"\")' data-value='"+e.value+"'>"+e.name+"</a>",e.attrs)).appendTo(c)._4e_unselectable()}else(a=this.get("emptyText"))&&(new o("<a class='ke-select-menu-item' href='javascript:void(\""+s(a)+"\")'>"+a+"</a>")).appendTo(c)._4e_unselectable();this.as=c.all("a")},val:function(b){return void 0!==b?(this.set("value",b),this):this.get("value")},_resize:function(){this.menu.get("visible")&&this._real()},_prepare:function(){function b(a){a=
new o(a.target);!e.contains(a)&&!e._4e_equals(a)&&d.hide()}var a=this,e=a.el,f=a.get("popUpWidth"),h=a._focusA,d=new j.Overlay({autoRender:!0,render:a.get("menuContainer"),content:"<div>",focus4e:!1,elCls:"ke-menu",width:f?f:e.width(),zIndex:j.baseZIndex(j.zIndexManager.SELECT),focusMgr:!1}),l=a.get("items");c.call(a,d);f=d.get("contentEl").one("div");a.menu=d;i.on(window,"resize",a._resize,a);c.call(a,function(){i.remove(window,"resize",a._resize,a)});a.get("title")&&(new o("<div class='ke-menu-title ke-select-menu-item' style='margin-top:-6px;' >"+
a.get("title")+"</div>")).appendTo(f);a._selectList=(new o("<div>")).appendTo(f);a._itemsChange({newVal:l});d.on("show",function(){h.addClass("ke-select-active")});d.on("hide",function(){h.removeClass("ke-select-active")});i.on(document,"click",b);c.call(a,function(){i.remove(document,"click",b)});if(a.get("doc"))i.on(a.get("doc"),"click",b);f.on("click",a._select,a);a.as=a._selectList.all("a");i.on(f[0],"mouseenter",function(){a.as.removeClass("ke-menu-selected")});c.call(a,f);a.on("afterItemsChange",
a._itemsChange,a);a.menuNode=f},_stateChange:function(b){var a=this.el;1==b.newVal?a.removeClass("ke-select-disabled"):a.addClass("ke-select-disabled")},enable:function(){this.set("state",1)},disable:function(){this.set("state",0)},_select:function(b){b&&b.halt();var a=this.menu,c=this.menuNode;if((b=(new o(b.target))._4e_ascendant(function(a){return c.contains(a)&&"a"==a._4e_name()},!0))&&b._4e_hasAttribute("data-value")){var e=this.get("value"),f=b.attr("data-value");this.set("value",f);this.fire("click",
{newVal:f,prevVal:e,name:b.html()});a.hide()}},_real:function(){var b=this.el,a=b.offset(),c=k.clone(a),e=this.menu.get("el").height(),f=this.menu.get("el").width(),d=h.scrollTop(),i=h.scrollLeft(),j=h.viewportHeight(),n=h.viewportWidth(),n=i+n-60,j=d+j,o=a.top+(b.height()-2),b=a.left+b.width()-2,q=this.get("align"),s=q[0];"b"==q[1]?(a.top=o,a.top+e>j&&c.top-d>j-o&&(a.top=c.top-e)):(a.top=c.top-e,a.top<d&&c.top-d<j-o&&(a.top=o));"l"==s?a.left+f>n&&b-i>n-c.left&&(a.left=b-f):(a.left=b-f,a.left<i&&
b-i<n-c.left&&(a.left=c.left));this.menu.set("xy",[a.left,a.top]);this.menu.show()},_click:function(b){if(!this.loading){b&&b.preventDefault();var a=this,b=a.el,c=a.get("value");b.hasClass("ke-select-disabled")||(a._focusA.hasClass("ke-select-active")?a.menu&&a.menu.hide():(a.loading=!0,j.use("overlay",function(){a.loading=!1;a.fire("select");a._prepare();c&&a.menu&&a.as.each(function(a){a.attr("data-value")==c?a.addClass("ke-menu-selected"):a.removeClass("ke-menu-selected")})})))}},destroy:function(){e.call(this);
this.el.detach();this.el.remove()}});j.Select=f;j.prototype.addSelect=function(b,a){var c=this,a=k.mix({container:c.toolBarDiv,doc:c.document,menuContainer:new o(document.body)},a),e=new f(a),h={name:b,btn:e,editor:c,cfg:a,call:function(){var b=k.makeArray(arguments),c=b.shift();return a[c].apply(h,b)},reload:function(b){k.mix(a,b);e.enable();c.on("selectionChange",function(){c.getMode()!=j.SOURCE_MODE&&a.selectionChange&&a.selectionChange.apply(h,arguments)});e.on("click",function(b){var c=b.type;
a[c]&&a[c].apply(h,arguments);b&&b.halt()});a.mode==j.WYSIWYG_MODE&&(c.on("wysiwygmode",e.enable,e),c.on("sourcemode",e.disable,e));a.init&&a.init.call(h)},destroy:function(){a.destroy&&a.destroy.call(h);e.destroy()}};a.loading?e.disable():h.reload(void 0);return h}}},{attach:!1});
