KISSY.Editor.add("selection",function(m){function s(a){this.document=this.document=a;this._={cache:{}};if(i)try{var b=this.getNative().createRange();if(!b||b.item&&b.item(0).ownerDocument!=a||b.parentElement&&b.parentElement().ownerDocument!=a)this.isInvalid=k}catch(d){this.isInvalid=k}}function w(a){a=new s(a);return!a||a.isInvalid?y:a}function C(a){function b(a){var b=m.XHTML_DTD;return a._4e_isBlockBoundary()&&b.$empty[a._4e_name()]}function d(a){return s(a)&&x(a)}var c=a.document,e=p._4e_getWin(c),
f=new l(c.body),g=new l(c.documentElement);if(q.ie){if(8>m.Utils.ieEngine)g.on("click",function(b){"html"===(new l(b.target))._4e_name()&&a.getSelection().getNative().createRange().select()});(function(){function a(b,c){var d=l.createTextRange();try{d.moveToPoint(b,c)}catch(f){d=null}return d}function b(){var a=c.selection.createRange();j&&!a.item&&0===a.compareEndPoints("StartToEnd",a)&&j.select();u.remove(c,"mouseup",b);u.remove(c,"mousemove",d);j=h=0;i(k)}function d(c){if(c.button){if(c=a(c.pageX,
c.pageY))0<c.compareEndPoints("StartToStart",j)?c.setEndPoint("StartToStart",j):c.setEndPoint("EndToEnd",j),c.select()}else b()}var h,l=f[0],j;c.documentElement.unselectable=!0;u.on(c,"mousedown contextmenu",function(f){if(f.target===g[0]&&(h&&b(),!(g[0].scrollHeight>g[0].clientHeight)&&(t.log("fix ie cursor"),h=1,j=a(f.pageX,f.pageY))))u.on(c,"mouseup",b),u.on(c,"mousemove",d),e.focus(),j.select()})})();var h,o,z=k;g.on("mousedown",function(){z=v});g.on("mouseup",function(){z=k});f.on("focusin",
function(a){if("body"==(new l(a.target))._4e_name()&&h){try{z&&h.select()}catch(b){}h=y}});f.on("focus",function(){o=k;i()});f.on("beforedeactivate",function(a){a.relatedTarget||(o=v,z=k)});a.on("blur",function(){try{var a=document.documentElement||document.body,b=a.scrollTop,d=a.scrollLeft;c&&c.selection.empty();a.scrollTop=b;a.scrollLeft=d}catch(f){}});f.on("mousedown",function(){o=v});f.on("mouseup",function(){o=k;setTimeout(function(){i(k)},0)});var i=function(b){if(o){var c=a.document,d=a.getSelection(),
f=d&&d.getType(),e=d&&c.selection;if(b&&e&&f==n.SELECTION_NONE&&!c.queryCommandEnabled("InsertImage"))setTimeout(function(){i(k)},50);else{var g;if(!e||!e.type||!("Control"!=e.type&&(g=e.createRange())&&(g=g.parentElement())&&(g=g.nodeName)&&g.toLowerCase()in{input:1,textarea:1}))h=e&&d.getRanges()[0],a._monitor()}}};f.on("keydown",function(){o=v});f.on("keyup",function(){o=k;setTimeout(function(){i()},0)})}else u.on(c,"mouseup",a._monitor,a),u.on(c,"keyup",a._monitor,a);var r=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,
s=m.Walker.whitespaces(k),x=m.Walker.bookmark(v,k),w=function(a){return s(a)&&a&&8!=a[0].nodeType};a.on("selectionChange",function(e){var g=e.path,e=(e=e.selection)&&e.getRanges()[0],h=g.blockLimit;if(q.gecko){var i=g.block||g.blockLimit,o=i&&i._4e_last(d);i&&i._4e_isBlockBoundary()&&(!o||!(1==o[0].nodeType&&o._4e_isBlockBoundary()))&&"pre"!=i._4e_name()&&!i._4e_getBogus()&&i._4e_appendBogus()}if(e&&e.collapsed&&!g.block){if("body"==h._4e_name()){if((g=e.fixBlock(k,"p"))&&g[0]!=f[0].lastChild&&g._4e_outerHtml().match(r))if((h=
g._4e_next(w))&&h[0].nodeType==j.NODE_ELEMENT&&!b[h])e.moveToElementEditablePosition(h),g._4e_remove();else if((h=g._4e_previous(w))&&h[0].nodeType==j.NODE_ELEMENT&&!b[h])e.moveToElementEditablePosition(h,h._4e_outerHtml().match(r)?v:k),g._4e_remove();e.select();a.notifySelectionChange()}g=new m.Range(c);g.moveToElementEditablePosition(f,k);"body"!==(new m.ElementPath(g.startContainer)).blockLimit._4e_name()&&(g=(new l(c.createElement("p"))).appendTo(f),q.ie||g._4e_appendBogus())}})}m.SELECTION={SELECTION_NONE:1,
SELECTION_TEXT:2,SELECTION_ELEMENT:3};var k=!0,v=!1,y=null,t=KISSY,q=t.UA,p=t.DOM,u=t.Event,l=t.Node,n=m.SELECTION,x=m.RANGE,j=m.NODE,i=q.ie,D=m.Walker,r=m.Range,A={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};t.augment(s,{getNative:!i?function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=p._4e_getWin(this.document).getSelection())}:function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=
this.document.selection)},getType:!i?function(){var a=this._.cache;if(a.type)return a.type;var b=n.SELECTION_TEXT,d=this.getNative();if(d){if(1==d.rangeCount){var d=d.getRangeAt(0),c=d.startContainer;c==d.endContainer&&c.nodeType==j.NODE_ELEMENT&&1==Number(d.endOffset-d.startOffset)&&A[c.childNodes[d.startOffset].nodeName.toLowerCase()]&&(b=n.SELECTION_ELEMENT)}}else b=n.SELECTION_NONE;return a.type=b}:function(){var a=this._.cache;if(a.type)return a.type;var b=n.SELECTION_NONE;try{var d=this.getNative(),
c=d.type;"Text"==c&&(b=n.SELECTION_TEXT);"Control"==c&&(b=n.SELECTION_ELEMENT);d.createRange().parentElement&&(b=n.SELECTION_TEXT)}catch(e){}return a.type=b},getRanges:i?function(){var a=function(a,d){a=a.duplicate();a.collapse(d);for(var c=a.parentElement(),e=c.childNodes,f,g=0;g<e.length;g++){var h=e[g];if(h.nodeType==j.NODE_ELEMENT){f=a.duplicate();f.moveToElementText(h);var h=f.compareEndPoints("StartToStart",a),i=f.compareEndPoints("EndToStart",a);f.collapse();if(0<h)break;else{if(!h||1==i&&
-1==h)return{container:c,offset:g};if(!i)return{container:c,offset:g+1}}f=y}}f||(f=a.duplicate(),f.moveToElementText(c),f.collapse(v));f.setEndPoint("StartToStart",a);f=(""+f.text).replace(/\r\n|\r/g,"\n").length;try{for(;0<f;)f-=e[--g].nodeValue.length}catch(k){f=0}return 0===f?{container:c,offset:g}:{container:e[g],offset:-f}};return function(b){var d=this._.cache;if(d.ranges&&!b)return d.ranges;var c=this.getNative(),b=c&&c.createRange(),e=this.getType();if(!c)return[];if(e==n.SELECTION_TEXT)return c=
new r(this.document),e=a(b,k),c.setStart(new l(e.container),e.offset),e=a(b),c.setEnd(new l(e.container),e.offset),d.ranges=[c];if(e==n.SELECTION_ELEMENT){d=d.ranges=[];for(e=0;e<b.length;e++){for(var f=b.item(e),g=f.parentNode,h=0,c=new r(this.document);h<g.childNodes.length&&g.childNodes[h]!=f;h++);c.setStart(new l(g),h);c.setEnd(new l(g),h+1);d.push(c)}return d}return d.ranges=[]}}():function(a){var b=this._.cache;if(b.ranges&&!a)return b.ranges;var a=[],d=this.getNative();if(!d)return[];for(var c=
0;c<d.rangeCount;c++){var e=d.getRangeAt(c),f=new r(this.document);f.setStart(new l(e.startContainer),e.startOffset);f.setEnd(new l(e.endContainer),e.endOffset);a.push(f)}return b.ranges=a},getStartElement:function(){var a=this._.cache;if(void 0!==a.startElement)return a.startElement;var b,d=this.getNative();switch(this.getType()){case n.SELECTION_ELEMENT:return this.getSelectedElement();case n.SELECTION_TEXT:var c=this.getRanges()[0];if(c&&!c.collapsed){for(c.optimize();k;)if(b=c.startContainer,
c.startOffset==(b[0].nodeType===j.NODE_ELEMENT?b[0].childNodes.length:b[0].nodeValue.length)&&!b._4e_isBlockBoundary())c.setStartAfter(b);else break;b=c.startContainer;if(b[0].nodeType!=j.NODE_ELEMENT)return b.parent();b=new l(b[0].childNodes[c.startOffset]);if(!b[0]||b[0].nodeType!=j.NODE_ELEMENT)return c.startContainer;for(c=b[0].firstChild;c&&c.nodeType==j.NODE_ELEMENT;)b=new l(c),c=c.firstChild;return b}if(i)c=d.createRange(),c.collapse(k),b=c.parentElement();else if((b=d.anchorNode)&&b.nodeType!=
j.NODE_ELEMENT)b=b.parentNode}return a.startElement=b?p._4e_wrap(b):y},getSelectedElement:function(){var a,b=this._.cache;if(void 0!==b.selectedElement)return b.selectedElement;i&&(a=this.getNative().createRange(),a=a.item&&a.item(0));if(!a){a=this.getRanges()[0];for(var d,c,e=2;e&&(!(d=a.getEnclosedNode())||!(d[0].nodeType==j.NODE_ELEMENT&&A[d._4e_name()]&&(c=d)));e--)a.shrink(x.SHRINK_ELEMENT);a=c&&c[0]}return b.selectedElement=p._4e_wrap(a)},reset:function(){this._.cache={}},selectElement:function(a){var b,
d=this.document;if(i)try{b=d.body.createControlRange(),b.addElement(a[0]),b.select()}catch(c){b=d.body.createTextRange(),b.moveToElementText(a[0]),b.select()}finally{}else b=d.createRange(),b.selectNode(a[0]),a=this.getNative(),a.removeAllRanges(),a.addRange(b);this.reset()},selectRanges:function(a){if(i){if(1<a.length){var b=a[a.length-1];a[0].setEnd(b.endContainer,b.endOffset);a.length=1}a[0]&&a[0].select()}else{b=this.getNative();if(!b)return;b.removeAllRanges();for(var d=0;d<a.length;d++){var c=
a[d],e=this.document.createRange(),f=c.startContainer;if(c.collapsed&&(q.gecko&&1.09>q.gecko||q.opera||q.webkit)&&f[0].nodeType==j.NODE_ELEMENT&&!f[0].childNodes.length)f[0].appendChild(this.document.createTextNode(q.webkit?"\u200b":"")),c.startOffset++,c.endOffset++;e.setStart(f[0],c.startOffset);e.setEnd(c.endContainer[0],c.endOffset);b.addRange(e)}}this.reset()},createBookmarks2:function(a){for(var b=[],d=this.getRanges(),c=0;c<d.length;c++)b.push(d[c].createBookmark2(a));return b},createBookmarks:function(a,
b){for(var d=[],c=this.document,e,b=b||this.getRanges(),f=b.length,g=0;g<f;g++){d.push(e=b[g].createBookmark(a,k));var h=(a=e.serializable)?t.one("#"+e.startNode,c):e.startNode;e=a?t.one("#"+e.endNode,c):e.endNode;for(var i=g+1;i<f;i++){var j=b[i],l=j.startContainer,m=j.endContainer;p._4e_equals(l,h.parent())&&j.startOffset++;p._4e_equals(l,e.parent())&&j.startOffset++;p._4e_equals(m,h.parent())&&j.endOffset++;p._4e_equals(m,e.parent())&&j.endOffset++}}return d},selectBookmarks:function(a){for(var b=
[],d=0;d<a.length;d++){var c=new r(this.document);c.moveToBookmark(a[d]);b.push(c)}this.selectRanges(b);return this},getCommonAncestor:function(){var a=this.getRanges();return a[0].startContainer._4e_commonAncestor(a[a.length-1].endContainer)},scrollIntoView:function(){var a=this.getStartElement();a&&a._4e_scrollIntoView()},removeAllRanges:function(){var a=this.getNative();i?a&&a.clear():a&&a.removeAllRanges()}});var B={table:1,tbody:1,tr:1},E=D.whitespaces(k),F=/\ufeff|\u00a0/;r.prototype.select=
r.prototype.select=!i?function(){var a=this.startContainer;this.collapsed&&a[0].nodeType==j.NODE_ELEMENT&&!a[0].childNodes.length&&a[0].appendChild(this.document.createTextNode(""));var b=this.document.createRange();b.setStart(a[0],this.startOffset);try{b.setEnd(this.endContainer[0],this.endOffset)}catch(d){if(0<=d.toString().indexOf("NS_ERROR_ILLEGAL_VALUE"))this.collapse(k),b.setEnd(this.endContainer[0],this.endOffset);else throw d;}a=w(this.document).getNative();a.removeAllRanges();a.addRange(b)}:
function(a){var b=this.collapsed,d,c;if(this.startContainer[0]===this.endContainer[0]&&1==this.endOffset-this.startOffset){var e=this.startContainer[0].childNodes[this.startOffset];if(e.nodeType==j.NODE_ELEMENT){(new s(this.document)).selectElement(new l(e));return}}(this.startContainer[0].nodeType==j.NODE_ELEMENT&&this.startContainer._4e_name()in B||this.endContainer[0].nodeType==j.NODE_ELEMENT&&this.endContainer._4e_name()in B)&&this.shrink(x.SHRINK_ELEMENT,k);var f=this.createBookmark(),e=f.startNode,
g;b||(g=f.endNode);f=this.document.body.createTextRange();f.moveToElementText(e[0]);f.moveStart("character",1);if(g)a=this.document.body.createTextRange(),a.moveToElementText(g[0]),f.setEndPoint("EndToEnd",a),f.moveEnd("character",-1);else{for(d=e[0].nextSibling;d&&!E(d);)d=d.nextSibling;d=!(d&&d.nodeValue&&d.nodeValue.match(F))&&(a||!e[0].previousSibling||e[0].previousSibling&&"br"==p._4e_name(e[0].previousSibling));c=new l(this.document.createElement("span"));c.html("&#65279;");c.insertBefore(e);
d&&p.insertBefore(this.document.createTextNode("\ufeff"),e[0]||e)}this.setStartBefore(e);e._4e_remove();if(b){if(d?(f.moveStart("character",-1),f.select(),this.document.selection.clear()):f.select(),c)this.moveToPosition(c,x.POSITION_BEFORE_START),c._4e_remove()}else this.setEndBefore(g),g._4e_remove(),f.select()};s.getSelection=w;m.Selection=s;m.on("instanceCreated",function(a){C(a.editor)})});
