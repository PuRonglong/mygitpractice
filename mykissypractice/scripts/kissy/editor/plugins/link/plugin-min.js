KISSY.Editor.add("link",function(f){f.addPlugin("link",function(){function k(a){return a._4e_ascendant(function(a){return"a"===a._4e_name()},!0)}var g=KISSY,o=g.UA,e=g.Editor,p=g.Node,l=e.Style,m={element:"a",attributes:{href:"#(href)",title:"#(title)",_ke_saved_href:"#(_ke_saved_href)",target:"#(target)"}},h={},i=e.Utils.addRes,q=e.Utils.destroyRes,n=f.addButton("link",{contentCls:"ke-toolbar-link",title:"\u63d2\u5165\u94fe\u63a5",mode:e.WYSIWYG_MODE,_getSelectedLink:function(){var a=this.editor.getSelection();(a=a&&
a.getStartElement())&&(a=k(a));return a},_getSelectionLinkUrl:function(){var a=this.cfg._getSelectedLink.call(this);if(a)return a.attr("_ke_saved_href")||a.attr("href")},_removeLink:function(a){var d=this.editor;d.fire("save");var c=d.getSelection(),b=c.getRanges()[0];if(b&&b.collapsed)b=c.createBookmarks(),a._4e_remove(!0),c.selectBookmarks(b);else if(b){for(var a=a[0],c=a.attributes,b={},e=0;e<c.length;e++){var j=c[e];j.specified&&(b[j.name]=j.value)}a.style.cssText&&(b.style=a.style.cssText);(new l(m,
b)).remove(d.document)}d.fire("save");d.notifySelectionChange()},_link:function(a,d){var c=this.editor;a._ke_saved_href=a.href;if(d)c.fire("save"),d.attr(a);else{var b=c.getSelection(),b=b&&b.getRanges()[0];!b||b.collapsed?(b=new p("<a>"+a.href+"</a>",a,c.document),c.insertElement(b)):(c.fire("save"),(new l(m,a)).apply(c.document),o.gecko&&c.getSelection().getStartElement())}c.fire("save");c.notifySelectionChange()},offClick:function(){this.editor.showDialog("link/dialog",[this])},destroy:function(){this.editor.destroyDialog("link/dialog")}});
i.call(h,n);e.use("bubbleview",function(){e.BubbleView.register({pluginName:"link",editor:f,pluginContext:n,func:k,init:function(){var a=this,d=a.get("contentEl");d.html('<a href=""  target="_blank" class="ke-bubbleview-url">\u5728\u65b0\u7a97\u53e3\u67e5\u770b</a>  \u2013   <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span>   |    <span class="ke-bubbleview-link ke-bubbleview-remove">\u53bb\u9664</span>');var c=d.one(".ke-bubbleview-url"),b=d.one(".ke-bubbleview-change"),f=d.one(".ke-bubbleview-remove");e.Utils.preventFocus(d);
b.on("click",function(b){a._plugin.call("offClick");b.halt()});f.on("click",function(b){a._plugin.call("_removeLink",a._selectedEl);b.halt()});i.call(a,b,f);a.on("show",function(){var b=a._selectedEl;b&&(b=b.attr("_ke_saved_href")||b.attr("href"),c.html(b),c.attr("href",b))})}});i.call(h,function(){e.BubbleView.destroy("link")})});this.destroy=function(){q.call(h)}})},{attach:!1});
