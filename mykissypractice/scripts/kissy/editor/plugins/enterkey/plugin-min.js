KISSY.Editor.add("enterkey",function(o){var j=KISSY,h=j.Editor,k=j.UA,q=/^h[1-6]$/,r=h.XHTML_DTD,l=j.Node,s=j.Event,t=h.Walker,u=h.ElementPath;h.enterBlock||function(){function p(b){s.on(b.document,"keydown",function(a){if(a.keyCode===13)if(!(a.shiftKey||a.ctrlKey||a.metaKey)){b.fire("save");var f=b.execCommand("enterBlock");b.fire("save");f!==false&&a.preventDefault()}})}p.enterBlock=function(b){var a;a=b.getSelection().getRanges();for(var f=a.length-1;f>0;f--)a[f].deleteContents();a=a[0];f=a.document;
if(a.checkStartOfBlock()&&a.checkEndOfBlock()){var c=(new u(a.startContainer)).block;if(c&&(c._4e_name()=="li"||c.parent()._4e_name()=="li"))if(b.hasCommand("outdent")){b.fire("save");b.execCommand("outdent");b.fire("save");return true}else return false}var g=a.splitBlock("p");if(!g)return true;b=g.previousBlock;c=g.nextBlock;var n=g.wasStartOfBlock,m=g.wasEndOfBlock,e;if(c){e=c.parent();if(e._4e_name()=="li"){c._4e_breakParent(e);c._4e_move(c._4e_next(),true)}}else if(b&&(e=b.parent())&&e._4e_name()==
"li"){b._4e_breakParent(e);a.moveToElementEditablePosition(b._4e_next());b._4e_move(b._4e_previous())}if(!n&&!m){if(c._4e_name()=="li"&&(e=c._4e_first(t.invisible(true)))&&j.inArray(e._4e_name(),["ul","ol"]))(k.ie?new l(f.createTextNode("\u00a0")):new l(f.createElement("br"))).insertBefore(e);c&&a.moveToElementEditablePosition(c)}else{var d;if(b){if(b._4e_name()=="li"||!q.test(b._4e_name()))d=b._4e_clone()}else if(c)d=c._4e_clone();d||(d=new l("<p>",null,f));if(e=g.elementPath){g=0;for(var v=e.elements.length;g<
v;g++){var i=e.elements[g];if(i._4e_equals(e.block)||i._4e_equals(e.blockLimit))break;if(r.$removeEmpty[i._4e_name()]){i=i._4e_clone();d._4e_moveChildren(i);d.append(i)}}}k.ie||d._4e_appendBogus();a.insertNode(d);if(k.ie&&n&&(!m||!b[0].childNodes.length)){a.moveToElementEditablePosition(m?b:d);a.select()}a.moveToElementEditablePosition(n&&!m?c:d)}if(!k.ie)if(c){d=new l(f.createElement("span"));d.html("&nbsp;");a.insertNode(d);d._4e_scrollIntoView();a.deleteContents()}else d._4e_scrollIntoView();a.select();
return true};h.EnterKey=p}();o.addCommand("enterBlock",{exec:h.EnterKey.enterBlock});h.EnterKey(o)},{attach:false});
