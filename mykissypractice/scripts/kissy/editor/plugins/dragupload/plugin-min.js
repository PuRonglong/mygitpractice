KISSY.Editor.add("dragupload",function(r){function s(a){a=a.originalEvent.target;if(l._4e_name(a)=="img"&&a.src.match(/^file:\/\//))o[a.src]=a}function u(a,g){var d=new window.FileReader;d.onload=function(e){var h=a.name;e=e.target.result;var b=new XMLHttpRequest;b.open("POST",v,true);b.onreadystatechange=function(){if(b.readyState==4){if(b.status==200||b.status==304){if(b.responseText!=""){var i=window.JSON.parse(b.responseText);g[0].src=i.imgUrl}}else{alert("\u670d\u52a1\u5668\u7aef\u51fa\u9519\uff01");g._4e_remove();f.log(b)}b.onreadystatechange=
null}};var c="\r\n------kissy-editor-2.1\r\n";c+='Content-Disposition: form-data; name="'+w+'"; filename="'+encodeURIComponent(h)+'"\r\n';c+="Content-Type: "+(a.type||"application/octet-stream")+"\r\n\r\n";c+=e+"\r\n";m=t.Utils.normParams(m);for(var j in m)if(m.hasOwnProperty(j)){c+="------kissy-editor-2.1\r\n";c+='Content-Disposition: form-data; name="'+j+'"\r\n\r\n';c+=m[j]+"\r\n"}c+="------kissy-editor-2.1--";b.setRequestHeader("Content-Type","multipart/form-data, boundary=----kissy-editor-2.1");
b.sendAsBinary("Content-Type: multipart/form-data; boundary=----kissy-editor-2.1\r\nContent-Length: "+c.length+"\r\n"+c+"\r\n");d.onload=null};d.readAsBinaryString(a)}var f=KISSY,t=f.Editor,x=f.Node,p=f.Event,y=f.UA,l=f.DOM,n=r.cfg.pluginConfig.dragupload||{},w=n.fileInput||"Filedata",z=n.sizeLimit||Number.MAX_VALUE,m=n.serverParams||{},v=n.serverUrl||"",A=RegExp((n.suffix||"png,jpg,jpeg,gif").split(/,/).join("|")+"$","i"),k=r.document;if(!y.ie){var o={},q=false;p.on(k,"dragenter",function(){if(!q){p.on(k,
"DOMNodeInserted",s);q=true}});p.on(k,"drop",function(a){p.remove(k,"DOMNodeInserted",s);q=false;a.halt();a=a.originalEvent;f.log(a);var g,d;if(f.isEmptyObject(o)){d=k.elementFromPoint(a.clientX,a.clientY);g=d.lastChild}else{f.each(o,function(i){if(l._4e_name(i)=="img"){g=i.nextSibling;d=i.parentNode;l._4e_remove(i)}});o={}}a=a.dataTransfer;a.dropEffect="copy";if(a=a.files)for(var e=0;e<a.length;e++){var h=a[e],b=h.size;if(h.name.match(A))if(!(b/1E3>z)){b=new x("<img src='"+(t.Config.base+"../theme/loading.gif")+
"'/>");var c=b[0];d.insertBefore(c,g);var j=l._4e_name(c.parentNode);if(j=="head"||j=="html")l.insertBefore(c,k.body.firstChild);u(h,b)}}});if(window.XMLHttpRequest&&!XMLHttpRequest.prototype.sendAsBinary)XMLHttpRequest.prototype.sendAsBinary=function(a,g){for(var d=new (window.BlobBuilder||window.WebKitBlobBuilder),e=a.length,h=new window.Uint8Array(e),b=0;b<e;b++)h[b]=a.charCodeAt(b);d.append(h.buffer);this.send(d.getBlob(g))}}},{attach:false});
