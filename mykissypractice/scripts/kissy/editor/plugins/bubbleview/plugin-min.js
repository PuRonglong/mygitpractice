KISSY.Editor.add("bubbleview",function(){var i=KISSY,e=i.Editor,q=i.Event,r=i.DOM;if(e.BubbleView)i.log("attach bubbleview more","warn");else{var f=i.require("uibase").create(e.Overlay,[],{renderUI:function(){this.get("el").addClass("ke-bubbleview-bubble")},show:function(){var a=this.get("el");a.css("visibility","hidden");a.stop(1);a.css("display","none");this.set("visible",!0);a.fadeIn(0.3)},hide:function(){var a=this.get("el");a.css("visibility","hidden");a.stop(1);this.set("visible",!1)},destructor:function(){e.Utils.destroyRes.call(this)}},
{ATTRS:{focus4e:{value:!1},zIndex:{value:e.baseZIndex(e.zIndexManager.BUBBLE_VIEW)}}}),j={};f.destroy=function(a){if((a=j[a])&&a.bubble)a.bubble.destroy(),a.bubble=null};f.attach=function(a){function p(){c&&(c.hide(),q.remove(s,"scroll",t))}function u(){var a;if(a=c._selectedEl){var b=n.iframe[0].contentWindow,d=n.iframe.offset(),e=d.top,d=d.left,l=d+r.width(b),b=e+r.height(b),k=a._4e_getOffset(document),f=k.top,k=k.left,p=k+a.width(),o=f+a.height(),h,g;i.UA.ie&&"img"==a[0].nodeName.toLowerCase()&&
o>b?a=void 0:(o>b&&f<b?g=b-30:o>e&&o<b&&(g=o),p>d&&k<d?h=d:k>d&&k<l&&(h=k),a=void 0!==h&&void 0!==g?[h,g]:void 0)}else a=void 0;if(a){c.set("xy",a);var m,e=c;h=null;for(m in j)if(j.hasOwnProperty(m)){g=j[m];if(d=g.bubble)if(d=e!=g.bubble)if(d=g.bubble.get("visible"))b=e,l=g.bubble,d=b.get("y"),b=d+b.get("el")[0].offsetHeight,f=l.get("y"),l=f+l.get("el")[0].offsetHeight,d=d<=l&&b>=l||d<=f&&b>=f;d&&(h?h.get("y")<g.bubble.get("y")&&(h=g.bubble):h=g.bubble)}if(m=h)a[1]=m.get("y")+m.get("el")[0].offsetHeight,
c.set("xy",a);c.get("visible")?i.log("already show by selectionChange"):c.show()}}function t(){c._selectedEl&&(c&&(c.get("el"),c.hide()),w())}function x(){q.on(s,"scroll",t);u()}var v=a.pluginName;i.mix(a,j[v].cfg,!1);var y=a.pluginContext,z=a.func,n=a.editor,c=a.bubble;n.on("selectionChange",function(a){var a=a.path,b=a.elements;if(a&&b&&(a=a.lastElement))(a=z(a))?(b=j[v],b.bubble||(b.bubble=new f,b.bubble.render(),b.cfg.init&&b.cfg.init.call(b.bubble)),c=b.bubble,c._selectedEl=a,c._plugin=y,c.hide(),
i.later(x,10)):c&&(c._selectedEl=c._plugin=null,p())});n.on("sourcemode",p);var s=n.iframe[0].contentWindow,w=e.Utils.buffer(u,void 0,350)};f.register=function(a){var e=a.pluginName;j[e]=j[e]||{cfg:a};a.editor&&f.attach(a)};e.BubbleView=f}},{attach:!1,requires:["overlay"]});
