KISSY.Editor.add("image/dialog",function(m){function H(a){for(a=a.parent();a;){var c=a._4e_name();if("a"==c)return a;if(I.$block[c]||I.$blockLimit[c])break;a=a.parent()}return null}function N(){j=new b.Dialog({autoRender:!0,width:500,headerContent:"\u56fe\u7247",bodyContent:O,footerContent:P,mask:!0});q.call(g,j);var a=j.get("el"),c=a.one(".ke-img-cancel"),d=a.one(".ke-img-insert"),h=b.Utils.verifyInputs,m=a.one(".ke-img-setting");A=a.one(".ke-img-upload-form");n=a.one(".ke-img-local-url");r=new b.Tabs({tabs:a.one("ul.ke-tabs"),
contents:a.one("div.ke-image-tabs-content-wrap")});q.call(g,r);n.val(u);s=a.one(".ke-img-url");l=a.one(".ke-img-height");k=a.one(".ke-img-width");t=a.one(".ke-img-ratio");B=b.Select.decorate(a.one(".ke-img-align"));C=a.one(".ke-img-margin");v=a.one(".ke-img-link");w=a.one(".ke-img-link-blank");var D=b.Utils.placeholder;D(s,Q);D(l,E);D(k,E);D(v,"http://");l.on("keyup",function(){var a=parseInt(i(l));a&&t[0].checked&&!t[0].disabled&&x&&i(k,Math.floor(a*x))});q.call(g,l,s,k);k.on("keyup",function(){var a=
parseInt(i(k));a&&t[0].checked&&!t[0].disabled&&x&&i(l,Math.floor(a/x))});q.call(g,k);c.on("click",function(a){j.hide();a.halt()});q.call(g,c);var e=(new F("<a class='ke-button' style='position:absolute;z-index:"+b.baseZIndex(b.zIndexManager.LOADING_CANCEL)+";left:-9999px;top:-9999px;'>\u53d6\u6d88\u4e0a\u4f20</a>")).appendTo(document.body),y=null;e.on("click",function(a){a&&a.halt();j.unloading();y&&(R.remove(y,"load"),S.remove(y));e.css({left:-9999,top:-9999});y=null});q.call(g,e);d.on("click",function(c){c.halt();
if("local"==r.activate()&&f){if(h(m.all("input")))if(n.val()==u)alert("\u8bf7\u5148\u9009\u62e9\u6587\u4ef6!");else if(T.test(n.val()))if(c=o[0].files?o[0].files[0].size:0,z&&z<c/1E3)alert("\u4e0a\u4f20\u56fe\u7247\u6700\u5927\uff1a"+z/1E3+"M");else{j.loading();y=b.Utils.doFormUpload({form:A,callback:function(a){y=null;e.css({left:-9999,top:-9999});a=p.trim(a.responseText).replace(/\r|\n/g,"");j.unloading();try{a=U.parse(a)}catch(c){p.log(a),a=null}a||(a={error:"\u670d\u52a1\u5668\u51fa\u9519\uff0c\u8bf7\u91cd\u8bd5"});a.error?alert(a.error):(i(s,a.imgUrl),(new Image).src=a.imgUrl,J())}},f.serverParams,f.serverUrl);
var c=j.get("el"),d=c.offset();e.css({left:d.left+c[0].offsetWidth/2.5,top:d.top+c[0].offsetHeight/1.5})}else alert(V),A[0].reset(),n.val(u)}else h(a.all("input"))&&J()});q.call(g,d);if(f){f.extraHtml&&a.one(".ke-img-up-extraHtml").html(f.extraHtml);var K=a.one(".ke-image-up"),z=f&&f.sizeLimit;o=(new F("<input type='file' style='position:absolute;cursor:pointer;left:"+(L.ie?"360":L.chrome?"319":"369")+"px;z-index:2;top:0px;height:26px;' size='1' name='"+(f.fileInput||"Filedata")+"'/>")).insertAfter(n);
z&&(u="\u5355\u5f20\u56fe\u7247\u5bb9\u91cf\u4e0d\u8d85\u8fc7 "+z/1E3+" M");n.val(u);o.css("opacity",0);o.on("mouseenter",function(){K.addClass("ke-button-hover")});o.on("mouseleave",function(){K.removeClass("ke-button-hover")});o.on("change",function(){var a=o.val();n.val(a.replace(/.+[\/\\]/,""))});q.call(g,o);!1===G.remote&&r.remove("remote")}else r.remove("local")}function J(){var a=i(s),c,d=parseInt(i(l)),b=parseInt(i(k)),f=B.val(),g=parseInt(C.val()),e="";d&&(e+="height:"+d+"px;");b&&(e+="width:"+b+"px;");f&&(e+="float:"+f+";");isNaN(g)||
(e+="margin:"+g+"px;");j.hide();h?(c=h,m.fire("save"),h.attr({src:a,_ke_saved_src:a,style:e})):(c=new F("<img "+(e?"style='"+e+"'":"")+" src='"+a+"' _ke_saved_src='"+a+"' alt='' />",null,m.document),m.insertElement(c));setTimeout(function(){var a=H(c),b=p.trim(i(v)),e=m.getSelection(),d;if(a)if(b)a.attr("_ke_saved_href",b).attr("href",b).attr("target",w.attr("checked")?"_blank":"_self");else{d=e.createBookmarks();a._4e_remove(true)}else if(b){d=e.createBookmarks();a=new F("<a></a>");a.attr("_ke_saved_href",
b).attr("href",b).attr("target",w.attr("checked")?"_blank":"_self");b=c[0];b.parentNode.replaceChild(a[0],b);a.append(b)}d&&e.selectBookmarks(d);h&&m.fire("save")},100)}var p=KISSY,b=p.Editor,I=b.XHTML_DTD,S=p.DOM,L=p.UA,U=p.JSON,F=p.Node,R=p.Event,Q="http://",E="\u81ea\u52a8",O="<div class='ke-image-wrap'><ul class='ke-tabs ks-clear'><li rel='remote'>\u7f51\u7edc\u56fe\u7247</li><li rel='local'>\u672c\u5730\u4e0a\u4f20</li></ul><div style='padding:12px 20px 5px 20px;'><div class='ke-image-tabs-content-wrap' ><div><label><span class='ke-image-title'>\u56fe\u7247\u5730\u5740\uff1a </span><input  data-verify='^(https?:/)?/[^\\s]+$'  data-warning='\u7f51\u5740\u683c\u5f0f\u4e3a\uff1ahttp:// \u6216 /' class='ke-img-url ke-input' style='width:390px;vertical-align:middle;' /></label></div><div style='position:relative;'><form class='ke-img-upload-form' method='post'><p style='zoom:1;'><input class='ke-input ke-img-local-url' readonly='readonly' style='margin-right: 15px; vertical-align: middle; width: 368px;color:#969696;'/><a style='padding:3px 11px;position:absolute;left:390px;top:0px;z-index:1;' class='ke-image-up ke-button'>\u6d4f\u89c8...</a></p><div class='ke-img-up-extraHtml'></div></form></div></div><table style='width:100%;margin-top:8px;' class='ke-img-setting'><tr><td><label>\u5bbd\u5ea6\uff1a <input  data-verify='^("+
E+"|((?!0$)\\d+))?$'  data-warning='\u5bbd\u5ea6\u8bf7\u8f93\u5165\u6b63\u6574\u6570' class='ke-img-width ke-input' style='vertical-align:middle;width:60px' /> \u50cf\u7d20 </label></td><td><label>\u9ad8\u5ea6\uff1a <input  data-verify='^("+E+"|((?!0$)\\d+))?$'  data-warning='\u9ad8\u5ea6\u8bf7\u8f93\u5165\u6b63\u6574\u6570' class='ke-img-height ke-input' style='vertical-align:middle;width:60px' /> \u50cf\u7d20 </label><label><input type='checkbox' class='ke-img-ratio' style='vertical-align:middle;margin-left:5px;' checked='checked'/> \u9501\u5b9a\u9ad8\u5bbd\u6bd4</label></td></tr><tr><td><label>\u5bf9\u9f50\uff1a<select class='ke-img-align' title='\u5bf9\u9f50'><option value='none'>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select></label></td><td><label>\u95f4\u8ddd\uff1a <input  data-verify='^\\d+$'  data-warning='\u95f4\u8ddd\u8bf7\u8f93\u5165\u975e\u8d1f\u6574\u6570' class='ke-img-margin ke-input' style='width:60px'/> \u50cf\u7d20</label></td></tr><tr class='ke-img-link-row'><td colspan='2' style='padding-top: 6px'><label>\u94fe\u63a5\u7f51\u5740\uff1a <input class='ke-img-link ke-input' style='width:235px;vertical-align:middle;'  data-verify='^(?:(?:\\s*)|(?:https?://[^\\s]+)|(?:#.+))$'  data-warning='\u8bf7\u8f93\u5165\u5408\u9002\u7684\u7f51\u5740\u683c\u5f0f' /></label><label><input class='ke-img-link-blank' style='vertical-align:middle;margin-left:5px;' type='checkbox'/> &nbsp; \u5728\u65b0\u7a97\u53e3\u6253\u5f00\u94fe\u63a5</label></td></tr></table></div></div>",
P="<div style='padding:5px 20px 20px;'><a class='ke-img-insert ke-button' style='margin-right:30px;'>\u786e\u5b9a</a> <a  class='ke-img-cancel ke-button'>\u53d6\u6d88</a></div>",j,r,s,l,k,B,t,C,x,n,v,w,o,A,u="\u8bf7\u70b9\u51fb\u6d4f\u89c8\u4e0a\u4f20\u56fe\u7247",h,G=m.cfg.pluginConfig.image||{},f=G.upload||null,M=f&&f.suffix||"png,jpg,jpeg,gif",T=RegExp(M.split(/,/).join("|")+"$","i"),V="\u53ea\u5141\u8bb8\u540e\u7f00\u540d\u4e3a"+M+"\u7684\u56fe\u7247",g={},q=b.Utils.addRes,W=b.Utils.destroyRes,i=b.Utils.valInput;b.use("overlay,tabs,select",function(){N();m.addDialog("image/dialog",{show:function(a){var c=
"remote",d=b.Utils.resetInput;if((h=a)&&!1!==G.remote){i(s,h.attr("src"));var a=parseInt(h.style("width")),f=parseInt(h.style("height"));f?i(l,f):d(l);a?i(k,a):d(k);B.val(h.css("float")||"none");var g=parseInt(h._4e_style("margin"))||0;C.val(g);t[0].disabled=!1;x=a/f;(a=H(h))?(i(v,a.attr("_ke_saved_href")||a.attr("href")),w.attr("checked","_blank"==a.attr("target"))):(d(v),w.attr("checked",!0))}else a=G.defaultMargin,void 0==a&&(a=10),r.getTab("local")&&(c="local"),w.attr("checked",!0),d(s),d(v),
d(l),d(k),B.val("none"),C.val(a),t[0].disabled=!0,x=null;A[0].reset();n.val(u);r.activate(c);j.show()},hide:function(){j.hide()},destroy:function(){W.call(g)},dialog:j})})},{attach:!1});
