KISSY.Editor.add("image",function(g){g.addPlugin("image",function(){function p(a){var c=new q(a.target);a.halt();k(c)&&l.call("show",null,c)}var m=KISSY,e=m.Editor,r=m.UA,q=m.Node,s=m.Event,k=function(a){return a._4e_name()==="img"&&!/(^|\s+)ke_/.test(a[0].className)&&a},j={},n=e.Utils.addRes,t=e.Utils.destroyRes,l=g.addButton("image",{contentCls:"ke-toolbar-image",title:"\u63d2\u5165\u56fe\u7247",mode:e.WYSIWYG_MODE,offClick:function(){this.call("show")},_updateTip:function(a,c){var f=c.attr("_ke_saved_src")||c.attr("src");
a.attr("href",f)},show:function(a,c){this.editor.showDialog("image/dialog",[c])}});n.call(j,l,function(){g.destroyDialog("image/dialog")});e.use("contextmenu",function(){var a={"\u56fe\u7247\u5c5e\u6027":function(b){b=(b=b.getSelection())&&b.getStartElement();(b=k(b))&&l.call("show",null,b)},"\u63d2\u5165\u65b0\u884c":function(b){var h=b.getSelection();if(h=h&&h.getStartElement()){var d=b.document,i=new q(d.createElement("p"));r.ie||i._4e_appendBogus();d=new e.Range(d);d.setStartAfter(h);d.select();b.insertElement(i);d.moveToElementEditablePosition(i,
1);d.select()}}},c={},f;for(f in a)a.hasOwnProperty(f)&&function(b){c[b]=function(){a[b](g)}}(f);f=e.ContextMenu.register({editor:g,rules:[k],width:"120px",funcs:c});n.call(j,f)});s.on(g.document,"dblclick",p);n.call(j,function(){s.remove(g.document,"dblclick",p)});e.use("bubbleview",function(){e.BubbleView.register({pluginName:"image",pluginContext:l,editor:g,func:k,init:function(){var a=this,c=a.get("contentEl");c.html(' <a class="ke-bubbleview-url" target="_blank" href="#">\u5728\u65b0\u7a97\u53e3\u67e5\u770b</a>  |  <a class="ke-bubbleview-link ke-bubbleview-change" href="#">\u7f16\u8f91</a>  |  <a class="ke-bubbleview-link ke-bubbleview-remove" href="#">\u5220\u9664</a>');
var f=c.one(".ke-bubbleview-url"),b=c.one(".ke-bubbleview-change"),h=c.one(".ke-bubbleview-remove");e.Utils.preventFocus(c);b.on("click",function(d){a._plugin.call("show",null,a._selectedEl);d.halt()});h.on("click",function(d){var i=a._plugin;if(r.webkit){var o=i.editor.getSelection().getRanges();o&&o[0]&&(o[0].collapse(true)||1)&&o[0].select()}a._selectedEl._4e_remove();a.hide();i.editor.notifySelectionChange();d.halt()});e.Utils.addRes.call(a,b,h);a.on("show",function(){var d=a._selectedEl;d&&a._plugin.call("_updateTip",
f,d)})}});n.call(j,function(){e.BubbleView.destroy("image")})});this.destroy=function(){t.call(j)}})},{attach:false});
