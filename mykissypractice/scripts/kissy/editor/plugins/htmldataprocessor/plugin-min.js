KISSY.Editor.add("htmldataprocessor",function(x){function A(c){return c.replace(B,function(c,b,d){return"<"+b+d.replace(C,function(b,c){return-1==d.indexOf("_ke_saved_"+c)?" _ke_saved_"+b+" "+b:b})+">"})}var n=n,l=KISSY,j=l.Editor,D=l.Node,o=l.UA,u=j.NODE,i=j.HtmlParser,r=new i.Filter,v=new i.Filter,w=new i.Filter,y=j.XHTML_DTD;if(!x.htmlDataProcessor){(function(){var c=j.HtmlParser.Fragment.prototype,f=j.HtmlParser.Element.prototype;c.onlyChild=f.onlyChild=function(){var b=this.children;return 1==
b.length&&b[0]||null};f.removeAnyChildWithName=function(b){for(var d=this.children,c=[],g,e=0;e<d.length;e++)g=d[e],g.name&&(g.name==b&&(c.push(g),d.splice(e--,1)),c=c.concat(g.removeAnyChildWithName(b)));return c};f.getAncestor=function(b){for(var d=this.parent;d&&(!d.name||!d.name.match(b));)d=d.parent;return d};c.firstChild=f.firstChild=function(b){for(var d,c=0;c<this.children.length;c++)if(d=this.children[c],b(d)||d.name&&(d=d.firstChild(b)))return d;return null};f.addStyle=function(b,d,c){var g=
"";if("string"==typeof d)g+=b+":"+d+";";else{if("object"==typeof b)for(var e in b)b.hasOwnProperty(e)&&(g+=e+":"+b[e]+";");else g+=b;c=d}this.attributes||(this.attributes={});b=this.attributes.style||"";b=(c?[g,b]:[b,g]).join(";");this.attributes.style=b.replace(/^;|;(?=;)/,"")};y.parentOf=function(b){var c={},f;for(f in this)this.hasOwnProperty(f)&&-1==f.indexOf("$")&&this[f][b]&&(c[f]=1);return c}})();(function(){function c(a){return/mso-list\s*:\s*Ignore/i.test(a.attributes&&a.attributes.style||
"")?!0:n}function f(a,p){var c=new j.HtmlParser.Element("ke:listbullet"),b;a?a[2]?(a=isNaN(a[1])?/^[a-z]+$/.test(a[1])?"lower-alpha":/^[A-Z]+$/.test(a[1])?"upper-alpha":"decimal":"decimal",b="ol"):(a=/[l\u00B7\u2002]/.test(a[1])?"disc":/[\u006F\u00D8]/.test(a[1])?"circle":/[\u006E\u25C6]/.test(a[1])?"square":"disc",b="ul"):(a="decimal",b="ol");c.attributes={"ke:listtype":b,style:"list-style-type:"+a+";"};c.add(new j.HtmlParser.Text(p));return c}function b(a){var p=a.attributes,b;return(b=a.removeAnyChildWithName("ke:listbullet"))&&
b.length&&(b=b[0])?(a.name="ke:li",p.style&&(p.style=d([["text-indent"],["line-height"],[/^margin(:?-left)?$/,null,function(a){a=a.split(" ");a=a[3]||a[1]||a[0];a=parseInt(a,10);!e&&h&&a>h&&(e=a-h);p["ke:margin"]=h=a}]],n)(p.style,a)||""),b=b.attributes,a.addStyle(b.style),l.mix(p,b),!0):!1}function d(a,b){return function(c,d){var f=[];(""+c).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(c,e,s){e=e.toLowerCase();"font-family"==e&&(s=s.replace(/["']/g,""));for(var m,
g,j,i=0;i<a.length;i++)if(a[i]&&(c=a[i][0],m=a[i][1],g=a[i][2],j=a[i][3],e.match(c)&&(!m||s.match(m)))){e=j||e;b&&(g=g||s);"function"==typeof g&&(g=g(s,d,e));g&&g.push&&(e=g[0],g=g[1]);"string"==typeof g&&f.push([e,g]);return}!b&&f.push([e,s])});for(var e=0;e<f.length;e++)f[e]=f[e].join(":");return f.length?f.join(";")+";":!1}}function i(a){for(var a=a.children,b,c,g,f,m,h,q,k=0;k<a.length;k++)if(b=a[k],"ke:li"==b.name){b.name="li";c=b.attributes;g=b.attributes["ke:listtype"];f=parseInt(c["ke:indent"],
10)||e&&Math.ceil(c["ke:margin"]/e)||1;c.style&&(c.style=d([["list-style-type","ol"==g?"decimal":"disc"]],n)(c.style)||"");if(h){if(f>q)h=new j.HtmlParser.Element(g),h.add(b),m.add(h);else{if(f<q){m=q-f;for(var l;m--&&(l=h.parent);)h=l.parent}h.add(b)}a.splice(k--,1)}else h=new j.HtmlParser.Element(g),h.add(b),a[k]=h;m=b;q=f}else h=null;e=0}var g=d([[/mso/i],[/w:WordDocument/i],[/^-ms/i],[/^-moz/i],[/^-webkit/i]],n),e,h=0,k=y.parentOf("ol"),z={elementNames:[[/^script$/i,""],[/^bgsound/i,""],[/^iframe$/i,
""],[/^style$/i,""],[/^link$/i,""],[/^meta$/i,""],[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],root:function(a){a.filterChildren();i(a)},elements:{p:function(a){a.filterChildren();if(b(a))return n},$:function(a){var b=a.name||"";if(-1!=b.indexOf(":")&&!/^ke/.test(b)){if("v:imagedata"==b){a.attributes["o:href"]&&(a.attributes.src=a.attributes["o:href"],delete a.attributes["o:href"]);if(b=a.attributes["o:title"])a.attributes.title=b,delete a.attributes["o:title"];a.name="img";return}delete a.name}b in
k&&(a.filterChildren(),i(a))},span:function(a){if(!o.gecko&&c(a.parent))return!1;if(!o.gecko&&c(a)){var b=(a=(a=a.firstChild(function(a){return a.value||"img"==a.name}))&&(a.value||"l."))&&a.match(/^([^\s]+?)([.)]?)$/);if(b)return f(b,a)}}},attributes:{"class":function(a){return!a||/(^|\s+)Mso/.test(a)?!1:a},style:function(a){a=g(a);return!a?!1:a}},attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]]},m={comment:!o.ie?function(a,b){var c=a.match(/<img.*?>/),d=a.match(/^\[if !supportLists\]([\s\S]*?)\[endif\]$/);
return d?(d=(c=d[1]||c&&"l.")&&c.match(/>([^\s]+?)([.)]?)</),f(d,c)):o.gecko&&c?(c=j.HtmlParser.Fragment.FromHtml(c[0]).children[0],(d=(d=(d=b.previous)&&d.value.match(/<v:imagedata[^>]*o:href=['"](.*?)['"]/))&&d[1])&&(c.attributes.src=d),c):!1}:function(){return!1}},q={elementNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],elements:{$:function(a){var b=a.attributes;if(b)for(var c=["name","href","src"],d,e=0;e<c.length;e++)d="_ke_saved_"+c[e],d in b&&delete b[c[e]];return a},embed:function(a){var b=
a.parent;if(b&&"object"==b.name){var c=b.attributes.width,b=b.attributes.height;c&&(a.attributes.width=c);b&&(a.attributes.height=b)}},param:function(a){a.children=[];a.isEmpty=!0;return a},a:function(a){if(!a.children.length&&l.isEmptyObject(a.attributes))return!1},span:function(a){if(!a.children.length&&l.isEmptyObject(a.attributes))return!1}},attributes:{style:function(a){if(!l.trim(a))return!1}},attributeNames:[[/^_ke_saved_/,""],[/^ke_on/,"on"],[/^_ke.*/,""],[/^_ks.*/,""],[/^ke:.*$/,""]],comment:function(a){return a.substr(0,
t.length)==t?(a="{C}"==a.substr(t.length,3)?a.substr(t.length+3):a.substr(t.length),new j.HtmlParser.cdata(decodeURIComponent(a))):a}};o.ie&&(q.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})});r.addRules(q);v.addRules(z);w.addRules(z);w.addRules(m)})();(function(){function c(b){for(var c=b.children.length,a=b.children[c-1];a&&a.type==u.NODE_TEXT&&!l.trim(a.value);)a=b.children[--c];return a}function f(b){var d=c(b);return!d||d.type==u.NODE_ELEMENT&&
"br"==d.name||"form"==b.name&&"input"==d.name}function b(b,d){var a=b.children,e=c(b);e&&((d||!o.ie)&&e.type==u.NODE_ELEMENT&&"br"==e.name&&a.pop(),e.type==u.NODE_TEXT&&g.test(e.value)&&a.pop())}function d(c){b(c,!0);f(c)&&(o.ie?c.add(new j.HtmlParser.Text("\u00a0")):(c.add(new j.HtmlParser.Text("&nbsp;")),c.add(new j.HtmlParser.Element("br",{}))))}function i(c){b(c,!1);f(c)&&c.add(new j.HtmlParser.Text("\u00a0"))}var g=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,e=j.XHTML_DTD,h=j.Utils.mix({},e.$block,e.$listItem,e.$tableContent),
k;for(k in h)h.hasOwnProperty(k)&&("br"in e[k]||delete h[k]);delete h.td;delete h.pre;var e={elements:{}},n={elements:{}};for(k in h)h.hasOwnProperty(k)&&(e.elements[k]=d,n.elements[k]=i);v.addRules(e);r.addRules(n);w.addRules(e)})();(function(){r.addRules({text:function(c){return c.replace(/\xa0/g,"&nbsp;")}})})();var B=/<(a|area|img|input)\b([^>]*)>/gi,C=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,t="{ke_protected}";x.htmlDataProcessor={wordFilter:w,dataFilter:v,htmlFilter:r,
toHtml:function(c,f){var b=new i.HtmlWriter;i.Fragment.FromHtml(c,f).writeHtml(b,r);return b.getHtml(!0)},toDataFormat:function(c,f,b){b=b||v;o.gecko&&(c=c.replace(/(<\!--\[if[^<]*?\])--\>([\S\s]*?)<\!--(\[endif\]--\>)/gi,"$1$2$3"));var c=A(c),d=new D("<div>");d.html("a"+c);c=d.html().substr(1);d=new i.BasicWriter;c=i.Fragment.FromHtml(c,f);d.reset();c.writeHtml(d,b);return c=d.getHtml(!0)},toServer:function(c,f){var b=new i.BasicWriter;i.Fragment.FromHtml(c,f).writeHtml(b,r);return b.getHtml(!0)}}}},
{attach:!1});
