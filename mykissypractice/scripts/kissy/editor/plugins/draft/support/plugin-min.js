KISSY.Editor.add("draft/support",function(){function m(a,b,c){for(a+="";a.length<b;)a=c+a;return a}function o(a){if(i.isNumber(a))a=new Date(a);return a instanceof Date?[a.getFullYear(),"-",m(a.getMonth()+1,2,"0"),"-",m(a.getDate(),2,"0")," ",m(a.getHours(),2,"0"),":",m(a.getMinutes(),2,"0"),":",m(a.getSeconds(),2,"0")].join(""):a}function p(a){this.editor=a;this._init()}var i=KISSY,h=i.Editor,l=i.Node,n=i.Event,q=i.JSON,j=h.Utils.addRes,s=h.Utils.destroyRes;i.augment(p,{_getSaveKey:function(){var a=
this.editor.cfg.pluginConfig;return a.draft&&a.draft.saveKey||"ke-draft-save20110503"},_getDrafts:function(){var a=h.localStorage;if(!this.drafts){var b=a.getItem(this._getSaveKey()),c=[];if(b)c=a==window.localStorage?q.parse(decodeURIComponent(b)):b;this.drafts=c}return this.drafts},_init:function(){var a=this,b=a.editor,c=b.statusDiv,d=b.cfg.pluginConfig;d.draft=d.draft||{};a.draftInterval=d.draft.interval=d.draft.interval||5;a.draftLimit=d.draft.limit=d.draft.limit||5;c=(new l("<div class='ke-draft'><span class='ke-draft-title'>\u5185\u5bb9\u6b63\u6587\u6bcf"+
d.draft.interval+"\u5206\u949f\u81ea\u52a8\u4fdd\u5b58\u4e00\u6b21\u3002</span></div>")).appendTo(c);a.timeTip=(new l("<span class='ke-draft-time'/>")).appendTo(c);var e=(new l("<a href='#' onclick='return false;' class='ke-button ke-draft-save-btn' style='vertical-align:middle;padding:1px 9px;'><span class='ke-draft-mansave'></span><span>\u7acb\u5373\u4fdd\u5b58</span></a>")).appendTo(c),f=new h.Select({container:c,menuContainer:document.body,doc:b.document,width:"85px",popUpWidth:"225px",align:["r","t"],emptyText:"&nbsp;&nbsp;&nbsp;\u5c1a\u65e0\u7f16\u8f91\u5668\u5386\u53f2\u5b58\u5728",title:"\u6062\u590d\u7f16\u8f91\u5386\u53f2"});
a.versions=f;f.on("select",function(){f.detach("select",arguments.callee);a.sync()});e._4e_unselectable();e.on("click",function(k){a.save(false);k.halt()});j.call(a,e);b.textarea[0].form&&function(){function k(){a.save(true)}var r=b.textarea[0].form;n.on(r,"submit",k);j.call(a,function(){n.remove(r,"submit",k)})}();var g=setInterval(function(){a.save(true)},a.draftInterval*60*1E3);j.call(a,function(){clearInterval(g)});f.on("click",a.recover,a);j.call(a,f);a.holder=c;if(d.draft.helpHtml){d=new h.TripleButton({elCls:"ke-draft-help",
title:"\u70b9\u51fb\u67e5\u770b\u5e2e\u52a9",text:"\u70b9\u51fb\u67e5\u770b\u5e2e\u52a9",render:c});d.render();d.on("click",function(k){a._help&&a._help.get("visible")?a._help.hide():a._prepareHelp();k&&k.halt()});j.call(a,d);h.Utils.lazyRun(a,"_prepareHelp","_realHelp");a.helpBtn=d.get("el")}j.call(a,c)},_prepareHelp:function(){function a(g){g&&g.halt();g=new l(g.target);g[0]==d[0]||d.contains(g)||b._help.hide()}var b=this,c=b.editor,d=b.helpBtn,e=new l(c.cfg.pluginConfig.draft.helpHtml||""),f=new l("<div style='height:0;position:absolute;font-size:0;width:0;border:8px #000 solid;border-color:#000 transparent transparent transparent;border-style:solid dashed dashed dashed;border-top-color:#CED5E0;'><div style='height:0;position:absolute;font-size:0;width:0;border:8px #000 solid;border-color:#000 transparent transparent transparent;border-style:solid dashed dashed dashed;left:-8px;top:-10px;border-top-color:white;'></div></div>");
e.append(f);e.css({border:"1px solid #ACB4BE","text-align":"left"});b._help=new (i.require("overlay"))({content:e,autoRender:true,width:e.width()+"px",mask:false});b._help.get("el").css("border","none");b._help.arrow=f;n.on([document,c.document],"click",a);j.call(b,b._help,function(){n.remove([document,c.document],"click",a)})},_realHelp:function(){var a=this._help,b=this.helpBtn,c=a.arrow;a.show();b=b.offset();a.get("el").offset({left:b.left-a.get("el").width()+17,top:b.top-a.get("el").height()-
7});c.offset({left:b.left-2,top:b.top-8})},disable:function(){this.holder.css("visibility","hidden")},enable:function(){this.holder.css("visibility","")},sync:function(){var a=h.localStorage,b=this.draftLimit,c=this.timeTip,d=this.versions,e=this._getDrafts();e.length>b&&e.splice(0,e.length-b);b=[];for(var f,g=0;g<e.length;g++){f=e[g];f=(f.auto?"\u81ea\u52a8":"\u624b\u52a8")+"\u4fdd\u5b58\u4e8e : "+o(f.date);b.push({name:f,value:g})}d.set("items",b.reverse());c.html(f);a.setItem(this._getSaveKey(),a==window.localStorage?encodeURIComponent(q.stringify(e)):
e)},save:function(a){var b=this._getDrafts(),c=this.editor.getData(true);if(c){if(b[b.length-1]&&c==b[b.length-1].content)b.length-=1;this.drafts=b.concat({content:c,date:(new Date).getTime(),auto:a});this.sync()}},recover:function(a){var b=this.editor,c=this.versions,d=this._getDrafts(),e=a.newVal;c.reset("value");if(confirm("\u786e\u8ba4\u6062\u590d "+o(d[e].date)+" \u7684\u7f16\u8f91\u5386\u53f2\uff1f")){b.fire("save");b.setData(d[e].content);b.fire("save")}a&&a.halt()},destroy:function(){s.call(this)}});h.Draft=p},{attach:false,requires:["localstorage"]});
